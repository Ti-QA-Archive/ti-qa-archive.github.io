<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>Background Service and Alarm Manager » Community Questions &amp; Answers » Appcelerator Developer Center</title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>Background Service and Alarm Manager</h1>
		</header>
		<section>
			<p>Hi, </p>
<p>I need a Background Service in Android. This Service read a url and then creates a notification depending on the response. When app is in foreground runs ok, but when app is in background not run.<br>I read the &quot;Q &amp; A&quot; of Titanium and then I try to use bencoding.AlarmManager module. But the problem is the same. The app run some minutes in background and then stop.</p>
<p>Any suggestions will be appreciated.</p>
<p>My code is:</p>
<p>index.js:</p>
<pre><code class="hljs">//<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>
// SERVICIOS BACKGROUND

var SECONDS = 30; // every 30 seconds
var lointento = Titanium.Android.createServiceIntent({
  url: 'MiBackground.js'
});
lointento.putExtra('interval', SECONDS <span class="hljs-keyword">*</span> 1000); // Needs to be milliseconds 

if (!Ti.Android.isServiceRunning(lointento)) {
    Ti.Android.startService(lointento); 
    Ti.API.info('Service lo intento <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>.');
} 
else {
    Ti.API.info('Service is already running.<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>');
}
Ti.API.info('BACKGROUND termino lo intento <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>.' + Ti.Android.isServiceRunning(lointento));

// FIN SERVICIOS BACKGROUND
//<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>

var alarmManager = require('bencoding.alarmmanager').createAlarmManager();

var Now = new Date();

alarmManager.addAlarmService({
    //The full name for the service to be called. Find this in your AndroidManifest.xml Titanium creates
    service:'com.miapp.thermostatmulti.MiBackground',    
    interval: 10000, //You can use the words hourly,daily,weekly,monthly,yearly or you can provide milliseconds.
    second: Now.getSeconds()
});
</code></pre><p>Tiapp.xml:</p>
<pre><code class="hljs">       <span class="hljs-tag">&lt;<span class="hljs-title">manifest</span> <span class="hljs-attribute">android:versionCode</span>=<span class="hljs-value">"2"</span>
                <span class="hljs-attribute">android:versionName</span>=<span class="hljs-value">"1.01"</span>&gt;</span>&gt;
        <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.WAKE_LOCK"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">application</span>
                <span class="hljs-attribute">android:debuggable</span>=<span class="hljs-value">"false"</span>
                <span class="hljs-attribute">android:icon</span>=<span class="hljs-value">"@drawable/appicon"</span>
                <span class="hljs-attribute">android:label</span>=<span class="hljs-value">"Thermostat Multi"</span>
                <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"ThermostatMultiApplication"</span> <span class="hljs-attribute">android:theme</span>=<span class="hljs-value">"@style/Theme.NoActionBar"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">activity</span>
                    <span class="hljs-attribute">android:configChanges</span>=<span class="hljs-value">"keyboardHidden|orientation|screenSize"</span>
                    <span class="hljs-attribute">android:label</span>=<span class="hljs-value">"@string/app_name"</span>
                    <span class="hljs-attribute">android:name</span>=<span class="hljs-value">".ThermostatMultiActivity"</span>
                    <span class="hljs-attribute">android:screenOrientation</span>=<span class="hljs-value">"portrait"</span> <span class="hljs-attribute">android:theme</span>=<span class="hljs-value">"@style/Theme.Titanium"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">intent-filter</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">action</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.intent.action.MAIN"</span>/&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">category</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.intent.category.LAUNCHER"</span>/&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">intent-filter</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">activity</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">activity</span>
                    <span class="hljs-attribute">android:configChanges</span>=<span class="hljs-value">"keyboardHidden|orientation|screenSize"</span>
                    <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"org.appcelerator.titanium.TiActivity"</span> <span class="hljs-attribute">android:screenOrientation</span>=<span class="hljs-value">"portrait"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">activity</span>
                    <span class="hljs-attribute">android:configChanges</span>=<span class="hljs-value">"keyboardHidden|orientation|screenSize"</span>
                    <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"org.appcelerator.titanium.TiTranslucentActivity"</span>
                    <span class="hljs-attribute">android:screenOrientation</span>=<span class="hljs-value">"portrait"</span> <span class="hljs-attribute">android:theme</span>=<span class="hljs-value">"@style/Theme.AppCompat.Translucent"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">activity</span> <span class="hljs-attribute">android:configChanges</span>=<span class="hljs-value">"orientation|screenSize"</span>
                    <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"ti.modules.titanium.ui.android.TiPreferencesActivity"</span> <span class="hljs-attribute">android:screenOrientation</span>=<span class="hljs-value">"portrait"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">service</span> <span class="hljs-attribute">android:exported</span>=<span class="hljs-value">"false"</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"com.appcelerator.analytics.APSAnalyticsService"</span>/&gt;</span>

         <span class="hljs-tag">&lt;<span class="hljs-title">receiver</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"bencoding.alarmmanager.AlarmNotificationListener"</span>/&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-title">receiver</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"bencoding.alarmmanager.AlarmServiceListener"</span>/&gt;</span>

            <span class="hljs-tag">&lt;/<span class="hljs-title">application</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-title">manifest</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">services</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">service</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"interval"</span> <span class="hljs-attribute">url</span>=<span class="hljs-value">"MiBackground.js"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">services</span>&gt;</span>
</code></pre><p>MiBackground.js:</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> Recibido=<span class="hljs-string">""</span>;
<span class="hljs-keyword">var</span> ArrayRecibido=<span class="hljs-string">""</span>;
<span class="hljs-keyword">var</span> url = <span class="hljs-string">"http://www.miserver.com/thermic/"</span>;
<span class="hljs-keyword">var</span> clientelee = Ti.Network.createHTTPClient({
    <span class="hljs-comment">// function called when the response data is available</span>
    onload : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        Recibido=<span class="hljs-keyword">this</span>.responseText;
        ArrayRecibido=Recibido.split(<span class="hljs-string">"/"</span>);
        <span class="hljs-keyword">if</span> (ArrayRecibido[<span class="hljs-number">0</span>]==<span class="hljs-string">"NOSERIE"</span>){
            Ti.API.info(<span class="hljs-string">"****  no existe  ****"</span>);
        }
        <span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">if</span> (ArrayRecibido[<span class="hljs-number">3</span>]&gt;<span class="hljs-number">0</span>){
                <span class="hljs-keyword">var</span> NotiIntrusion = Titanium.Android.createNotification({
                    contentTitle: <span class="hljs-string">'MY HOME'</span>,
                    contentText : <span class="hljs-string">'INTRUSION: '</span> + NombreLeido,
                    contentIntent: Ti.Android.createPendingIntent({intent: Ti.Android.createIntent({})}),
                    icon: Ti.App.Android.R.drawable.ladron,
                    when: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
                });

                Ti.Android.NotificationManager.notify(<span class="hljs-number">1</span>, NotiIntrusion);
            }
        }
    },
    <span class="hljs-comment">// function called when an error occurs, including a timeout</span>
    onerror : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        Ti.API.debug(e.error);
    },
    timeout : <span class="hljs-number">5000</span>  <span class="hljs-comment">// in milliseconds</span>

});

<span class="hljs-keyword">var</span> TablaSerieTermostatos=[];
<span class="hljs-keyword">var</span> TablaPinTermostatos=[];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CargoTermostatos</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> db = Ti.Database.open(<span class="hljs-string">'MiBD'</span>);
    <span class="hljs-keyword">var</span> rows = db.execute(<span class="hljs-string">'SELECT * FROM Termostatos ORDER BY Termostatos.Nombre'</span>);

    NRegistros=ComprueboRegBD();

    <span class="hljs-keyword">var</span> RowsTabla=[];
    <span class="hljs-keyword">var</span> i;
    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;NRegistros;i++){
        TablaSerieTermostatos[i]=rows.field(<span class="hljs-number">0</span>);
        TablaPinTermostatos[i]= rows.field(<span class="hljs-number">1</span>);
        TablaNombreTermostatos[i]= rows.field(<span class="hljs-number">2</span>);
    }

    db.close();
}

CargoTermostatos();

<span class="hljs-keyword">var</span> NombreLeido;
<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;NRegistros;i++){
    TablaSerieTermostatos[i]=rows.field(<span class="hljs-number">0</span>);
    TablaPinTermostatos[i]= rows.field(<span class="hljs-number">1</span>);
    url = <span class="hljs-string">"http://www.miserver.com/thermic/read/"</span>+TablaSerieTermostatos[i]+<span class="hljs-string">"/?pin="</span>+TablaPinTermostatos[i];
    <span class="hljs-comment">// Prepare the connection.</span>
     clientelee.open(<span class="hljs-string">"GET"</span>, url);
     <span class="hljs-comment">// Send the request.</span>
     clientelee.send();    

}
</code></pre>
		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="March 10th 2015, 9:41:50 am">March 10th 2015</span>
				by <span class='authorname'>Carlos Garcia</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>alarm manager</span></li>
					
						<li><span class='tagname'>android</span></li>
					
						<li><span class='tagname'>background</span></li>
					
						<li><span class='tagname'>service</span></li>
					
				</ul>
			

			<section>
				<h5>0 Comments</h5>
				
			</section>
		</footer>
		<aside class="vote-box">
			<div class="score"><span>0</span> Votes</div>
			<div class="answers"><span>1</span> Answer</div>
		</aside>
	</div>

	<hr>

	<h3>1 Answer</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article id="answer-286423">
				
						<section>
							<p>Please look to the <a href="https:&#x2F;&#x2F;github.com&#x2F;benbahrenburg&#x2F;benCoding.AlarmManager">awesome module of Ben Bahrenburg</a></p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="March 11th 2015, 6:16:01 am">March 11th 2015</span>
								by <span class='authorname'>Rainer Schleevoigt</span><br>
								<a class="icon-bg icon-link" href="question/181333/background-service-and-alarm-manager#answer-286423" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
