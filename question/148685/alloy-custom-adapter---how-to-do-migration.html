<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>Alloy: custom adapter - how to do migration? » Community Questions &amp; Answers </title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>Alloy: custom adapter - how to do migration?</h1>
		</header>
		<section>
			<p>Hi all,</p>
<p>ive done some open source adapters for alloy <a href="http:&#x2F;&#x2F;github.com&#x2F;viezel">github</a> but I cannot get the migration script working on custom adapters.</p>
<p>One of them is <a href="https:&#x2F;&#x2F;github.com&#x2F;viezel&#x2F;napp.alloy.adapter.restsql&#x2F;blob&#x2F;master&#x2F;sqlrest.js">sqlrest</a>, a dual adapter for rest and sql. I need migration to work here, just like in builtin sql adapter. I took Tonys migration code.</p>
<p>I cannot get it to work. Whats wrong?</p>
<p>Cheers, Mads</p>

		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="February 22nd 2013, 8:25:52 pm">February 22nd 2013</span>
				by <span class='authorname'>Mads Møller</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>adapter</span></li>
					
						<li><span class='tagname'>alloy</span></li>
					
						<li><span class='tagname'>migration</span></li>
					
						<li><span class='tagname'>sqlite</span></li>
					
				</ul>
			

			<section>
				<h5>3 Comments</h5>
				
					<ul class="comments">
					
						<li class="comment">
							<div><p>What exactly isn&#39;t working? Also, a test case would make it easier to troubleshoot.</p>
</div>
							<div class="author">
								&mdash; commented <span title="February 22nd 2013, 8:34:49 pm">February 22nd 2013</span>
								by <span class='authorname'>Tony Lukasavage</span>
							</div>
						</li>
					
						<li class="comment">
							<div><ol>
<li><p>The command: &quot;Alloy create model sqlrest id…..&quot;. does not work for custom adapters. </p>
</li>
<li><p>so I create a new file in the migrations folder and name the datestamp newer. </p>
</li>
<li><p>i add columns to the config, and run the app. </p>
</li>
</ol>
<p><a href="https:&#x2F;&#x2F;gist.github.com&#x2F;viezel&#x2F;5017216">migration code</a></p>
</div>
							<div class="author">
								&mdash; commented <span title="February 22nd 2013, 8:49:25 pm">February 22nd 2013</span>
								by <span class='authorname'>Mads Møller</span>
							</div>
						</li>
					
						<li class="comment">
							<div><p>I just get an sql error - it cannot figure out the new column. In this example its &quot;order&quot; column. </p>
<p>[ERROR] :  A SQLite database error occurred on database &#39;&#x2F;Users&#x2F;napp&#x2F;Library&#x2F;Application Support&#x2F;iPhone Simulator&#x2F;6.1&#x2F;Applications&#x2F;710F3942-50B9-40D8-9C26-5E9DD9EA8208&#x2F;Library&#x2F;Private Documents&#x2F;<em>alloy</em>.sql&#39;: Error Domain=com.plausiblelabs.pldatabase Code=3 &quot;An error occured parsing the provided SQL statement.&quot; UserInfo=0xa6700c0 {com.plausiblelabs.pldatabase.error.vendor.code=1, NSLocalizedDescription=An error occured parsing the provided SQL statement., com.plausiblelabs.pldatabase.error.query.string=CREATE TABLE IF NOT EXISTS module ( id INTEGER PRIMARY KEY AUTOINCREMENT,cid INTEGER,userid INTEGER,title TEXT,totalPages TEXT,pages TEXT,category TEXT,completed TEXT,order TEXT,modified TEXT), com.plausiblelabs.pldatabase.error.vendor.string=near &quot;order&quot;: syntax error} (SQLite #1: near &quot;order&quot;: syntax error) (query: &#39;CREATE TABLE IF NOT EXISTS module ( id INTEGER PRIMARY KEY AUTOINCREMENT,cid INTEGER,userid INTEGER,title TEXT,totalPages TEXT,pages TEXT,category TEXT,completed TEXT,order TEXT,modified TEXT)&#39;)</p>
<p>[ERROR] :  invalid SQL statement. Error Domain=com.plausiblelabs.pldatabase Code=3 &quot;An error occured parsing the provided SQL statement.&quot; UserInfo=0xa6700c0 {com.plausiblelabs.pldatabase.error.vendor.code=1, NSLocalizedDescription=An error occured parsing the provided SQL statement., com.plausiblelabs.pldatabase.error.query.string=CREATE TABLE IF NOT EXISTS module ( id INTEGER PRIMARY KEY AUTOINCREMENT,cid INTEGER,userid INTEGER,title TEXT,totalPages TEXT,pages TEXT,category TEXT,completed TEXT,order TEXT,modified TEXT), com.plausiblelabs.pldatabase.error.vendor.string=near &quot;order&quot;: syntax error}  in -[TiDatabaseProxy execute:] (TiDatabaseProxy.m:186)</p>
<p>[ERROR] :  Script Error = invalid SQL statement. Error Domain=com.plausiblelabs.pldatabase Code=3 &quot;An error occured parsing the provided SQL statement.&quot; UserInfo=0xa6700c0 {com.plausiblelabs.pldatabase.error.vendor.code=1, NSLocalizedDescription=An error occured parsing the provided SQL statement., com.plausiblelabs.pldatabase.error.query.string=CREATE TABLE IF NOT EXISTS module ( id INTEGER PRIMARY KEY AUTOINCREMENT,cid INTEGER,userid INTEGER,title TEXT,totalPages TEXT,pages TEXT,category TEXT,completed TEXT,order TEXT,modified TEXT), com.plausiblelabs.pldatabase.error.vendor.string=near &quot;order&quot;: syntax error}  in -[TiDatabaseProxy execute:] (TiDatabaseProxy.m:186) at sqlrest.js (line 54).</p>
<p>[ERROR] :  Script Error = Module &quot;alloy&#x2F;models&#x2F;Module&quot; failed to leave a valid exports object.</p>
</div>
							<div class="author">
								&mdash; commented <span title="February 22nd 2013, 9:03:45 pm">February 22nd 2013</span>
								by <span class='authorname'>Mads Møller</span>
							</div>
						</li>
					
					</ul>
				
			</section>
		</footer>
		<aside class="vote-box">
			<div class="score"><span>0</span> Votes</div>
			<div class="answers"><span>5</span> Answers</div>
		</aside>
	</div>

	<hr>

	<h3>5 Answers</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article id="answer-257404">
				
						<section>
							<p>You can&#39;t just create a table definition over another one, hence the &quot;IF NOT EXISTS&quot; part of the create clause. SQLite is extremely limited in what it can do in terms of altering an existing table: <a href="http:&#x2F;&#x2F;www.sqlite.org&#x2F;lang_altertable.html">http:&#x2F;&#x2F;www.sqlite.org&#x2F;lang_altertable.html</a></p>
<p>If you really want to drastically change the structure of a data table, you&#39;ll likely need to do some custom SQL, not just use the migrator functions. This section of the guides shows an example of how you can move your existing data to a temp table, delete the existing table, then create the new structure needed by your migration: <a href="http:&#x2F;&#x2F;docs.appcelerator.com&#x2F;titanium&#x2F;latest&#x2F;#!&#x2F;guide&#x2F;Alloy_Sync_Adapters_and_Migrations-section-36739597_AlloySyncAdaptersandMigrations-Migrations">http:&#x2F;&#x2F;docs.appcelerator.com&#x2F;titanium&#x2F;latest&#x2F;#!&#x2F;guide&#x2F;Alloy_Sync_Adapters_and_Migrations-section-36739597_AlloySyncAdaptersandMigrations-Migrations</a></p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 23rd 2013, 12:31:19 pm">February 23rd 2013</span>
								by <span class='authorname'>Tony Lukasavage</span><br>
								<a class="icon-bg icon-link" href="question/148685/alloy-custom-adapter---how-to-do-migration.html#answer-257404" rel="permalink">permalink</a>
							</div>

							<h5>3 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Cheers, Tony! </p>
<p>oh, maybe I missed the entire point of your implementation then. I though that it was exactly what the migration is for. I just added more columns, which is a normal use case. </p>
<p>I would then like to suggest something like this: <a href="https:&#x2F;&#x2F;gist.github.com&#x2F;viezel&#x2F;5020004">https:&#x2F;&#x2F;gist.github.com&#x2F;viezel&#x2F;5020004</a><br>its our old migration tool for our homemade sql in vanilla Titanium. Could that be something for your sql adapter then? </p>
<p>Or am I missing what alloy migrations is for?</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 23rd 2013, 12:43:54 pm">February 23rd 2013</span>
											by <span class='authorname'>Mads Møller</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>or would you rather have a use case like this using: </p>
<pre><code class="hljs">migration.up = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(migrator)</span></span> {
    migrator.db.execute(<span class="hljs-string">'ALTER TABLE '</span> + migrator.<span class="hljs-built_in">table</span> + <span class="hljs-string">' ADD COLUMN isbn INT;'</span>);
};
</code></pre></p>
										<div class="author">
											&mdash; commented <span title="February 23rd 2013, 12:49:00 pm">February 23rd 2013</span>
											by <span class='authorname'>Mads Møller</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Changing table structure and contents is what migrations are for, that&#39;s just not what the createTable() function is particularly suited for. It won&#39;t pull apart your create statement and do a bunch of ALTERs for you. You need to execute the ALTERs yourself in order to change the table the way you want it. That last comment looks to be the way you should do it when adding new columns to a SQLite table. A few things to note from the SQLite ALTER docs:</p>
<p><em>The ADD COLUMN syntax is used to add a new column to an existing table. The new column is always appended to the end of the list of existing columns. The column-def rule defines the characteristics of the new column. The new column may take any of the forms permissible in a CREATE TABLE statement, with the following restrictions:</em></p>
<ul>
<li><em>The column may not have a PRIMARY KEY or UNIQUE constraint.</em></li>
<li>_The column may not have a default value of CURRENT_TIME, CURRENT_DATE, CURRENT<em>TIMESTAMP, or an expression in parentheses.</em></li>
<li><em>If a NOT NULL constraint is specified, then the column must have a default value other than NULL.</em></li>
<li><em>If foreign key constraints are enabled and a column with a REFERENCES clause is added, the column must have a default value of NULL.</em></li>
</ul>
</p>
										<div class="author">
											&mdash; commented <span title="February 23rd 2013, 1:23:48 pm">February 23rd 2013</span>
											by <span class='authorname'>Tony Lukasavage</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>1</span> Vote</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-257388">
				
						<section>
							<p>Could it be that &quot;order&quot; is a keyword in SQLite? Try using a different name for that field.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 22nd 2013, 9:16:30 pm">February 22nd 2013</span>
								by <span class='authorname'>Tony Lukasavage</span><br>
								<a class="icon-bg icon-link" href="question/148685/alloy-custom-adapter---how-to-do-migration.html#answer-257388" rel="permalink">permalink</a>
							</div>

							<h5>1 Comment</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>yeah sorry. I posted the wrong example error. This is because of order. </p>
<p>ill post another one, when im back at the office tomorrow…</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 22nd 2013, 9:50:15 pm">February 22nd 2013</span>
											by <span class='authorname'>Mads Møller</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-257401">
				
						<section>
							<p>Here you go:</p>
<p>I updated the gist with the debug code: <a href="https:&#x2F;&#x2F;gist.github.com&#x2F;viezel&#x2F;5017216">https:&#x2F;&#x2F;gist.github.com&#x2F;viezel&#x2F;5017216</a> </p>
<p>[ERROR] :  MIGRATOR START</p>
<p>[ERROR] :  Migrate :: upgrade</p>
<p>[ERROR] :  Migrate :: migrating…</p>
<p>[ERROR] :  Migrate :: migrating…</p>
<p>[ERROR] :  MIGRATOR createTable CREATE TABLE IF NOT EXISTS course ( id INTEGER PRIMARY KEY AUTOINCREMENT,userid INTEGER,title TEXT,description TEXT,image TEXT,thumb TEXT,modules TEXT,completedModules TEXT,totalModules TEXT,totalModules2 TEXT,totalModules3 TEXT,price TEXT,author TEXT,courselevel TEXT,modified TEXT)</p>
<p>[ERROR] :  Migrate :: migrating…</p>
<p>[ERROR] :  MIGRATOR createTable CREATE TABLE IF NOT EXISTS course ( id INTEGER PRIMARY KEY AUTOINCREMENT,userid INTEGER,title TEXT,description TEXT,image TEXT,thumb TEXT,modules TEXT,completedModules TEXT,totalModules TEXT,totalModules2 TEXT,totalModules3 TEXT,totalModules4 TEXT,totalModules5 TEXT,price TEXT,author TEXT,courselevel TEXT,modified TEXT)</p>
<p>[ERROR] :  Migrate :: finished</p>
<p>So its actually picking up that I have migrations, and its correctly creating the sql statements, but nothing happens to my database. It maintain the original columns. </p>
<p>What am I missing here?</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 23rd 2013, 9:53:22 am">February 23rd 2013</span>
								by <span class='authorname'>Mads Møller</span><br>
								<a class="icon-bg icon-link" href="question/148685/alloy-custom-adapter---how-to-do-migration.html#answer-257401" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-257434">
				
						<section>
							<p>I took a closer look at your adapter since I find it very interresting and I&#39;m thinking about adding an offline caching scheme so that changes will be sent later (on fetch) when the server comes online.</p>
<p>There are a few things however that I do not understand about your implementation.</p>
<p>1) why are keys cast to a Number in the calls to _.indexof? this excludes strings as keys.</p>
<p>2) the calls to sqlCurrentModels seem very expensive and unnecessary. why not use sqlFindItem instead?</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 24th 2013, 8:42:11 am">February 24th 2013</span>
								by <span class='authorname'>Erik Andersen</span><br>
								<a class="icon-bg icon-link" href="question/148685/alloy-custom-adapter---how-to-do-migration.html#answer-257434" rel="permalink">permalink</a>
							</div>

							<h5>1 Comment</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Hi Erik,</p>
<p>I wanted to do the offline&#x2F;online sync for a while. Its on my todo list for this adapter. Just like conflict handling.<br>But you should be most welcome to contribute.</p>
<p>1) because id is an int, so I cast to a number. That might be something I should change.</p>
<p>2) Because sqlCurrentModels is one query to the database, returning all model ids. Imagine a 300 models large collection, if I use sqlFindItem, that would be 300 queries to the database. Therefore I just ran through an array of ids instead.</p>
<p>Im very interested in your feedback. This: <a href="https:&#x2F;&#x2F;github.com&#x2F;viezel&#x2F;napp.alloy.adapter.restsql&#x2F;issues">https:&#x2F;&#x2F;github.com&#x2F;viezel&#x2F;napp.alloy.adapter.restsql&#x2F;issues</a> might be a better place to discuss the adapter. </p>
<p>Cheers,<br>Mads</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 24th 2013, 4:58:59 pm">February 24th 2013</span>
											by <span class='authorname'>Mads Møller</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-270053">
				
						<section>
							<p>Check this Alloy Migration Tutorial <a href="http:&#x2F;&#x2F;bit.ly&#x2F;AlloyMigration">AlloyMigrationExample</a></p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="October 16th 2013, 10:20:22 am">October 16th 2013</span>
								by <span class='authorname'>Prakash M</span><br>
								<a class="icon-bg icon-link" href="question/148685/alloy-custom-adapter---how-to-do-migration.html#answer-270053" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
