<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>Problem with Java Jre and Jdk won&#39;t work now - Error Loading - same worng bit version! » Community Questions &amp; Answers » Appcelerator Developer Center</title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>Problem with Java Jre and Jdk won&#39;t work now - Error Loading - same worng bit version!</h1>
		</header>
		<section>
			<p>Hello i have big problem with jre and jdk. I have been installed - But Titanium Studio won&#39;t compile with Android.. I have been tried.<br>over tha  2 Hours :(</p>
<p><code>[ERROR] Error locating JDK: set $JAVA_HOME or put javac and jarsigner on your $PATH</code></p>
<p>Than i am trying with path<br>JAVA-HOME is Directory D:\Developers\Oracle\Java\jre and \jdk and \fx<br>How do i fix Java Home Installation`? Thanks</p>

		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="April 10th 2012, 11:43:03 am">April 10th 2012</span>
				by <span class='authorname'>Jens Eckervogt</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>android</span></li>
					
						<li><span class='tagname'>java</span></li>
					
				</ul>
			

			<section>
				<h5>0 Comments</h5>
				
			</section>
		</footer>
		<aside class="vote-box vote-box-answered">
			<div class="score"><span>0</span> Votes</div>
			<div class="answers"><span>7</span> Answers</div>
		</aside>
	</div>

	<hr>

	<h3>7 Answers</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article class="accepted-answer" id="answer-235705">
						<header>
							<h2><span class="icon-bg icon-check-1"></span>Accepted Answer</h2>
						</header>
				
						<section>
							<p>Hi Jens, can you tell me which software you installed in your machine?</p>
<p>It is little bit hard but not impossible, I spend my week to run this in my pc. finally I got running android in my PC.</p>
<p>Don&#39;t Worry about the errors, Let&#39;s try to solve them.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="April 11th 2012, 2:01:06 am">April 11th 2012</span>
								by <span class='authorname'>Gaurang Chhatbar</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-235705" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box vote-box-answered">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-235656">
				
						<section>
							<p>Hi Jens,</p>
<p><code>JAVA_HOME</code> is path to JAVA directory where it installed without \bin folder</p>
<p>for example </p>
<p><code>D:\Developers\Oracle\Java\jdk1.6.0</code></p>
<p>and the path for java is </p>
<p><code>D:\Developers\Oracle\Java\jdk1.6.0\bin</code></p>
<p>You have to set java path for JDK only not for JRE</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="April 10th 2012, 11:52:42 am">April 10th 2012</span>
								by <span class='authorname'>Gaurang Chhatbar</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-235656" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-235673">
				
						<section>
							<p>Thanks. But i have been found Error by builder.py :(</p>
<h2 id="how-do-i-set-up-for-currect-with-jdk-directory-and-executables-">How do i set up for currect with JDK Directory and Executables?</h2>
<p>#!&#x2F;usr&#x2F;bin&#x2F;env python</p>
<h1 id="-coding-utf-8-">-<em>- coding: utf-8 -</em>-</h1>
<p>#</p>
<h1 id="appcelerator-titanium-mobile">Appcelerator Titanium Mobile</h1>
<h1 id="copyright-c-2011-by-appcelerator-inc-all-rights-reserved-">Copyright (c) 2011 by Appcelerator, Inc. All Rights Reserved.</h1>
<h1 id="licensed-under-the-terms-of-the-apache-public-license">Licensed under the terms of the Apache Public License</h1>
<h1 id="please-see-the-license-included-with-this-distribution-for-details-">Please see the LICENSE included with this distribution for details.</h1>
<p>#</p>
<h1 id="general-builder-script-for-staging-packaging-deploying-">General builder script for staging, packaging, deploying,</h1>
<h1 id="and-debugging-titanium-mobile-applications-on-android">and debugging Titanium Mobile applications on Android</h1>
<p>#<br>import os, sys, subprocess, shutil, time, signal, string, platform, re, glob, hashlib, imp, inspect<br>import run, avd, prereq, zipfile, tempfile, fnmatch, codecs, traceback, simplejson<br>from mako.template import Template<br>from os.path import splitext<br>from compiler import Compiler<br>from os.path import join, splitext, split, exists<br>from shutil import copyfile<br>from xml.dom.minidom import parseString<br>from tilogger import *<br>from datetime import datetime, timedelta</p>
<p>template_dir = os.path.abspath(os.path.dirname(sys._getframe(0).f_code.co_filename))<br>top_support_dir = os.path.dirname(template_dir)<br>sys.path.append(top_support_dir)<br>sys.path.append(os.path.join(top_support_dir, &#39;common&#39;))<br>sys.path.append(os.path.join(top_support_dir, &#39;module&#39;))</p>
<p>from tiapp import *<br>from android import Android<br>from androidsdk import AndroidSDK<br>from deltafy import Deltafy, Delta<br>from css import csscompiler<br>from module import ModuleDetector<br>import localecompiler<br>import fastdev<br>import requireIndex</p>
<p>ignoreFiles = [&#39;.gitignore&#39;, &#39;.cvsignore&#39;, &#39;.DS_Store&#39;];<br>ignoreDirs = [&#39;.git&#39;,&#39;.svn&#39;,&#39;_svn&#39;, &#39;CVS&#39;];<br>android_avd_hw = {&#39;hw.camera&#39;: &#39;yes&#39;, &#39;hw.gps&#39;:&#39;yes&#39;}<br>res_skips = [&#39;style&#39;]<br>log = None</p>
<h1 id="copied-from-frameworks-x2f-base-x2f-tools-x2f-aapt-x2f-package-cpp">Copied from frameworks&#x2F;base&#x2F;tools&#x2F;aapt&#x2F;Package.cpp</h1>
<p>uncompressed_types = [<br>    &quot;.jpg&quot;, &quot;.jpeg&quot;, &quot;.png&quot;, &quot;.gif&quot;,<br>    &quot;.wav&quot;, &quot;.mp2&quot;, &quot;.mp3&quot;, &quot;.ogg&quot;, &quot;.aac&quot;,<br>    &quot;.mpg&quot;, &quot;.mpeg&quot;, &quot;.mid&quot;, &quot;.midi&quot;, &quot;.smf&quot;, &quot;.jet&quot;,<br>    &quot;.rtttl&quot;, &quot;.imy&quot;, &quot;.xmf&quot;, &quot;.mp4&quot;, &quot;.m4a&quot;,<br>    &quot;.m4v&quot;, &quot;.3gp&quot;, &quot;.3gpp&quot;, &quot;.3g2&quot;, &quot;.3gpp2&quot;,<br>    &quot;.amr&quot;, &quot;.awb&quot;, &quot;.wma&quot;, &quot;.wmv&quot;<br>]</p>
<h1 id="java-keywords-to-reference-in-case-app-id-contains-java-keyword">Java keywords to reference in case app id contains java keyword</h1>
<p>java_keywords = [<br>    &quot;abstract&quot;,    &quot;continue&quot;,    &quot;for&quot;, &quot;new&quot;, &quot;switch&quot;,<br>    &quot;assert&quot;, &quot;default&quot;, &quot;goto&quot;, &quot;package&quot;, &quot;synchronized&quot;,<br>    &quot;boolean&quot;, &quot;do&quot;, &quot;if&quot;, &quot;private&quot;, &quot;this&quot;,<br>    &quot;break&quot;, &quot;double&quot;, &quot;implements&quot;, &quot;protected&quot;, &quot;throw&quot;,<br>    &quot;byte&quot;, &quot;else&quot;, &quot;import&quot;, &quot;public&quot;, &quot;throws&quot;,<br>    &quot;case&quot;, &quot;enum&quot;, &quot;instanceof&quot;, &quot;return&quot;, &quot;transient&quot;,<br>    &quot;catch&quot;, &quot;extends&quot;, &quot;int&quot;, &quot;short&quot;, &quot;try&quot;,<br>    &quot;char&quot;, &quot;final&quot;, &quot;interface&quot;, &quot;static&quot;, &quot;void&quot;,<br>    &quot;class&quot;, &quot;finally&quot;, &quot;long&quot;,    &quot;strictfp&quot;, &quot;volatile&quot;,<br>    &quot;const&quot;, &quot;float&quot;, &quot;native&quot;,    &quot;super&quot;, &quot;while&quot;<br>]</p>
<p>MIN_API_LEVEL = 8</p>
<p>def render_template_with_tiapp(template_text, tiapp_obj):<br>    t = Template(template_text)<br>    return t.render(tiapp=tiapp_obj)</p>
<p>def remove_ignored_dirs(dirs):<br>    for d in dirs:<br>        if d in ignoreDirs:<br>            dirs.remove(d)</p>
<h1 id="zipfile-extractall-introduced-in-python-2-6-so-this-is-workaround-for-earlier">ZipFile.extractall introduced in Python 2.6, so this is workaround for earlier</h1>
<h1 id="versions">versions</h1>
<p>def zip_extractall(zfile, target_dir):<br>    file_infos = zfile.infolist()<br>    for info in file_infos:<br>        if info.file_size &gt; 0:<br>            file_path = os.path.join(target_dir, os.path.normpath(info.filename))<br>            parent_path = os.path.dirname(file_path)<br>            if not os.path.exists(parent_path):<br>                os.makedirs(parent_path)<br>            out_file = open(file_path, &quot;wb&quot;)<br>            out_file.write(zfile.read(info.filename))<br>            out_file.close()</p>
<p>def dequote(s):<br>    if s[0:1] == &#39;&quot;&#39;:<br>        return s[1:-1]<br>    return s</p>
<p>def pipe(args1,args2):<br>    p1 = subprocess.Popen(args1, stdout=subprocess.PIPE)<br>    p2 = subprocess.Popen(args2, stdin=p1.stdout, stdout=subprocess.PIPE)<br>    return p2.communicate()[0]</p>
<p>def read_properties(propFile, separator=&quot;:= &quot;):<br>    propDict = dict()<br>    for propLine in propFile:<br>        propDef = propLine.strip()<br>        if len(propDef) == 0:<br>            continue<br>        if propDef[0] in ( &#39;!&#39;, &#39;#&#39; ):<br>            continue<br>        punctuation= [ propDef.find(c) for c in separator ] + [ len(propDef) ]<br>        found= min( [ pos for pos in punctuation if pos != -1 ] )<br>        name= propDef[:found].rstrip()<br>        value= propDef[found:].lstrip(separator).rstrip()<br>        propDict[name]= value<br>    propFile.close()<br>    return propDict</p>
<p>def info(msg):<br>    log.info(msg)</p>
<p>def debug(msg):<br>    log.debug(msg)</p>
<p>def warn(msg):<br>    log.warn(msg)</p>
<p>def trace(msg):<br>    log.trace(msg)</p>
<p>def error(msg):<br>    log.error(msg)</p>
<p>def copy_all(source_folder, dest_folder, ignore_dirs=[], ignore_files=[], ignore_exts=[], one_time_msg=&quot;&quot;):<br>    msg_shown = False<br>    for root, dirs, files in os.walk(source_folder):<br>        for d in dirs:<br>            if d in ignore_dirs:<br>                dirs.remove(d)<br>        for f in files:<br>            if f in ignore_files:<br>                continue<br>            ext = os.path.splitext(f)[1]<br>            if ext in ignore_exts:<br>                continue<br>            if one_time_msg and not msg_shown:<br>                info(one_time_msg)<br>                msg<em>shown = True<br>            from</em> = os.path.join(root, f)<br>            to<em> = from</em>.replace(source_folder, dest_folder, 1)<br>            to<em>directory = os.path.split(to</em>)[0]<br>            if not os.path.exists(to_directory):<br>                os.makedirs(to<em>directory)<br>            shutil.copyfile(from</em>, to_)</p>
<p>def remove_orphaned_files(source_folder, target_folder):<br>    is_res = source_folder.endswith(&#39;Resources&#39;) or source_folder.endswith(&#39;Resources&#39; + os.sep)<br>    for root, dirs, files in os.walk(target_folder):<br>        for f in files:<br>            full = os.path.join(root, f)<br>            rel = full.replace(target_folder, &#39;&#39;)<br>            if rel[0] == os.sep:<br>                rel = rel[1:]<br>            is_orphan = False<br>            if not os.path.exists(os.path.join(source_folder, rel)):<br>                is_orphan = True</p>
<pre><code class="hljs">        <span class="hljs-comment"># But it could be under android/... too (platform-specific)</span>
        <span class="hljs-keyword">if</span> is_orphan <span class="hljs-keyword">and</span> is_res:
            <span class="hljs-keyword">if</span> os.path.<span class="hljs-keyword">exists</span>(os.path.<span class="hljs-keyword">join</span>(source_folder, <span class="hljs-string">'android'</span>, rel)):
                is_orphan = False

        <span class="hljs-keyword">if</span> is_orphan:
            os.remove(full)
</code></pre><p>def is_resource_drawable(path):<br>    if re.search(&quot;android&#x2F;images&#x2F;(high|medium|low|res-[^&#x2F;]+)&#x2F;&quot;, path.replace(os.sep, &quot;&#x2F;&quot;)):<br>        return True<br>    else:<br>        return False</p>
<p>def resource_drawable_folder(path):<br>    if not is_resource_drawable(path):<br>        return None<br>    else:<br>        pattern = r&#39;&#x2F;android&#x2F;images&#x2F;(high|medium|low|res-[^&#x2F;]+)&#x2F;&#39;<br>        match = re.search(pattern, path.replace(os.sep, &quot;&#x2F;&quot;))<br>        if not match.groups():<br>            return None<br>        folder = match.groups()[0]<br>        if re.match(&#39;high|medium|low&#39;, folder):<br>            return &#39;drawable-%sdpi&#39; % folder[0]<br>        else:<br>            return &#39;drawable-%s&#39; % folder.replace(&#39;res-&#39;, &#39;&#39;)</p>
<p>class Builder(object):</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, name, sdk, project_dir, support_dir, app_id)</span>:</span>
    self.top_dir = project_dir
    self.project_tiappxml = os.path.join(self.top_dir,<span class="hljs-string">'tiapp.xml'</span>)
    self.project_dir = os.path.join(project_dir,<span class="hljs-string">'build'</span>,<span class="hljs-string">'android'</span>)
    self.res_dir = os.path.join(self.project_dir,<span class="hljs-string">'res'</span>)
    self.platform_dir = os.path.join(project_dir, <span class="hljs-string">'platform'</span>, <span class="hljs-string">'android'</span>)
    self.project_src_dir = os.path.join(self.project_dir, <span class="hljs-string">'src'</span>)
    self.project_gen_dir = os.path.join(self.project_dir, <span class="hljs-string">'gen'</span>)
    self.name = name
    self.app_id = app_id
    self.support_dir = support_dir
    self.compiled_files = []
    self.force_rebuild = <span class="hljs-keyword">False</span>
    self.debugger_host = <span class="hljs-keyword">None</span>
    self.debugger_port = -<span class="hljs-number">1</span>
    self.fastdev_port = -<span class="hljs-number">1</span>
    self.fastdev = <span class="hljs-keyword">False</span>
    self.compile_js = <span class="hljs-keyword">False</span>

    <span class="hljs-comment"># don't build if a java keyword in the app id would cause the build to fail</span>
    tok = self.app_id.split(<span class="hljs-string">'.'</span>)
    <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> tok:
        <span class="hljs-keyword">if</span> token <span class="hljs-keyword">in</span> java_keywords:
            error(<span class="hljs-string">"Do not use java keywords for project app id, such as "</span> + token)
            sys.exit(<span class="hljs-number">1</span>)

    temp_tiapp = TiAppXML(self.project_tiappxml)
    <span class="hljs-keyword">if</span> temp_tiapp <span class="hljs-keyword">and</span> temp_tiapp.android <span class="hljs-keyword">and</span> <span class="hljs-string">'tool-api-level'</span> <span class="hljs-keyword">in</span> temp_tiapp.android:
        self.tool_api_level = int(temp_tiapp.android[<span class="hljs-string">'tool-api-level'</span>])
    <span class="hljs-keyword">else</span>:
        self.tool_api_level = MIN_API_LEVEL
    self.sdk = AndroidSDK(sdk, self.tool_api_level)
    self.tiappxml = temp_tiapp

    json_contents = open(os.path.join(template_dir,<span class="hljs-string">'dependency.json'</span>)).read()
    self.depends_map = simplejson.loads(json_contents)
    self.runtime = self.tiappxml.app_properties.get(<span class="hljs-string">'ti.android.runtime'</span>, self.depends_map[<span class="hljs-string">'runtimes'</span>][<span class="hljs-string">'defaultRuntime'</span>])

    self.set_java_commands()
    <span class="hljs-comment"># start in 1.4, you no longer need the build/android directory</span>
    <span class="hljs-comment"># if missing, we'll create it on the fly</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.project_dir) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> os.path.exists(os.path.join(self.project_dir,<span class="hljs-string">'AndroidManifest.xml'</span>)):
        android_creator = Android(name, app_id, self.sdk, <span class="hljs-keyword">None</span>, self.java)
        parent_dir = os.path.dirname(self.top_dir)
        <span class="hljs-keyword">if</span> os.path.exists(self.top_dir):
            android_creator.create(parent_dir, project_dir=self.top_dir, build_time=<span class="hljs-keyword">True</span>)
        <span class="hljs-keyword">else</span>:
            android_creator.create(parent_dir)

        self.force_rebuild = <span class="hljs-keyword">True</span>
        sys.stdout.flush()

    <span class="hljs-comment"># we place some files in the users home</span>
    <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
        self.home_dir = os.path.join(os.environ[<span class="hljs-string">'USERPROFILE'</span>], <span class="hljs-string">'.titanium'</span>)
        self.android_home_dir = os.path.join(os.environ[<span class="hljs-string">'USERPROFILE'</span>], <span class="hljs-string">'.android'</span>)
    <span class="hljs-keyword">else</span>:
        self.home_dir = os.path.join(os.path.expanduser(<span class="hljs-string">'~'</span>), <span class="hljs-string">'.titanium'</span>)
        self.android_home_dir = os.path.join(os.path.expanduser(<span class="hljs-string">'~'</span>), <span class="hljs-string">'.android'</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.home_dir):
        os.makedirs(self.home_dir)
    self.sdcard = os.path.join(self.home_dir,<span class="hljs-string">'android2.sdcard'</span>)
    self.classname = Android.strip_classname(self.name)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_java_commands</span><span class="hljs-params">(self)</span>:</span>
    self.jarsigner = <span class="hljs-string">"jarsigner"</span>
    self.javac = <span class="hljs-string">"javac"</span>
    self.java = <span class="hljs-string">"java"</span>
    <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
        <span class="hljs-keyword">if</span> os.environ.has_key(<span class="hljs-string">"JAVA_HOME"</span>):
            home_jarsigner = os.path.join(os.environ[<span class="hljs-string">"JAVA_HOME"</span>], <span class="hljs-string">"bin"</span>, <span class="hljs-string">"jarsigner.exe"</span>)
            home_javac = os.path.join(os.environ[<span class="hljs-string">"JAVA_HOME"</span>], <span class="hljs-string">"bin"</span>, <span class="hljs-string">"javac.exe"</span>)
            home_java = os.path.join(os.environ[<span class="hljs-string">"JAVA_HOME"</span>], <span class="hljs-string">"bin"</span>, <span class="hljs-string">"java.exe"</span>)
            found = <span class="hljs-keyword">True</span>
            <span class="hljs-comment"># TODO Document this path and test properly under windows</span>
            <span class="hljs-keyword">if</span> os.path.exists(home_jarsigner):
                self.jarsigner = home_jarsigner
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Expected but not found</span>
                found = <span class="hljs-keyword">False</span>
                error(<span class="hljs-string">"Required jarsigner not found"</span>)

            <span class="hljs-keyword">if</span> os.path.exists(home_javac):
                self.javac = home_javac
            <span class="hljs-keyword">else</span>:
                error(<span class="hljs-string">"Required javac not found"</span>)
                found = <span class="hljs-keyword">False</span>

            <span class="hljs-keyword">if</span> os.path.exists(home_java):
                self.java = home_java
            <span class="hljs-keyword">else</span>:
                error(<span class="hljs-string">"Required java not found"</span>)
                found = <span class="hljs-keyword">False</span>

            <span class="hljs-keyword">if</span> found == <span class="hljs-keyword">False</span>:
                error(<span class="hljs-string">"One or more required files not found - please check your JAVA_HOME environment variable"</span>)
                sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">else</span>:
            found = <span class="hljs-keyword">False</span>
            <span class="hljs-keyword">for</span> path <span class="hljs-keyword">in</span> os.environ[<span class="hljs-string">'PATH'</span>].split(os.pathsep):
                <span class="hljs-keyword">if</span> os.path.exists(os.path.join(path, <span class="hljs-string">'jarsigner.exe'</span>)) <span class="hljs-keyword">and</span> os.path.exists(os.path.join(path, <span class="hljs-string">'javac.exe'</span>)):
                    self.jarsigner = os.path.join(path, <span class="hljs-string">'jarsigner.exe'</span>)
                    self.javac = os.path.join(path, <span class="hljs-string">'javac.exe'</span>)
                    self.java = os.path.join(path, <span class="hljs-string">'java.exe'</span>)
                    found = <span class="hljs-keyword">True</span>
                    <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> found:
                error(<span class="hljs-string">"Error locating JDK: set $JAVA_HOME or put javac and jarsigner on your $PATH"</span>)
                sys.exit(<span class="hljs-number">1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wait_for_home</span><span class="hljs-params">(self, type)</span>:</span>
    max_wait = <span class="hljs-number">20</span>
    attempts = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        processes = self.sdk.list_processes([<span class="hljs-string">'-%s'</span> % type])
        found_home = <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">for</span> process <span class="hljs-keyword">in</span> processes:
            <span class="hljs-keyword">if</span> process[<span class="hljs-string">"name"</span>] == <span class="hljs-string">"android.process.acore"</span>:
                found_home = <span class="hljs-keyword">True</span>
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> found_home:
            <span class="hljs-keyword">break</span>
        attempts += <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> attempts == max_wait:
            error(<span class="hljs-string">"Timed out waiting for android.process.acore"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
        time.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wait_for_device</span><span class="hljs-params">(self, type)</span>:</span>
    debug(<span class="hljs-string">"Waiting for device to be ready ..."</span>)
    t = time.time()
    max_wait = <span class="hljs-number">30</span>
    max_zero = <span class="hljs-number">6</span>
    attempts = <span class="hljs-number">0</span>
    zero_attempts = <span class="hljs-number">0</span>
    timed_out = <span class="hljs-keyword">True</span>
    no_devices = <span class="hljs-keyword">False</span>

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        devices = self.sdk.list_devices()
        trace(<span class="hljs-string">"adb devices returned %s devices/emulators"</span> % len(devices))
        <span class="hljs-keyword">if</span> len(devices) &gt; <span class="hljs-number">0</span>:
            found = <span class="hljs-keyword">False</span>
            <span class="hljs-keyword">for</span> device <span class="hljs-keyword">in</span> devices:
                <span class="hljs-keyword">if</span> type == <span class="hljs-string">"e"</span> <span class="hljs-keyword">and</span> device.is_emulator() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> device.is_offline(): found = <span class="hljs-keyword">True</span>
                <span class="hljs-keyword">elif</span> type == <span class="hljs-string">"d"</span> <span class="hljs-keyword">and</span> device.is_device(): found = <span class="hljs-keyword">True</span>
            <span class="hljs-keyword">if</span> found:
                timed_out = <span class="hljs-keyword">False</span>
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">else</span>: zero_attempts += <span class="hljs-number">1</span>

        <span class="hljs-keyword">try</span>: time.sleep(<span class="hljs-number">5</span>) <span class="hljs-comment"># for some reason KeyboardInterrupts get caught here from time to time</span>
        <span class="hljs-keyword">except</span> KeyboardInterrupt: <span class="hljs-keyword">pass</span>
        attempts += <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> attempts == max_wait:
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">elif</span> zero_attempts == max_zero:
            no_devices = <span class="hljs-keyword">True</span>
            <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">if</span> timed_out:
        <span class="hljs-keyword">if</span> type == <span class="hljs-string">"e"</span>:
            device = <span class="hljs-string">"emulator"</span>
            extra_message = <span class="hljs-string">"you may need to close the emulator and try again"</span>
        <span class="hljs-keyword">else</span>:
            device = <span class="hljs-string">"device"</span>
            extra_message = <span class="hljs-string">"you may try reconnecting the USB cable"</span>
        error(<span class="hljs-string">"Timed out waiting for %s to be ready, %s"</span> % (device, extra_message))
        <span class="hljs-keyword">if</span> no_devices:
            sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

    debug(<span class="hljs-string">"Device connected... (waited %d seconds)"</span> % (attempts*<span class="hljs-number">5</span>))
    duration = time.time() - t
    debug(<span class="hljs-string">"waited %f seconds on emulator to get ready"</span> % duration)
    <span class="hljs-keyword">if</span> duration &gt; <span class="hljs-number">1.0</span>:
        info(<span class="hljs-string">"Waiting for the Android Emulator to become available"</span>)
        <span class="hljs-keyword">return</span> self.wait_for_home(type)
        <span class="hljs-comment">#time.sleep(20) # give it a little more time to get installed</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_avd</span><span class="hljs-params">(self,avd_id,avd_skin)</span>:</span>
    name = <span class="hljs-string">"titanium_%s_%s"</span> % (avd_id,avd_skin)
    name = name.replace(<span class="hljs-string">' '</span>, <span class="hljs-string">'_'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.home_dir):
        os.makedirs(self.home_dir)
    avd_path = os.path.join(self.android_home_dir, <span class="hljs-string">'avd'</span>)
    my_avd = os.path.join(avd_path,<span class="hljs-string">"%s.avd"</span> % name)
    own_sdcard = os.path.join(self.home_dir, <span class="hljs-string">'%s.sdcard'</span> % name)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(my_avd) <span class="hljs-keyword">or</span> os.path.exists(own_sdcard):
        <span class="hljs-comment"># starting with 1.7.2, when we create a new avd, give it its own</span>
        <span class="hljs-comment"># SDCard as well.</span>
        self.sdcard = own_sdcard
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.sdcard):
        info(<span class="hljs-string">"Creating 64M SD card for use in Android emulator"</span>)
        run.run([self.sdk.get_mksdcard(), <span class="hljs-string">'64M'</span>, self.sdcard])
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(my_avd):
        info(<span class="hljs-string">"Creating new Android Virtual Device (%s %s)"</span> % (avd_id,avd_skin))
        inputgen = os.path.join(template_dir,<span class="hljs-string">'input.py'</span>)
        pipe([sys.executable, inputgen], [self.sdk.get_android(), <span class="hljs-string">'--verbose'</span>, <span class="hljs-string">'create'</span>, <span class="hljs-string">'avd'</span>, <span class="hljs-string">'--name'</span>, name, <span class="hljs-string">'--target'</span>, avd_id, <span class="hljs-string">'-s'</span>, avd_skin, <span class="hljs-string">'--force'</span>, <span class="hljs-string">'--sdcard'</span>, self.sdcard])
        inifile = os.path.join(my_avd,<span class="hljs-string">'config.ini'</span>)
        inifilec = open(inifile,<span class="hljs-string">'r'</span>).read()
        inifiledata = open(inifile,<span class="hljs-string">'w'</span>)
        inifiledata.write(inifilec)
        <span class="hljs-comment"># TODO - Document options</span>
        <span class="hljs-keyword">for</span> hw_option <span class="hljs-keyword">in</span> android_avd_hw.keys():
            inifiledata.write(<span class="hljs-string">"%s=%s\n"</span> % (hw_option, android_avd_hw[hw_option]))
        inifiledata.close()

    <span class="hljs-keyword">return</span> name

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_emulator</span><span class="hljs-params">(self,avd_id,avd_skin)</span>:</span>
    info(<span class="hljs-string">"Launching Android emulator...one moment"</span>)
    debug(<span class="hljs-string">"From: "</span> + self.sdk.get_emulator())
    debug(<span class="hljs-string">"SDCard: "</span> + self.sdcard)
    debug(<span class="hljs-string">"AVD ID: "</span> + avd_id)
    debug(<span class="hljs-string">"AVD Skin: "</span> + avd_skin)
    debug(<span class="hljs-string">"SDK: "</span> + sdk_dir)

    <span class="hljs-comment"># make sure adb is running on windows, else XP can lockup the python</span>
    <span class="hljs-comment"># process when adb runs first time</span>
    <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
        run.run([self.sdk.get_adb(), <span class="hljs-string">"start-server"</span>], <span class="hljs-keyword">True</span>, ignore_output=<span class="hljs-keyword">True</span>)

    devices = self.sdk.list_devices()
    <span class="hljs-keyword">for</span> device <span class="hljs-keyword">in</span> devices:
        <span class="hljs-keyword">if</span> device.is_emulator() <span class="hljs-keyword">and</span> device.get_port() == <span class="hljs-number">5560</span>:
            info(<span class="hljs-string">"Emulator is running."</span>)
            sys.exit()

    <span class="hljs-comment"># this will create an AVD on demand or re-use existing one if already created</span>
    avd_name = self.create_avd(avd_id,avd_skin)

    <span class="hljs-comment"># start the emulator</span>
    emulator_cmd = [
        self.sdk.get_emulator(),
        <span class="hljs-string">'-avd'</span>,
        avd_name,
        <span class="hljs-string">'-port'</span>,
        <span class="hljs-string">'5560'</span>,
        <span class="hljs-string">'-sdcard'</span>,
        self.get_sdcard_path(),
        <span class="hljs-string">'-logcat'</span>,
        <span class="hljs-string">'*:d,*'</span>,
        <span class="hljs-string">'-no-boot-anim'</span>,
        <span class="hljs-string">'-partition-size'</span>,
        <span class="hljs-string">'128'</span> <span class="hljs-comment"># in between nexusone and droid</span>
    ]
    debug(<span class="hljs-string">' '</span>.join(emulator_cmd))

    p = subprocess.Popen(emulator_cmd)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handler</span><span class="hljs-params">(signum, frame)</span>:</span>
        debug(<span class="hljs-string">"signal caught: %d"</span> % signum)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p == <span class="hljs-keyword">None</span>:
            debug(<span class="hljs-string">"calling emulator kill on %d"</span> % p.pid)
            <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
                os.system(<span class="hljs-string">"taskkill /F /T /PID %i"</span> % p.pid)
            <span class="hljs-keyword">else</span>:
                os.kill(p.pid, signal.SIGTERM)

    <span class="hljs-keyword">if</span> platform.system() != <span class="hljs-string">"Windows"</span>:
        signal.signal(signal.SIGHUP, handler)
        signal.signal(signal.SIGQUIT, handler)

    signal.signal(signal.SIGINT, handler)
    signal.signal(signal.SIGABRT, handler)
    signal.signal(signal.SIGTERM, handler)

    <span class="hljs-comment"># give it some time to exit prematurely</span>
    time.sleep(<span class="hljs-number">1</span>)
    rc = p.poll()

    <span class="hljs-keyword">if</span> rc != <span class="hljs-keyword">None</span>:
        handler(<span class="hljs-number">3</span>,<span class="hljs-keyword">None</span>)
        sys.exit(rc)

    <span class="hljs-comment"># wait for the emulator to finish</span>
    <span class="hljs-keyword">try</span>:
        rc = p.wait()
    <span class="hljs-keyword">except</span> OSError:
        handler(<span class="hljs-number">3</span>,<span class="hljs-keyword">None</span>)

    info(<span class="hljs-string">"Android Emulator has exited"</span>)
    sys.exit(rc)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_file_exists</span><span class="hljs-params">(self, path)</span>:</span>
    output = self.run_adb(<span class="hljs-string">'shell'</span>, <span class="hljs-string">'ls'</span>, path)
    <span class="hljs-keyword">if</span> output != <span class="hljs-keyword">None</span>:
        <span class="hljs-keyword">if</span> output.find(<span class="hljs-string">"No such file or directory"</span>) == -<span class="hljs-number">1</span> \
            <span class="hljs-keyword">and</span> output.find(<span class="hljs-string">"error: device offline"</span>) == -<span class="hljs-number">1</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_app_installed</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-keyword">return</span> self.check_file_exists(<span class="hljs-string">'/data/app/%s*.apk'</span> % self.app_id)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_sdcard_path</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-comment"># We need to surround the sd card path in quotes for windows to account for spaces in path</span>
    <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'"'</span> + self.sdcard + <span class="hljs-string">'"'</span>
    <span class="hljs-keyword">return</span> self.sdcard

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">are_resources_installed</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-keyword">return</span> self.check_file_exists(self.sdcard_resources+<span class="hljs-string">'/app.js'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">include_path</span><span class="hljs-params">(self, path, isfile)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isfile <span class="hljs-keyword">and</span> os.path.basename(path) <span class="hljs-keyword">in</span> ignoreDirs: <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">elif</span> isfile <span class="hljs-keyword">and</span> os.path.basename(path) <span class="hljs-keyword">in</span> ignoreFiles: <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">warn_dupe_drawable_folders</span><span class="hljs-params">(self)</span>:</span>
    tocheck = (<span class="hljs-string">'high'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'low'</span>)
    image_parent = os.path.join(self.top_dir, <span class="hljs-string">'Resources'</span>, <span class="hljs-string">'android'</span>, <span class="hljs-string">'images'</span>)
    <span class="hljs-keyword">for</span> check <span class="hljs-keyword">in</span> tocheck:
        <span class="hljs-keyword">if</span> os.path.exists(os.path.join(image_parent, check)) <span class="hljs-keyword">and</span> os.path.exists(os.path.join(image_parent, <span class="hljs-string">'res-%sdpi'</span> % check[<span class="hljs-number">0</span>])):
            warn(<span class="hljs-string">'You have both an android/images/%s folder and an android/images/res-%sdpi folder. Files from both of these folders will end up in res/drawable-%sdpi.  If two files are named the same, there is no guarantee which one will be copied last and therefore be the one the application uses.  You should use just one of these folders to avoid conflicts.'</span> % (check, check[<span class="hljs-number">0</span>], check[<span class="hljs-number">0</span>]))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy_module_platform_folders</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-keyword">for</span> module <span class="hljs-keyword">in</span> self.modules:
        platform_folder = os.path.join(module.path, <span class="hljs-string">'platform'</span>, <span class="hljs-string">'android'</span>)
        <span class="hljs-keyword">if</span> os.path.exists(platform_folder):
            copy_all(platform_folder, self.project_dir, one_time_msg=<span class="hljs-string">"Copying platform-specific files for '%s' module"</span> % module.manifest.name)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy_project_platform_folder</span><span class="hljs-params">(self, ignore_dirs=[], ignore_files=[])</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.platform_dir):
        <span class="hljs-keyword">return</span>
    copy_all(self.platform_dir, self.project_dir, ignore_dirs, ignore_files, one_time_msg=<span class="hljs-string">"Copying platform-specific files ..."</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy_resource_drawables</span><span class="hljs-params">(self)</span>:</span>
    debug(<span class="hljs-string">'Processing Android resource drawables'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_resource_drawable_filename</span><span class="hljs-params">(orig)</span>:</span>
        normalized = orig.replace(os.sep, <span class="hljs-string">"/"</span>)
        matches = re.search(<span class="hljs-string">"/android/images/(high|medium|low|res-[^/]+)/(?P&lt;chopped&gt;.*$)"</span>, normalized)
        <span class="hljs-keyword">if</span> matches <span class="hljs-keyword">and</span> matches.groupdict() <span class="hljs-keyword">and</span> <span class="hljs-string">'chopped'</span> <span class="hljs-keyword">in</span> matches.groupdict():
            chopped = matches.groupdict()[<span class="hljs-string">'chopped'</span>].lower()
            for_hash = chopped
            <span class="hljs-keyword">if</span> for_hash.endswith(<span class="hljs-string">'.9.png'</span>):
                for_hash = for_hash[:-<span class="hljs-number">6</span>] + <span class="hljs-string">'.png'</span>
            extension = <span class="hljs-string">""</span>
            without_extension = chopped
            <span class="hljs-keyword">if</span> re.search(<span class="hljs-string">"\\..*$"</span>, chopped):
                <span class="hljs-keyword">if</span> chopped.endswith(<span class="hljs-string">'.9.png'</span>):
                    extension = <span class="hljs-string">'9.png'</span>
                    without_extension = chopped[:-<span class="hljs-number">6</span>]
                <span class="hljs-keyword">else</span>:
                    extension = chopped.split(<span class="hljs-string">"."</span>)[-<span class="hljs-number">1</span>]
                    without_extension = chopped[:-(len(extension)+<span class="hljs-number">1</span>)]
            cleaned_without_extension = re.sub(<span class="hljs-string">r'[^a-z0-9_]'</span>, <span class="hljs-string">'_'</span>, without_extension)
            cleaned_extension = re.sub(<span class="hljs-string">r'[^a-z0-9\._]'</span>, <span class="hljs-string">'_'</span>, extension)
            result = cleaned_without_extension[:<span class="hljs-number">80</span>] + <span class="hljs-string">"_"</span> + hashlib.md5(for_hash).hexdigest()[:<span class="hljs-number">10</span>]
            <span class="hljs-keyword">if</span> extension:
                result += <span class="hljs-string">"."</span> + extension
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">else</span>:
            trace(<span class="hljs-string">"Regexp for resource drawable file %s failed"</span> % orig)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_resource_drawable</span><span class="hljs-params">(orig)</span>:</span>
        folder = resource_drawable_folder(orig)
        res_file = os.path.join(self.res_dir, folder, make_resource_drawable_filename(orig))
        <span class="hljs-keyword">if</span> os.path.exists(res_file):
            <span class="hljs-keyword">try</span>:
                trace(<span class="hljs-string">"DELETING FILE: %s"</span> % res_file)
                os.remove(res_file)
            <span class="hljs-keyword">except</span>:
                warn(<span class="hljs-string">'Unable to delete %s: %s. Execution will continue.'</span> % (res_file, sys.exc_info()[<span class="hljs-number">0</span>]))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy_resource_drawable</span><span class="hljs-params">(orig)</span>:</span>
        partial_folder = resource_drawable_folder(orig)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> partial_folder:
            trace(<span class="hljs-string">"Could not copy %s; resource folder not determined"</span> % orig)
            <span class="hljs-keyword">return</span>
        dest_folder = os.path.join(self.res_dir, partial_folder)
        dest_filename = make_resource_drawable_filename(orig)
        <span class="hljs-keyword">if</span> dest_filename <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            <span class="hljs-keyword">return</span>
        dest = os.path.join(dest_folder, dest_filename)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(dest_folder):
            os.makedirs(dest_folder)
        trace(<span class="hljs-string">"COPYING FILE: %s =&gt; %s"</span> % (orig, dest))
        shutil.copy(orig, dest)

    fileset = []

    <span class="hljs-keyword">if</span> self.force_rebuild <span class="hljs-keyword">or</span> self.deploy_type == <span class="hljs-string">'production'</span> <span class="hljs-keyword">or</span> \
        (self.js_changed <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> self.fastdev):
        <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(os.path.join(self.top_dir, <span class="hljs-string">"Resources"</span>)):
            remove_ignored_dirs(dirs)
            <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:
                <span class="hljs-keyword">if</span> f <span class="hljs-keyword">in</span> ignoreFiles:
                    <span class="hljs-keyword">continue</span>
                path = os.path.join(root, f)
                <span class="hljs-keyword">if</span> is_resource_drawable(path) <span class="hljs-keyword">and</span> f != <span class="hljs-string">'default.png'</span>:
                    fileset.append(path)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">if</span> self.project_deltas:
            <span class="hljs-keyword">for</span> delta <span class="hljs-keyword">in</span> self.project_deltas:
                path = delta.get_path()
                <span class="hljs-keyword">if</span> is_resource_drawable(path):
                    <span class="hljs-keyword">if</span> delta.get_status() == Delta.DELETED:
                        delete_resource_drawable(path)
                    <span class="hljs-keyword">else</span>:
                        fileset.append(path)

    <span class="hljs-keyword">if</span> len(fileset) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>

    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> fileset:
        copy_resource_drawable(f)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy_project_resources</span><span class="hljs-params">(self)</span>:</span>
    info(<span class="hljs-string">"Copying project resources.."</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_filenames</span><span class="hljs-params">(topdir)</span>:</span>
        <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(topdir):
            remove_ignored_dirs(dirs)
            <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> dirs:
                <span class="hljs-keyword">if</span> d == <span class="hljs-string">"iphone"</span> <span class="hljs-keyword">or</span> d == <span class="hljs-string">"mobileweb"</span>:
                    dirs.remove(d)
            <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> files:
                <span class="hljs-keyword">if</span> filename.startswith(<span class="hljs-string">"_"</span>):
                    error(<span class="hljs-string">"%s is an invalid filename. Android will not package assets whose filenames start with underscores. Fix and rebuild."</span> % os.path.join(root, filename))
                    sys.exit(<span class="hljs-number">1</span>)

    resources_dir = os.path.join(self.top_dir, <span class="hljs-string">'Resources'</span>)
    validate_filenames(resources_dir)
    android_resources_dir = os.path.join(resources_dir, <span class="hljs-string">'android'</span>)
    self.project_deltafy = Deltafy(resources_dir, include_callback=self.include_path)
    self.project_deltas = self.project_deltafy.scan()
    self.js_changed = <span class="hljs-keyword">False</span>
    tiapp_delta = self.project_deltafy.scan_single_file(self.project_tiappxml)
    self.tiapp_changed = tiapp_delta <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>
    full_copy = <span class="hljs-keyword">not</span> os.path.exists(self.assets_resources_dir)

    <span class="hljs-keyword">if</span> self.tiapp_changed <span class="hljs-keyword">or</span> self.force_rebuild <span class="hljs-keyword">or</span> full_copy:
        info(<span class="hljs-string">"Detected tiapp.xml change (or assets deleted), forcing full re-build..."</span>)
        <span class="hljs-comment"># force a clean scan/copy when the tiapp.xml has changed</span>
        self.project_deltafy.clear_state()
        self.project_deltas = self.project_deltafy.scan()
        <span class="hljs-comment"># rescan tiapp.xml so it doesn't show up as created next time around </span>
        self.project_deltafy.scan_single_file(self.project_tiappxml)

    <span class="hljs-keyword">if</span> self.tiapp_changed:
        <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(self.project_gen_dir, topdown=<span class="hljs-keyword">False</span>):
            <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> files:
                os.remove(os.path.join(root, name))
            <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> dirs:
                os.rmdir(os.path.join(root, name))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">strip_slash</span><span class="hljs-params">(s)</span>:</span>
        <span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>:<span class="hljs-number">1</span>]==<span class="hljs-string">'/'</span> <span class="hljs-keyword">or</span> s[<span class="hljs-number">0</span>:<span class="hljs-number">1</span>]==<span class="hljs-string">'\\'</span>: <span class="hljs-keyword">return</span> s[<span class="hljs-number">1</span>:]
        <span class="hljs-keyword">return</span> s

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_relative</span><span class="hljs-params">(path, relative_to, prefix=None)</span>:</span>
        relative_path = strip_slash(path[len(relative_to):])
        <span class="hljs-keyword">if</span> prefix <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>:
            <span class="hljs-keyword">return</span> os.path.join(prefix, relative_path)
        <span class="hljs-keyword">return</span> relative_path

    <span class="hljs-keyword">for</span> delta <span class="hljs-keyword">in</span> self.project_deltas:
        path = delta.get_path()
        <span class="hljs-keyword">if</span> re.search(<span class="hljs-string">"android/images/(high|medium|low|res-[^/]+)/"</span>, path.replace(os.sep, <span class="hljs-string">"/"</span>)):
            <span class="hljs-keyword">continue</span> <span class="hljs-comment"># density images are handled later</span>

        <span class="hljs-keyword">if</span> delta.get_status() == Delta.DELETED <span class="hljs-keyword">and</span> path.startswith(android_resources_dir):
            shared_path = path.replace(android_resources_dir, resources_dir, <span class="hljs-number">1</span>)
            <span class="hljs-keyword">if</span> os.path.exists(shared_path):
                dest = make_relative(shared_path, resources_dir, self.assets_resources_dir)
                trace(<span class="hljs-string">"COPYING FILE: %s =&gt; %s (platform-specific file was removed)"</span> % (shared_path, dest))
                shutil.copy(shared_path, dest)

        <span class="hljs-keyword">if</span> delta.get_status() != Delta.DELETED:
            <span class="hljs-keyword">if</span> path.startswith(android_resources_dir):
                dest = make_relative(path, android_resources_dir, self.assets_resources_dir)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># don't copy it if there is an android-specific file</span>
                <span class="hljs-keyword">if</span> os.path.exists(path.replace(resources_dir, android_resources_dir, <span class="hljs-number">1</span>)):
                    <span class="hljs-keyword">continue</span>
                dest = make_relative(path, resources_dir, self.assets_resources_dir)
            <span class="hljs-keyword">if</span> path.startswith(os.path.join(resources_dir, <span class="hljs-string">"iphone"</span>)) <span class="hljs-keyword">or</span> path.startswith(os.path.join(resources_dir, <span class="hljs-string">"mobileweb"</span>)) <span class="hljs-keyword">or</span> path.startswith(os.path.join(resources_dir, <span class="hljs-string">"blackberry"</span>)):
                <span class="hljs-keyword">continue</span>
            parent = os.path.dirname(dest)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(parent):
                os.makedirs(parent)
            trace(<span class="hljs-string">"COPYING %s FILE: %s =&gt; %s"</span> % (delta.get_status_str(), path, dest))
            shutil.copy(path, dest)
            <span class="hljs-keyword">if</span> (path.startswith(resources_dir) <span class="hljs-keyword">or</span> path.startswith(android_resources_dir)) <span class="hljs-keyword">and</span> path.endswith(<span class="hljs-string">".js"</span>):
                self.js_changed = <span class="hljs-keyword">True</span>
            <span class="hljs-comment"># copy to the sdcard in development mode</span>
            <span class="hljs-keyword">if</span> self.sdcard_copy <span class="hljs-keyword">and</span> self.app_installed <span class="hljs-keyword">and</span> (self.deploy_type == <span class="hljs-string">'development'</span> <span class="hljs-keyword">or</span> self.deploy_type == <span class="hljs-string">'test'</span>):
                <span class="hljs-keyword">if</span> path.startswith(android_resources_dir):
                    relative_path = make_relative(delta.get_path(), android_resources_dir)
                <span class="hljs-keyword">else</span>:
                    relative_path = make_relative(delta.get_path(), resources_dir)
                relative_path = relative_path.replace(<span class="hljs-string">"\\"</span>, <span class="hljs-string">"/"</span>)
                self.run_adb(<span class="hljs-string">'push'</span>, delta.get_path(), <span class="hljs-string">"%s/%s"</span> % (self.sdcard_resources, relative_path))

    index_json_path = os.path.join(self.assets_dir, <span class="hljs-string">"index.json"</span>)
    <span class="hljs-keyword">if</span> len(self.project_deltas) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> os.path.exists(index_json_path):
        requireIndex.generateJSON(self.assets_dir, index_json_path)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_android_manifest</span><span class="hljs-params">(self,compiler)</span>:</span>

    self.generate_localizations()

    <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> these are built-in permissions we need -- we probably need to refine when these are needed too</span>
    permissions_required = [<span class="hljs-string">'INTERNET'</span>,<span class="hljs-string">'ACCESS_WIFI_STATE'</span>,<span class="hljs-string">'ACCESS_NETWORK_STATE'</span>, <span class="hljs-string">'WRITE_EXTERNAL_STORAGE'</span>]

    GEO_PERMISSION = [ <span class="hljs-string">'ACCESS_COARSE_LOCATION'</span>, <span class="hljs-string">'ACCESS_FINE_LOCATION'</span>]
    CONTACTS_PERMISSION = [<span class="hljs-string">'READ_CONTACTS'</span>]
    VIBRATE_PERMISSION = [<span class="hljs-string">'VIBRATE'</span>]
    CAMERA_PERMISSION = [<span class="hljs-string">'CAMERA'</span>]
    WALLPAPER_PERMISSION = [<span class="hljs-string">'SET_WALLPAPER'</span>]

    <span class="hljs-comment"># Enable mock location if in development or test mode.</span>
    <span class="hljs-keyword">if</span> self.deploy_type == <span class="hljs-string">'development'</span> <span class="hljs-keyword">or</span> self.deploy_type == <span class="hljs-string">'test'</span>:
        GEO_PERMISSION.append(<span class="hljs-string">'ACCESS_MOCK_LOCATION'</span>)

    <span class="hljs-comment"># this is our module method to permission(s) trigger - for each method on the left, require the permission(s) on the right</span>
    permission_mapping = {
        <span class="hljs-comment"># GEO</span>
        <span class="hljs-string">'Geolocation.watchPosition'</span> : GEO_PERMISSION,
        <span class="hljs-string">'Geolocation.getCurrentPosition'</span> : GEO_PERMISSION,
        <span class="hljs-string">'Geolocation.watchHeading'</span> : GEO_PERMISSION,
        <span class="hljs-string">'Geolocation.getCurrentHeading'</span> : GEO_PERMISSION,

        <span class="hljs-comment"># MEDIA</span>
        <span class="hljs-string">'Media.vibrate'</span> : VIBRATE_PERMISSION,
        <span class="hljs-string">'Media.showCamera'</span> : CAMERA_PERMISSION,

        <span class="hljs-comment"># CONTACTS</span>
        <span class="hljs-string">'Contacts.createContact'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.saveContact'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.removeContact'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.addContact'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.getAllContacts'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.showContactPicker'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.showContacts'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.getPersonByID'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.getPeopleWithName'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.getAllPeople'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.getAllGroups'</span> : CONTACTS_PERMISSION,
        <span class="hljs-string">'Contacts.getGroupByID'</span> : CONTACTS_PERMISSION,

        <span class="hljs-comment"># WALLPAPER</span>
        <span class="hljs-string">'Media.Android.setSystemWallpaper'</span> : WALLPAPER_PERMISSION,
    }

    VIDEO_ACTIVITY = <span class="hljs-string">"""&lt;activity
    android:name="ti.modules.titanium.media.TiVideoActivity"
    android:configChanges="keyboardHidden|orientation"
    android:theme="@android:style/Theme.NoTitleBar.Fullscreen"
    android:launchMode="singleTask"
    /&gt;"""</span>

    MAP_ACTIVITY = <span class="hljs-string">"""&lt;activity
        android:name="ti.modules.titanium.map.TiMapActivity"
        android:configChanges="keyboardHidden|orientation"
        android:launchMode="singleTask"
    /&gt;
&lt;uses-library android:name="com.google.android.maps" /&gt;"""</span>

    FACEBOOK_ACTIVITY = <span class="hljs-string">"""&lt;activity 
    android:name="ti.modules.titanium.facebook.FBActivity"
    android:theme="@android:style/Theme.Translucent.NoTitleBar"
/&gt;"""</span>

    CAMERA_ACTIVITY = <span class="hljs-string">"""&lt;activity 
    android:name="ti.modules.titanium.media.TiCameraActivity"
    android:configChanges="keyboardHidden|orientation"
    android:theme="@android:style/Theme.Translucent.NoTitleBar.Fullscreen"
/&gt;"""</span>

    activity_mapping = {

        <span class="hljs-comment"># MEDIA</span>
        <span class="hljs-string">'Media.createVideoPlayer'</span> : VIDEO_ACTIVITY,
        <span class="hljs-string">'Media.showCamera'</span> : CAMERA_ACTIVITY,

        <span class="hljs-comment"># MAPS</span>
        <span class="hljs-string">'Map.createView'</span> : MAP_ACTIVITY,

        <span class="hljs-comment"># FACEBOOK</span>
        <span class="hljs-string">'Facebook.setup'</span> : FACEBOOK_ACTIVITY,
        <span class="hljs-string">'Facebook.login'</span> : FACEBOOK_ACTIVITY,
        <span class="hljs-string">'Facebook.createLoginButton'</span> : FACEBOOK_ACTIVITY,
    }

    <span class="hljs-comment"># this is a map of our APIs to ones that require Google APIs to be available on the device</span>
    google_apis = {
        <span class="hljs-string">"Map.createView"</span> : <span class="hljs-keyword">True</span>
    }

    activities = []

    <span class="hljs-comment"># figure out which permissions we need based on the used module methods</span>
    <span class="hljs-keyword">for</span> mn <span class="hljs-keyword">in</span> compiler.module_methods:
        <span class="hljs-keyword">try</span>:
            perms = permission_mapping[mn]
            <span class="hljs-keyword">if</span> perms:
                <span class="hljs-keyword">for</span> perm <span class="hljs-keyword">in</span> perms: 
                    <span class="hljs-keyword">try</span>:
                        permissions_required.index(perm)
                    <span class="hljs-keyword">except</span>:
                        permissions_required.append(perm)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">pass</span>
        <span class="hljs-keyword">try</span>:
            mappings = activity_mapping[mn]
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">if</span> google_apis[mn] <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> self.google_apis_supported:
                    warn(<span class="hljs-string">"Google APIs detected but a device has been selected that doesn't support them. The API call to Titanium.%s will fail using '%s'"</span> % (mn,my_avd[<span class="hljs-string">'name'</span>]))
                    <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            <span class="hljs-keyword">try</span>:
                activities.index(mappings)
            <span class="hljs-keyword">except</span>:
                activities.append(mappings)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">pass</span>

    <span class="hljs-comment"># Javascript-based activities defined in tiapp.xml</span>
    <span class="hljs-keyword">if</span> self.tiapp <span class="hljs-keyword">and</span> self.tiapp.android <span class="hljs-keyword">and</span> <span class="hljs-string">'activities'</span> <span class="hljs-keyword">in</span> self.tiapp.android:
        tiapp_activities = self.tiapp.android[<span class="hljs-string">'activities'</span>]
        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> tiapp_activities:
            activity = tiapp_activities[key]
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-string">'url'</span> <span class="hljs-keyword">in</span> activity:
                <span class="hljs-keyword">continue</span>
            activity_name = self.app_id + <span class="hljs-string">'.'</span> + activity[<span class="hljs-string">'classname'</span>]
            activity_str = <span class="hljs-string">'&lt;activity \n\t\t\tandroid:name="%s"'</span> % activity_name
            <span class="hljs-keyword">for</span> subkey <span class="hljs-keyword">in</span> activity:
                <span class="hljs-keyword">if</span> subkey <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'nodes'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'url'</span>, <span class="hljs-string">'options'</span>, <span class="hljs-string">'classname'</span>, <span class="hljs-string">'android:name'</span>):
                    activity_str += <span class="hljs-string">'\n\t\t\t%s="%s"'</span> % (subkey, activity[subkey])

            <span class="hljs-keyword">if</span> <span class="hljs-string">'android:config'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> activity:
                activity_str += <span class="hljs-string">'\n\t\t\tandroid:configChanges="keyboardHidden|orientation"'</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'nodes'</span> <span class="hljs-keyword">in</span> activity:
                activity_str += <span class="hljs-string">'&gt;'</span>
                <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> activity[<span class="hljs-string">'nodes'</span>]:
                    activity_str += <span class="hljs-string">'\n\t\t\t\t'</span> + node.toxml()
                activities.append(activity_str + <span class="hljs-string">'\n\t\t&lt;/activity&gt;\n'</span>)
            <span class="hljs-keyword">else</span>:
                activities.append(activity_str + <span class="hljs-string">'\n\t\t/&gt;\n'</span>)

    activities = set(activities)

    services = []
    <span class="hljs-comment"># Javascript-based services defined in tiapp.xml</span>
    <span class="hljs-keyword">if</span> self.tiapp <span class="hljs-keyword">and</span> self.tiapp.android <span class="hljs-keyword">and</span> <span class="hljs-string">'services'</span> <span class="hljs-keyword">in</span> self.tiapp.android:
        tiapp_services = self.tiapp.android[<span class="hljs-string">'services'</span>]
        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> tiapp_services:
            service = tiapp_services[key]
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-string">'url'</span> <span class="hljs-keyword">in</span> service:
                <span class="hljs-keyword">continue</span>
            service_name = self.app_id + <span class="hljs-string">'.'</span> + service[<span class="hljs-string">'classname'</span>]
            service_str = <span class="hljs-string">'&lt;service \n\t\t\tandroid:name="%s"'</span> % service_name
            <span class="hljs-keyword">for</span> subkey <span class="hljs-keyword">in</span> service:
                <span class="hljs-keyword">if</span> subkey <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'nodes'</span>, <span class="hljs-string">'service_type'</span>, <span class="hljs-string">'type'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'url'</span>, <span class="hljs-string">'options'</span>, <span class="hljs-string">'classname'</span>, <span class="hljs-string">'android:name'</span>):
                    service_str += <span class="hljs-string">'\n\t\t\t%s="%s"'</span> % (subkey, service[subkey])

            <span class="hljs-keyword">if</span> <span class="hljs-string">'nodes'</span> <span class="hljs-keyword">in</span> service:
                service_str += <span class="hljs-string">'&gt;'</span>
                <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> service[<span class="hljs-string">'nodes'</span>]:
                    service_str += <span class="hljs-string">'\n\t\t\t\t'</span> + node.toxml()
                services.append(service_str + <span class="hljs-string">'\n\t\t&lt;/service&gt;\n'</span>)
            <span class="hljs-keyword">else</span>:
                services.append(service_str + <span class="hljs-string">'\n\t\t/&gt;\n'</span>)


    self.use_maps = <span class="hljs-keyword">False</span>
    self.res_changed = <span class="hljs-keyword">False</span>
    icon_name = self.tiapp.properties[<span class="hljs-string">'icon'</span>]
    icon_path = os.path.join(self.assets_resources_dir, icon_name)
    icon_ext = os.path.splitext(icon_path)[<span class="hljs-number">1</span>]

    res_drawable_dest = os.path.join(self.project_dir, <span class="hljs-string">'res'</span>, <span class="hljs-string">'drawable'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(res_drawable_dest):
        os.makedirs(res_drawable_dest)

    default_icon = os.path.join(self.support_resources_dir, <span class="hljs-string">'default.png'</span>)
    dest_icon = os.path.join(res_drawable_dest, <span class="hljs-string">'appicon%s'</span> % icon_ext)
    <span class="hljs-keyword">if</span> Deltafy.needs_update(icon_path, dest_icon):
        self.res_changed = <span class="hljs-keyword">True</span>
        debug(<span class="hljs-string">"copying app icon: %s"</span> % icon_path)
        shutil.copy(icon_path, dest_icon)
    <span class="hljs-keyword">elif</span> Deltafy.needs_update(default_icon, dest_icon):
        self.res_changed = <span class="hljs-keyword">True</span>
        debug(<span class="hljs-string">"copying default app icon"</span>)
        shutil.copy(default_icon, dest_icon)

    <span class="hljs-comment"># make our Titanium theme for our icon</span>
    res_values_dir = os.path.join(self.project_dir, <span class="hljs-string">'res'</span>,<span class="hljs-string">'values'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(res_values_dir):
        os.makedirs(res_values_dir)
    theme_xml = os.path.join(res_values_dir,<span class="hljs-string">'theme.xml'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(theme_xml):
        self.res_changed = <span class="hljs-keyword">True</span>
        debug(<span class="hljs-string">'generating theme.xml'</span>)
        theme_file = open(theme_xml, <span class="hljs-string">'w'</span>)
        theme_flags = <span class="hljs-string">"Theme"</span>
        <span class="hljs-comment"># We need to treat the default values for fulscreen and</span>
        <span class="hljs-comment"># navbar-hidden the same as android.py does -- false for both.</span>
        theme_fullscreen = <span class="hljs-keyword">False</span>
        theme_navbarhidden = <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">if</span> (self.tiapp.properties.get(<span class="hljs-string">"fullscreen"</span>) == <span class="hljs-string">"true"</span> <span class="hljs-keyword">or</span> 
                self.tiapp.properties.get(<span class="hljs-string">"statusbar-hidden"</span>) == <span class="hljs-string">"true"</span>):
            theme_fullscreen = <span class="hljs-keyword">True</span>
        <span class="hljs-keyword">elif</span> self.tiapp.properties.get(<span class="hljs-string">"navbar-hidden"</span>) == <span class="hljs-string">"true"</span>:
            theme_navbarhidden = <span class="hljs-keyword">True</span>
        <span class="hljs-keyword">if</span> theme_fullscreen:
            theme_flags += <span class="hljs-string">".NoTitleBar.Fullscreen"</span>
        <span class="hljs-keyword">elif</span> theme_navbarhidden:
            theme_flags += <span class="hljs-string">".NoTitleBar"</span>
        <span class="hljs-comment"># Wait, one exception.  If you want the notification area (very</span>
        <span class="hljs-comment"># top of screen) hidden, but want the title bar in the app,</span>
        <span class="hljs-comment"># there's no theme for that.  So we have to use the default theme (no flags)</span>
        <span class="hljs-comment"># and when the application code starts running, the adjustments are then made.</span>
        <span class="hljs-comment"># Only do this when the properties are explicitly set, so as to avoid changing</span>
        <span class="hljs-comment"># old default behavior.</span>
        <span class="hljs-keyword">if</span> theme_flags.endswith(<span class="hljs-string">'.Fullscreen'</span>) <span class="hljs-keyword">and</span> \
                self.tiapp.properties.get(<span class="hljs-string">"navbar-hidden"</span>) == <span class="hljs-string">'false'</span> <span class="hljs-keyword">and</span> \
                (<span class="hljs-string">'fullscreen'</span> <span class="hljs-keyword">in</span> self.tiapp.explicit_properties <span class="hljs-keyword">or</span> \
                <span class="hljs-string">'statusbar-hidden'</span> <span class="hljs-keyword">in</span> self.tiapp.explicit_properties) <span class="hljs-keyword">and</span> \
                <span class="hljs-string">'navbar-hidden'</span> <span class="hljs-keyword">in</span> self.tiapp.explicit_properties:
            theme_flags = <span class="hljs-string">'Theme'</span>

        TITANIUM_THEME=<span class="hljs-string">"""&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
</code></pre><p>&lt;resources&gt;<br>&lt;style name=&quot;Theme.Titanium&quot; parent=&quot;android:%s&quot;&gt;<br>    &lt;item name=&quot;android:windowBackground&quot;&gt;@drawable&#x2F;background&lt;&#x2F;item&gt;<br>&lt;&#x2F;style&gt;<br>&lt;&#x2F;resources&gt;<br>&quot;&quot;&quot; % theme_flags<br>            theme_file.write(TITANIUM_THEME)<br>            theme_file.close()</p>
<pre><code class="hljs">    # <span class="hljs-operator"><span class="hljs-keyword">create</span> our background image which acts <span class="hljs-keyword">as</span> splash screen during <span class="hljs-keyword">load</span>    
    resources_dir = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.top_dir, <span class="hljs-string">'Resources'</span>)
    android_images_dir = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(resources_dir, <span class="hljs-string">'android'</span>, <span class="hljs-string">'images'</span>)
    # look <span class="hljs-keyword">for</span> density-specific <span class="hljs-keyword">default</span>.png<span class="hljs-string">'s first
    if os.path.exists(android_images_dir):
        pattern = r'</span>/android/images/(<span class="hljs-keyword">high</span>|<span class="hljs-keyword">medium</span>|<span class="hljs-keyword">low</span>|res-[^/]+)/<span class="hljs-keyword">default</span>.png<span class="hljs-string">'
        for root, dirs, files in os.walk(android_images_dir):
            remove_ignored_dirs(dirs)
            for f in files:
                if f in ignoreFiles:
                    continue
                path = os.path.join(root, f)
                if re.search(pattern, path.replace(os.sep, "/")):
                    res_folder = resource_drawable_folder(path)
                    debug('</span><span class="hljs-keyword">found</span> %s splash screen <span class="hljs-keyword">at</span> %s<span class="hljs-string">' % (res_folder, path))
                    dest_path = os.path.join(self.res_dir, res_folder)
                    dest_file = os.path.join(dest_path, '</span>background.png<span class="hljs-string">')
                    if not os.path.exists(dest_path):
                        os.makedirs(dest_path)
                    if Deltafy.needs_update(path, dest_file):
                        self.res_changed = True
                        debug('</span>copying %s splash screen <span class="hljs-keyword">to</span> %s<span class="hljs-string">' % (path, dest_file))
                        shutil.copy(path, dest_file)

    default_png = os.path.join(self.assets_resources_dir, '</span><span class="hljs-keyword">default</span>.png<span class="hljs-string">')
    support_default_png = os.path.join(self.support_resources_dir, '</span><span class="hljs-keyword">default</span>.png<span class="hljs-string">')
    background_png = os.path.join(self.project_dir, '</span>res<span class="hljs-string">','</span>drawable<span class="hljs-string">','</span>background.png<span class="hljs-string">')
    if os.path.exists(default_png) and Deltafy.needs_update(default_png, background_png):
        self.res_changed = True
        debug("found splash screen at %s" % os.path.abspath(default_png))
        shutil.copy(default_png, background_png)
    elif Deltafy.needs_update(support_default_png, background_png):
        self.res_changed = True
        debug("copying default splash screen")
        shutil.copy(support_default_png, background_png)


    android_manifest = os.path.join(self.project_dir, '</span>AndroidManifest.<span class="hljs-keyword">xml</span><span class="hljs-string">')
    android_manifest_to_read = android_manifest

    # NOTE: allow the user to use their own custom AndroidManifest if they put a file named
    # AndroidManifest.xml in platform/android, in which case all bets are off
    is_custom = False
    # Catch people who may have it in project root (un-released 1.4.x android_native_refactor branch users)
    if os.path.exists(os.path.join(self.top_dir, '</span>AndroidManifest.<span class="hljs-keyword">xml</span><span class="hljs-string">')):
        warn('</span>AndroidManifest.<span class="hljs-keyword">xml</span> <span class="hljs-keyword">file</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">project</span> root <span class="hljs-keyword">is</span> ignored.  <span class="hljs-keyword">Move</span> it <span class="hljs-keyword">to</span> platform/android <span class="hljs-keyword">if</span> you want it <span class="hljs-keyword">to</span> be your custom manifest.<span class="hljs-string">')
    android_custom_manifest = os.path.join(self.project_dir, '</span>AndroidManifest.custom.<span class="hljs-keyword">xml</span><span class="hljs-string">')
    if not os.path.exists(android_custom_manifest):
        android_custom_manifest = os.path.join(self.platform_dir, '</span>AndroidManifest.<span class="hljs-keyword">xml</span><span class="hljs-string">')
    else:
        warn('</span><span class="hljs-keyword">Use</span> <span class="hljs-keyword">of</span> AndroidManifest.custom.<span class="hljs-keyword">xml</span> <span class="hljs-keyword">is</span> deprecated. Please put your custom manifest <span class="hljs-keyword">as</span> <span class="hljs-string">"AndroidManifest.xml"</span> <span class="hljs-keyword">in</span> the <span class="hljs-string">"platform/android"</span> <span class="hljs-keyword">directory</span> <span class="hljs-keyword">if</span> you <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> need <span class="hljs-keyword">to</span> compile <span class="hljs-keyword">for</span> <span class="hljs-keyword">versions</span> &lt; <span class="hljs-number">1.5</span><span class="hljs-string">')
    if os.path.exists(android_custom_manifest):
        android_manifest_to_read = android_custom_manifest
        is_custom = True
        info("Detected custom ApplicationManifest.xml -- no Titanium version migration supported")

    default_manifest_contents = self.android.render_android_manifest()
    custom_manifest_contents = None
    if is_custom:
        custom_manifest_contents = open(android_manifest_to_read,'</span>r<span class="hljs-string">').read()

    manifest_xml = ''
    def get_manifest_xml(tiapp, template_obj=None):
        xml = ''
        if '</span>manifest<span class="hljs-string">' in tiapp.android_manifest:
            for manifest_el in tiapp.android_manifest['</span>manifest<span class="hljs-string">']:
                # since we already track permissions in another way, go ahead and us e that
                if manifest_el.nodeName == '</span>uses-permission<span class="hljs-string">' and manifest_el.hasAttribute('</span>android:<span class="hljs-keyword">name</span><span class="hljs-string">'):
                    if manifest_el.getAttribute('</span>android:<span class="hljs-keyword">name</span><span class="hljs-string">').split('</span>.<span class="hljs-string">')[-1] not in permissions_required:
                        perm_val = manifest_el.getAttribute('</span>android:<span class="hljs-keyword">name</span><span class="hljs-string">')
                        if template_obj is not None and "${" in perm_val:
                            perm_val = render_template_with_tiapp(perm_val, template_obj)
                        permissions_required.append(perm_val)
                elif manifest_el.nodeName not in ('</span>supports-screens<span class="hljs-string">', '</span>uses-sdk<span class="hljs-string">'):
                    this_xml = manifest_el.toprettyxml()
                    if template_obj is not None and "${" in this_xml:
                        this_xml = render_template_with_tiapp(this_xml, template_obj)
                    xml += this_xml
        return xml

    application_xml = ''
    def get_application_xml(tiapp, template_obj=None):
        xml = ''
        if '</span>application<span class="hljs-string">' in tiapp.android_manifest:
            for app_el in tiapp.android_manifest['</span>application<span class="hljs-string">']:
                this_xml = app_el.toxml()
                if template_obj is not None and "${" in this_xml:
                    this_xml = render_template_with_tiapp(this_xml, template_obj)
                xml += this_xml
        return xml

    # add manifest / application entries from tiapp.xml
    manifest_xml += get_manifest_xml(self.tiapp)
    application_xml += get_application_xml(self.tiapp)

    # add manifest / application entries from modules
    for module in self.modules:
        if module.xml == None: continue
        manifest_xml += get_manifest_xml(module.xml, self.tiapp)
        application_xml += get_application_xml(module.xml, self.tiapp)

    # build the permissions XML based on the permissions detected
    permissions_required = set(permissions_required)
    permissions_required_xml = ""
    for p in permissions_required:
        if '</span>.<span class="hljs-string">' not in p:
            permissions_required_xml+="&lt;uses-permission android:name=\"android.permission.%s\"/&gt;\n\t" % p
        else:
            permissions_required_xml+="&lt;uses-permission android:name=\"%s\"/&gt;\n\t" % p

    def fill_manifest(manifest_source):
        ti_activities = '</span>&lt;!<span class="hljs-comment">-- TI_ACTIVITIES --&gt;'</span>
        ti_permissions = <span class="hljs-string">'&lt;!-- TI_PERMISSIONS --&gt;'</span>
        ti_manifest = <span class="hljs-string">'&lt;!-- TI_MANIFEST --&gt;'</span>
        ti_application = <span class="hljs-string">'&lt;!-- TI_APPLICATION --&gt;'</span>
        ti_services = <span class="hljs-string">'&lt;!-- TI_SERVICES --&gt;'</span>
        manifest_source = manifest_source.<span class="hljs-keyword">replace</span>(ti_activities,<span class="hljs-string">"\n\n\t\t"</span>.<span class="hljs-keyword">join</span>(activities))
        manifest_source = manifest_source.<span class="hljs-keyword">replace</span>(ti_services,<span class="hljs-string">"\n\n\t\t"</span>.<span class="hljs-keyword">join</span>(services))
        manifest_source = manifest_source.<span class="hljs-keyword">replace</span>(ti_permissions,permissions_required_xml)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(manifest_xml) &gt; <span class="hljs-number">0</span>:
            manifest_source = manifest_source.<span class="hljs-keyword">replace</span>(ti_manifest, manifest_xml)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(application_xml) &gt; <span class="hljs-number">0</span>:
            manifest_source = manifest_source.<span class="hljs-keyword">replace</span>(ti_application, application_xml)

        <span class="hljs-keyword">return</span> manifest_source

    default_manifest_contents = fill_manifest(default_manifest_contents)
    # <span class="hljs-keyword">if</span> a custom uses-sdk <span class="hljs-keyword">or</span> supports-screens has been specified via tiapp.<span class="hljs-keyword">xml</span>
    # &lt;android&gt;&lt;manifest&gt;..., we need <span class="hljs-keyword">to</span> <span class="hljs-keyword">replace</span> the ones <span class="hljs-keyword">in</span> the <span class="hljs-keyword">generated</span>
    # <span class="hljs-keyword">default</span> manifest
    supports_screens_node = <span class="hljs-keyword">None</span>
    uses_sdk_node = <span class="hljs-keyword">None</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'manifest'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest:
        <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'manifest'</span>]:
            <span class="hljs-keyword">if</span> node.nodeName == <span class="hljs-string">'uses-sdk'</span>:
                uses_sdk_node = node
            elif node.nodeName == <span class="hljs-string">'supports-screens'</span>:
                supports_screens_node = node
    <span class="hljs-keyword">if</span> supports_screens_node <span class="hljs-keyword">or</span> uses_sdk_node <span class="hljs-keyword">or</span> (<span class="hljs-string">'manifest-attributes'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'manifest-attributes'</span>].<span class="hljs-keyword">length</span>) <span class="hljs-keyword">or</span> (<span class="hljs-string">'application-attributes'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'application-attributes'</span>].<span class="hljs-keyword">length</span>):
        dom = parseString(default_manifest_contents)
        <span class="hljs-keyword">def</span> replace_node(olddom, newnode):
            nodes = olddom.getElementsByTagName(newnode.nodeName)
            retval = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">if</span> nodes:
                olddom.documentElement.replaceChild(newnode, nodes[<span class="hljs-number">0</span>])
                retval = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">return</span> retval

        <span class="hljs-keyword">if</span> supports_screens_node:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> replace_node(dom, supports_screens_node):
                dom.documentElement.insertBefore(supports_screens_node, dom.documentElement.firstChild.nextSibling)
        <span class="hljs-keyword">if</span> uses_sdk_node:
            replace_node(dom, uses_sdk_node)

        <span class="hljs-keyword">def</span> set_attrs(<span class="hljs-keyword">element</span>, new_attr_set):
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">k</span> <span class="hljs-keyword">in</span> new_attr_set.<span class="hljs-keyword">keys</span>():
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">element</span>.hasAttribute(<span class="hljs-keyword">k</span>):
                    <span class="hljs-keyword">element</span>.removeAttribute(<span class="hljs-keyword">k</span>)
                <span class="hljs-keyword">element</span>.setAttribute(<span class="hljs-keyword">k</span>, new_attr_set.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">k</span>).<span class="hljs-keyword">value</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-string">'manifest-attributes'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'manifest-attributes'</span>].<span class="hljs-keyword">length</span>:
            set_attrs(dom.documentElement, <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'manifest-attributes'</span>])
        <span class="hljs-keyword">if</span> <span class="hljs-string">'application-attributes'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'application-attributes'</span>].<span class="hljs-keyword">length</span>:
            set_attrs(dom.getElementsByTagName(<span class="hljs-string">'application'</span>)[<span class="hljs-number">0</span>], <span class="hljs-keyword">self</span>.tiapp.android_manifest[<span class="hljs-string">'application-attributes'</span>])

        default_manifest_contents = dom.toxml()

    <span class="hljs-keyword">if</span> application_xml:
        # <span class="hljs-keyword">If</span> the tiapp.<span class="hljs-keyword">xml</span> &lt;manifest&gt;&lt;application&gt; <span class="hljs-keyword">section</span> was <span class="hljs-keyword">not</span> <span class="hljs-keyword">empty</span>, it could be
        # that <span class="hljs-keyword">user</span> put <span class="hljs-keyword">in</span> &lt;activity&gt; entries that <span class="hljs-keyword">duplicate</span> our own,
        # such <span class="hljs-keyword">as</span> <span class="hljs-keyword">if</span> they want a custom theme <span class="hljs-keyword">on</span> TiActivity.  So we should <span class="hljs-keyword">delete</span> <span class="hljs-keyword">any</span> dupes.
        dom = parseString(default_manifest_contents)
        package_name = dom.documentElement.getAttribute(<span class="hljs-string">'package'</span>)
        manifest_activities = dom.getElementsByTagName(<span class="hljs-string">'activity'</span>)
        activity_names = []
        nodes_to_delete = []
        <span class="hljs-keyword">for</span> manifest_activity <span class="hljs-keyword">in</span> manifest_activities:
            <span class="hljs-keyword">if</span> manifest_activity.hasAttribute(<span class="hljs-string">'android:name'</span>):
                activity_name = manifest_activity.getAttribute(<span class="hljs-string">'android:name'</span>)
                <span class="hljs-keyword">if</span> activity_name.startswith(<span class="hljs-string">'.'</span>):
                    activity_name = package_name + activity_name
                <span class="hljs-keyword">if</span> activity_name <span class="hljs-keyword">in</span> activity_names:
                    nodes_to_delete.append(manifest_activity)
                <span class="hljs-keyword">else</span>:
                    activity_names.append(activity_name)
        <span class="hljs-keyword">if</span> nodes_to_delete:
            <span class="hljs-keyword">for</span> node_to_delete <span class="hljs-keyword">in</span> nodes_to_delete:
                node_to_delete.parentNode.removeChild(node_to_delete)
            default_manifest_contents = dom.toxml()

    <span class="hljs-keyword">if</span> custom_manifest_contents:
        custom_manifest_contents = fill_manifest(custom_manifest_contents)

    new_manifest_contents = <span class="hljs-keyword">None</span>
    android_manifest_gen = android_manifest + <span class="hljs-string">'.gen'</span>
    <span class="hljs-keyword">if</span> custom_manifest_contents:
        new_manifest_contents = custom_manifest_contents
        # Write the would-be <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> well so <span class="hljs-keyword">user</span> can see
        # <span class="hljs-keyword">some</span> <span class="hljs-keyword">of</span> the <span class="hljs-keyword">auto</span>-gen<span class="hljs-string">'d insides of it if they need/want.
        amf = open(android_manifest + '</span>.gen<span class="hljs-string">', '</span>w<span class="hljs-string">')
        amf.write(default_manifest_contents)
        amf.close()
    else:
        new_manifest_contents = default_manifest_contents
        if os.path.exists(android_manifest_gen):
            os.remove(android_manifest_gen)

    manifest_changed = False
    old_contents = None
    if os.path.exists(android_manifest):
        old_contents = open(android_manifest, '</span>r<span class="hljs-string">').read()

    if new_manifest_contents != old_contents:
        trace("Writing out AndroidManifest.xml")
        amf = open(android_manifest,'</span>w<span class="hljs-string">')
        amf.write(new_manifest_contents)
        amf.close()
        manifest_changed = True

    if self.res_changed or manifest_changed:
        res_dir = os.path.join(self.project_dir, '</span>res<span class="hljs-string">')
        output = run.run([self.aapt, '</span><span class="hljs-keyword">package</span><span class="hljs-string">', '</span>-<span class="hljs-keyword">m</span><span class="hljs-string">',
            '</span>-J<span class="hljs-string">', self.project_gen_dir,
            '</span>-<span class="hljs-keyword">M</span><span class="hljs-string">', android_manifest,
            '</span>-S<span class="hljs-string">', res_dir,
            '</span>-<span class="hljs-keyword">I</span><span class="hljs-string">', self.android_jar], warning_regex=r'</span>skipping<span class="hljs-string">')

    r_file = os.path.join(self.project_gen_dir, self.app_id.replace('</span>.<span class="hljs-string">', os.sep), '</span>R.<span class="hljs-keyword">java</span><span class="hljs-string">')
    if not os.path.exists(r_file) or (self.res_changed and output == None):
        error("Error generating R.java from manifest")
        sys.exit(1)

    return manifest_changed

def generate_stylesheet(self):
    update_stylesheet = False
    resources_dir = os.path.join(self.top_dir, '</span>Resources<span class="hljs-string">')
    project_gen_pkg_dir = os.path.join(self.project_gen_dir, self.app_id.replace('</span>.<span class="hljs-string">', os.sep))
    app_stylesheet = os.path.join(project_gen_pkg_dir, '</span>ApplicationStylesheet.<span class="hljs-keyword">java</span><span class="hljs-string">')
    if not os.path.exists(app_stylesheet):
        update_stylesheet = True
    else:
        for root, dirs, files in os.walk(resources_dir):
            remove_ignored_dirs(dirs)
            for f in files:
                if f in ignoreFiles:
                    continue
                if f.endswith(".jss"):
                    absolute_path = os.path.join(root, f)
                    if Deltafy.needs_update(absolute_path, app_stylesheet):
                        update_stylesheet = True
                        break

    if not update_stylesheet:
        return

    cssc = csscompiler.CSSCompiler(resources_dir, '</span>android<span class="hljs-string">', self.app_id)
    if not os.path.exists(project_gen_pkg_dir):
        os.makedirs(project_gen_pkg_dir)
    debug("app stylesheet =&gt; %s" % app_stylesheet)

    asf = codecs.open(app_stylesheet, '</span>w<span class="hljs-string">', '</span>utf-<span class="hljs-number">8</span><span class="hljs-string">')
    asf.write(cssc.code)
    asf.close()

def generate_localizations(self):
    # compile localization files
    localecompiler.LocaleCompiler(self.name,self.top_dir,'</span>android<span class="hljs-string">',sys.argv[1]).compile()
    # fix un-escaped single-quotes and full-quotes
    offending_pattern = '</span>[^\\\\][\<span class="hljs-string">'"]'</span>
    <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(<span class="hljs-keyword">self</span>.res_dir):
        remove_ignored_dirs(dirs)
        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> files:
            <span class="hljs-keyword">if</span> filename <span class="hljs-keyword">in</span> ignoreFiles <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> filename.endswith(<span class="hljs-string">'.xml'</span>):
                continue
            full_path = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(root, filename)
            <span class="hljs-keyword">f</span> = codecs.<span class="hljs-keyword">open</span>(full_path, <span class="hljs-string">'r'</span>, <span class="hljs-string">'utf-8'</span>)
            <span class="hljs-keyword">contents</span> = <span class="hljs-keyword">f</span>.<span class="hljs-keyword">read</span>()
            <span class="hljs-keyword">f</span>.<span class="hljs-keyword">close</span>()
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">search</span>(r<span class="hljs-string">"&lt;string "</span>, <span class="hljs-keyword">contents</span>):
                continue
            doc = parseString(<span class="hljs-keyword">contents</span>.<span class="hljs-keyword">encode</span>(<span class="hljs-string">"utf-8"</span>))
            string_nodes = doc.getElementsByTagName(<span class="hljs-string">'string'</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(string_nodes) == <span class="hljs-number">0</span>:
                continue
            made_change = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">for</span> string_node <span class="hljs-keyword">in</span> string_nodes:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> string_node.hasChildNodes():
                    continue
                string_child = string_node.firstChild
                <span class="hljs-keyword">if</span> string_child.nodeType == string_child.CDATA_SECTION_NODE <span class="hljs-keyword">or</span> string_child.nodeType == string_child.TEXT_NODE:
                    string_value = string_child.nodeValue
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">search</span>(offending_pattern, string_value):
                        continue
                    offenders = re.findall(offending_pattern, string_value)
                    <span class="hljs-keyword">if</span> offenders:
                        <span class="hljs-keyword">for</span> offender <span class="hljs-keyword">in</span> offenders:
                            string_value = string_value.<span class="hljs-keyword">replace</span>(offender, offender[<span class="hljs-number">0</span>] + <span class="hljs-string">"\\"</span> + offender[-<span class="hljs-number">1</span>:])
                            made_change = <span class="hljs-literal">True</span>
                    string_child.nodeValue = string_value
            <span class="hljs-keyword">if</span> made_change:
                new_contents = doc.toxml()
                <span class="hljs-keyword">f</span> = codecs.<span class="hljs-keyword">open</span>(full_path, <span class="hljs-string">'w'</span>, <span class="hljs-string">'utf-8'</span>)
                <span class="hljs-keyword">f</span>.write(new_contents)
                <span class="hljs-keyword">f</span>.<span class="hljs-keyword">close</span>()

<span class="hljs-keyword">def</span> recurse(<span class="hljs-keyword">self</span>, paths, file_glob=<span class="hljs-keyword">None</span>):
    <span class="hljs-keyword">if</span> paths == <span class="hljs-keyword">None</span>: yield <span class="hljs-keyword">None</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(paths, <span class="hljs-keyword">list</span>): paths = [paths]

    <span class="hljs-keyword">for</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">in</span> paths:
        <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(<span class="hljs-keyword">path</span>):
            remove_ignored_dirs(dirs)
            <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> files:
                <span class="hljs-keyword">if</span> filename <span class="hljs-keyword">in</span> ignoreFiles:
                    continue
                <span class="hljs-keyword">if</span> file_glob != <span class="hljs-keyword">None</span>:
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> fnmatch.fnmatch(filename, file_glob): continue
                yield os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(root, filename)

<span class="hljs-keyword">def</span> generate_aidl(<span class="hljs-keyword">self</span>):
    # support <span class="hljs-keyword">for</span> android remote interfaces <span class="hljs-keyword">in</span> platform/android/src
    framework_aidl = <span class="hljs-keyword">self</span>.sdk.platform_path(<span class="hljs-string">'framework.aidl'</span>)
    aidl_args = [<span class="hljs-keyword">self</span>.sdk.get_aidl(), <span class="hljs-string">'-p'</span> + framework_aidl, <span class="hljs-string">'-I'</span> + <span class="hljs-keyword">self</span>.project_src_dir, <span class="hljs-string">'-o'</span> + <span class="hljs-keyword">self</span>.project_gen_dir]
    <span class="hljs-keyword">for</span> aidl_file <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.recurse(<span class="hljs-keyword">self</span>.project_src_dir, <span class="hljs-string">'*.aidl'</span>):
        run.run(aidl_args + [aidl_file])

<span class="hljs-keyword">def</span> build_generated_classes(<span class="hljs-keyword">self</span>):
    src_list = []
    <span class="hljs-keyword">self</span>.module_jars = []

    class_delta = timedelta(seconds=<span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> java_file <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.recurse([<span class="hljs-keyword">self</span>.project_src_dir, <span class="hljs-keyword">self</span>.project_gen_dir], <span class="hljs-string">'*.java'</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.project_src_dir <span class="hljs-keyword">in</span> java_file:
            relative_path = java_file[<span class="hljs-keyword">len</span>(<span class="hljs-keyword">self</span>.project_src_dir)+<span class="hljs-number">1</span>:]
        <span class="hljs-keyword">else</span>:
            relative_path = java_file[<span class="hljs-keyword">len</span>(<span class="hljs-keyword">self</span>.project_gen_dir)+<span class="hljs-number">1</span>:]
        class_file = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.classes_dir, relative_path.<span class="hljs-keyword">replace</span>(<span class="hljs-string">'.java'</span>, <span class="hljs-string">'.class'</span>))

        <span class="hljs-keyword">if</span> Deltafy.needs_update(java_file, class_file) &gt; <span class="hljs-number">0</span>:
            # the <span class="hljs-keyword">file</span> <span class="hljs-keyword">list</span> <span class="hljs-keyword">file</span> still needs <span class="hljs-keyword">each</span> <span class="hljs-keyword">file</span> <span class="hljs-keyword">escaped</span> apparently
            debug(<span class="hljs-string">"adding %s to javac build list"</span> % java_file)
            src_list.append(<span class="hljs-string">'"%s"'</span> % java_file.<span class="hljs-keyword">replace</span>(<span class="hljs-string">"\\"</span>, <span class="hljs-string">"\\\\"</span>))

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(src_list) == <span class="hljs-number">0</span>:
        # <span class="hljs-keyword">No</span> sources <span class="hljs-keyword">are</span> older <span class="hljs-keyword">than</span> their classfile counterparts, we can <span class="hljs-keyword">skip</span> javac / dex
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    classpath = os.pathsep.<span class="hljs-keyword">join</span>([<span class="hljs-keyword">self</span>.android_jar, os.pathsep.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.android_jars)])

    project_module_dir = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.top_dir,<span class="hljs-string">'modules'</span>,<span class="hljs-string">'android'</span>)
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">module</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.modules:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">module</span>.jar == <span class="hljs-keyword">None</span>: continue
        <span class="hljs-keyword">self</span>.module_jars.append(<span class="hljs-keyword">module</span>.jar)
        classpath = os.pathsep.<span class="hljs-keyword">join</span>([classpath, <span class="hljs-keyword">module</span>.jar])
        module_lib = <span class="hljs-keyword">module</span>.get_resource(<span class="hljs-string">'lib'</span>)
        <span class="hljs-keyword">for</span> jar <span class="hljs-keyword">in</span> glob.glob(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(module_lib, <span class="hljs-string">'*.jar'</span>)):
            <span class="hljs-keyword">self</span>.module_jars.append(jar)
            classpath = os.pathsep.<span class="hljs-keyword">join</span>([classpath, jar])

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(<span class="hljs-keyword">self</span>.module_jars) &gt; <span class="hljs-number">0</span>:
        # kroll-apt.jar <span class="hljs-keyword">is</span> needed <span class="hljs-keyword">for</span> modules
        classpath = os.pathsep.<span class="hljs-keyword">join</span>([classpath, <span class="hljs-keyword">self</span>.kroll_apt_jar])

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.deploy_type != <span class="hljs-string">'production'</span>:
        classpath = os.pathsep.<span class="hljs-keyword">join</span>([classpath,
            os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.support_dir, <span class="hljs-string">'lib'</span>, <span class="hljs-string">'titanium-verify.jar'</span>),
            os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.support_dir, <span class="hljs-string">'lib'</span>, <span class="hljs-string">'titanium-debug.jar'</span>)])

    debug(<span class="hljs-string">"Building Java Sources: "</span> + <span class="hljs-string">" "</span>.<span class="hljs-keyword">join</span>(src_list))
    javac_command = [<span class="hljs-keyword">self</span>.javac, <span class="hljs-string">'-encoding'</span>, <span class="hljs-string">'utf8'</span>,
        <span class="hljs-string">'-classpath'</span>, classpath, <span class="hljs-string">'-d'</span>, <span class="hljs-keyword">self</span>.classes_dir, <span class="hljs-string">'-proc:none'</span>,
        <span class="hljs-string">'-sourcepath'</span>, <span class="hljs-keyword">self</span>.project_src_dir,
        <span class="hljs-string">'-sourcepath'</span>, <span class="hljs-keyword">self</span>.project_gen_dir]
    (src_list_osfile, src_list_filename) = tempfile.mkstemp()
    src_list_file = os.fdopen(src_list_osfile, <span class="hljs-string">'w'</span>)
    src_list_file.write(<span class="hljs-string">"\n"</span>.<span class="hljs-keyword">join</span>(src_list))
    src_list_file.<span class="hljs-keyword">close</span>()

    javac_command.append(<span class="hljs-string">'@'</span> + src_list_filename)
    (<span class="hljs-keyword">out</span>, err, javac_process) = run.run(javac_command, ignore_error=<span class="hljs-literal">True</span>, return_error=<span class="hljs-literal">True</span>, return_process=<span class="hljs-literal">True</span>)
    os.remove(src_list_filename)
    <span class="hljs-keyword">if</span> javac_process.returncode != <span class="hljs-number">0</span>:
        <span class="hljs-keyword">error</span>(<span class="hljs-string">"Error(s) compiling generated Java code"</span>)
        <span class="hljs-keyword">error</span>(<span class="hljs-keyword">str</span>(err))
        <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">def</span> create_unsigned_apk(<span class="hljs-keyword">self</span>, resources_zip_file):
    unsigned_apk = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.project_dir, <span class="hljs-string">'bin'</span>, <span class="hljs-string">'app-unsigned.apk'</span>)
    <span class="hljs-keyword">self</span>.apk_updated = <span class="hljs-literal">False</span>

    apk_modified = <span class="hljs-keyword">None</span>
    <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(unsigned_apk):
        apk_modified = Deltafy.get_modified_datetime(unsigned_apk)

    debug(<span class="hljs-string">"creating unsigned apk: "</span> + unsigned_apk)
    # copy existing resources <span class="hljs-keyword">into</span> the APK
    apk_zip = zipfile.ZipFile(unsigned_apk, <span class="hljs-string">'w'</span>, zipfile.ZIP_DEFLATED)

    <span class="hljs-keyword">def</span> skip_jar_path(<span class="hljs-keyword">path</span>):
        ext = os.<span class="hljs-keyword">path</span>.splitext(<span class="hljs-keyword">path</span>)[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">path</span>.endswith(<span class="hljs-string">'/'</span>): <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">path</span>.startswith(<span class="hljs-string">'META-INF/'</span>): <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">path</span>.<span class="hljs-keyword">split</span>(<span class="hljs-string">'/'</span>)[-<span class="hljs-number">1</span>].startswith(<span class="hljs-string">'.'</span>): <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">if</span> ext == <span class="hljs-string">'.class'</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'org/appcelerator/titanium/bindings'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">and</span> ext == <span class="hljs-string">'.json'</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> skip_js_file(<span class="hljs-keyword">path</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.compile_js <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span> <span class="hljs-keyword">and</span> \
            os.<span class="hljs-keyword">path</span>.splitext(<span class="hljs-keyword">path</span>)[<span class="hljs-number">1</span>] == <span class="hljs-string">'.js'</span>

    <span class="hljs-keyword">def</span> compression_type(<span class="hljs-keyword">path</span>):
        ext = os.<span class="hljs-keyword">path</span>.splitext(<span class="hljs-keyword">path</span>)[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">in</span> uncompressed_types:
            <span class="hljs-keyword">return</span> zipfile.ZIP_STORED
        <span class="hljs-keyword">return</span> zipfile.ZIP_DEFLATED

    <span class="hljs-keyword">def</span> zipinfo(<span class="hljs-keyword">path</span>):
        info = zipfile.ZipInfo(<span class="hljs-keyword">path</span>)
        info.compress_type = compression_type(<span class="hljs-keyword">path</span>)
        <span class="hljs-keyword">return</span> info

    <span class="hljs-keyword">def</span> is_modified(<span class="hljs-keyword">path</span>):
        <span class="hljs-keyword">return</span> apk_modified <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span> <span class="hljs-keyword">or</span> Deltafy.needs_update_timestamp(<span class="hljs-keyword">path</span>, apk_modified)

    <span class="hljs-keyword">def</span> zip_contains(zip, entry):
        try:
            zip.getinfo(entry)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">if</span> is_modified(resources_zip_file):
        <span class="hljs-keyword">self</span>.apk_updated = <span class="hljs-literal">True</span>
        resources_zip = zipfile.ZipFile(resources_zip_file)
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">in</span> resources_zip.namelist():
            <span class="hljs-keyword">if</span> skip_jar_path(<span class="hljs-keyword">path</span>) <span class="hljs-keyword">or</span> skip_js_file(<span class="hljs-keyword">path</span>): continue
            debug(<span class="hljs-string">"from resource zip =&gt; "</span> + <span class="hljs-keyword">path</span>)
            apk_zip.writestr(zipinfo(<span class="hljs-keyword">path</span>), resources_zip.<span class="hljs-keyword">read</span>(<span class="hljs-keyword">path</span>))
        resources_zip.<span class="hljs-keyword">close</span>()

    # <span class="hljs-keyword">add</span> classes.dex
    <span class="hljs-keyword">if</span> is_modified(<span class="hljs-keyword">self</span>.classes_dex) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> zip_contains(apk_zip, <span class="hljs-string">'classes.dex'</span>):
        apk_zip.write(<span class="hljs-keyword">self</span>.classes_dex, <span class="hljs-string">'classes.dex'</span>)

    # <span class="hljs-keyword">add</span> all <span class="hljs-keyword">resource</span> files <span class="hljs-keyword">from</span> the <span class="hljs-keyword">project</span>
    <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(<span class="hljs-keyword">self</span>.project_src_dir):
        remove_ignored_dirs(dirs)
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">f</span> <span class="hljs-keyword">in</span> files:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">f</span> <span class="hljs-keyword">in</span> ignoreFiles:
                continue
            <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.splitext(<span class="hljs-keyword">f</span>)[<span class="hljs-number">1</span>] != <span class="hljs-string">'.java'</span>:
                absolute_path = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(root, <span class="hljs-keyword">f</span>)
                relative_path = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(root[<span class="hljs-keyword">len</span>(<span class="hljs-keyword">self</span>.project_src_dir)+<span class="hljs-number">1</span>:], <span class="hljs-keyword">f</span>)
                <span class="hljs-keyword">if</span> is_modified(absolute_path) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> zip_contains(apk_zip, relative_path):
                    <span class="hljs-keyword">self</span>.apk_updated = <span class="hljs-literal">True</span>
                    debug(<span class="hljs-string">"resource file =&gt; "</span> + relative_path)
                    apk_zip.write(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(root, <span class="hljs-keyword">f</span>), relative_path, compression_type(<span class="hljs-keyword">f</span>))

    <span class="hljs-keyword">def</span> add_resource_jar(jar_file):
        jar = zipfile.ZipFile(jar_file)
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">in</span> jar.namelist():
            <span class="hljs-keyword">if</span> skip_jar_path(<span class="hljs-keyword">path</span>): continue
            debug(<span class="hljs-string">"from JAR %s =&gt; %s"</span> % (jar_file, <span class="hljs-keyword">path</span>))
            apk_zip.writestr(zipinfo(<span class="hljs-keyword">path</span>), jar.<span class="hljs-keyword">read</span>(<span class="hljs-keyword">path</span>))
        jar.<span class="hljs-keyword">close</span>()

    <span class="hljs-keyword">for</span> jar_file <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.module_jars:
        add_resource_jar(jar_file)
    <span class="hljs-keyword">for</span> jar_file <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.android_jars:
        add_resource_jar(jar_file)

    <span class="hljs-keyword">def</span> add_native_libs(libs_dir):
        <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(libs_dir):
            <span class="hljs-keyword">for</span> abi_dir <span class="hljs-keyword">in</span> os.listdir(libs_dir):
                libs_abi_dir = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(libs_dir, abi_dir)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.isdir(libs_abi_dir): continue
                <span class="hljs-keyword">for</span> <span class="hljs-keyword">file</span> <span class="hljs-keyword">in</span> os.listdir(libs_abi_dir):
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">file</span>.endswith(<span class="hljs-string">'.so'</span>):
                        native_lib = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(libs_abi_dir, <span class="hljs-keyword">file</span>)
                        path_in_zip = <span class="hljs-string">'/'</span>.<span class="hljs-keyword">join</span>([<span class="hljs-string">'lib'</span>, abi_dir, <span class="hljs-keyword">file</span>])
                        <span class="hljs-keyword">if</span> is_modified(native_lib) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> zip_contains(apk_zip, path_in_zip):
                            <span class="hljs-keyword">self</span>.apk_updated = <span class="hljs-literal">True</span>
                            debug(<span class="hljs-string">"installing native lib: %s"</span> % native_lib)
                            apk_zip.write(native_lib, path_in_zip)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.runtime == <span class="hljs-string">'v8'</span>:
        # <span class="hljs-keyword">add</span> <span class="hljs-keyword">any</span> <span class="hljs-keyword">native</span> libraries : libs<span class="hljs-comment">/**/</span>*.so -&gt; lib<span class="hljs-comment">/**/</span>*.so
        add_native_libs(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.project_dir, <span class="hljs-string">'libs'</span>))

        # <span class="hljs-keyword">add</span> <span class="hljs-keyword">module</span> <span class="hljs-keyword">native</span> libraries
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">module</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.modules:
            add_native_libs(<span class="hljs-keyword">module</span>.get_resource(<span class="hljs-string">'libs'</span>))

        # <span class="hljs-keyword">add</span> sdk runtime <span class="hljs-keyword">native</span> libraries
        debug(<span class="hljs-string">"installing native SDK libs"</span>)
        sdk_native_libs = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(template_dir, <span class="hljs-string">'native'</span>, <span class="hljs-string">'libs'</span>)
        apk_zip.write(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(sdk_native_libs, <span class="hljs-string">'armeabi'</span>, <span class="hljs-string">'libkroll-v8.so'</span>), <span class="hljs-string">'lib/armeabi/libkroll-v8.so'</span>)
        apk_zip.write(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(sdk_native_libs, <span class="hljs-string">'armeabi'</span>, <span class="hljs-string">'libstlport_shared.so'</span>), <span class="hljs-string">'lib/armeabi/libstlport_shared.so'</span>)
        apk_zip.write(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(sdk_native_libs, <span class="hljs-string">'armeabi-v7a'</span>, <span class="hljs-string">'libkroll-v8.so'</span>), <span class="hljs-string">'lib/armeabi-v7a/libkroll-v8.so'</span>)
        apk_zip.write(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(sdk_native_libs, <span class="hljs-string">'armeabi-v7a'</span>, <span class="hljs-string">'libstlport_shared.so'</span>), <span class="hljs-string">'lib/armeabi-v7a/libstlport_shared.so'</span>)
        <span class="hljs-keyword">self</span>.apk_updated = <span class="hljs-literal">True</span>

    apk_zip.<span class="hljs-keyword">close</span>()
    <span class="hljs-keyword">return</span> unsigned_apk

<span class="hljs-keyword">def</span> run_adb(<span class="hljs-keyword">self</span>, *args):
    command = [<span class="hljs-keyword">self</span>.sdk.get_adb()]
    command.extend(<span class="hljs-keyword">self</span>.device_args)
    command.extend(args)
    <span class="hljs-keyword">return</span> run.run(command)

<span class="hljs-keyword">def</span> package_and_deploy(<span class="hljs-keyword">self</span>):
    ap_ = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.project_dir, <span class="hljs-string">'bin'</span>, <span class="hljs-string">'app.ap_'</span>)

    # This <span class="hljs-keyword">is</span> <span class="hljs-keyword">only</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">check</span> <span class="hljs-keyword">if</span> this has been overridden <span class="hljs-keyword">in</span> production
    has_compile_js = <span class="hljs-keyword">self</span>.tiappxml.has_app_property(<span class="hljs-string">"ti.android.compilejs"</span>)
    compile_js = <span class="hljs-keyword">not</span> has_compile_js <span class="hljs-keyword">or</span> (has_compile_js <span class="hljs-keyword">and</span> \
        <span class="hljs-keyword">self</span>.tiappxml.to_bool(<span class="hljs-keyword">self</span>.tiappxml.get_app_property(<span class="hljs-string">'ti.android.compilejs'</span>)))

    pkg_assets_dir = <span class="hljs-keyword">self</span>.assets_dir
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.deploy_type == <span class="hljs-string">"production"</span> <span class="hljs-keyword">and</span> compile_js:
        non_js_assets = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.project_dir, <span class="hljs-string">'bin'</span>, <span class="hljs-string">'non-js-assets'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(non_js_assets):
            os.mkdir(non_js_assets)
        copy_all(<span class="hljs-keyword">self</span>.assets_dir, non_js_assets, ignore_exts=[<span class="hljs-string">'.js'</span>])
        pkg_assets_dir = non_js_assets

    run.run([<span class="hljs-keyword">self</span>.aapt, <span class="hljs-string">'package'</span>, <span class="hljs-string">'-f'</span>, <span class="hljs-string">'-M'</span>, <span class="hljs-string">'AndroidManifest.xml'</span>, <span class="hljs-string">'-A'</span>, pkg_assets_dir,
        <span class="hljs-string">'-S'</span>, <span class="hljs-string">'res'</span>, <span class="hljs-string">'-I'</span>, <span class="hljs-keyword">self</span>.android_jar, <span class="hljs-string">'-I'</span>, <span class="hljs-keyword">self</span>.titanium_jar, <span class="hljs-string">'-F'</span>, ap_], warning_regex=r<span class="hljs-string">'skipping'</span>)

    unsigned_apk = <span class="hljs-keyword">self</span>.create_unsigned_apk(ap_)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.dist_dir:
        app_apk = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.dist_dir, <span class="hljs-keyword">self</span>.<span class="hljs-keyword">name</span> + <span class="hljs-string">'.apk'</span>)    
    <span class="hljs-keyword">else</span>:
        app_apk = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.project_dir, <span class="hljs-string">'bin'</span>, <span class="hljs-string">'app.apk'</span>)    

    <span class="hljs-keyword">output</span> = run.run([<span class="hljs-keyword">self</span>.jarsigner, <span class="hljs-string">'-storepass'</span>, <span class="hljs-keyword">self</span>.keystore_pass, <span class="hljs-string">'-keystore'</span>, <span class="hljs-keyword">self</span>.keystore, <span class="hljs-string">'-signedjar'</span>, app_apk, unsigned_apk, <span class="hljs-keyword">self</span>.keystore_alias])
    run.check_output_for_error(<span class="hljs-keyword">output</span>, r<span class="hljs-string">'RuntimeException: (.*)'</span>, <span class="hljs-literal">True</span>)
    run.check_output_for_error(<span class="hljs-keyword">output</span>, r<span class="hljs-string">'^jarsigner: (.*)'</span>, <span class="hljs-literal">True</span>)

    # TODO <span class="hljs-keyword">Document</span> <span class="hljs-keyword">Exit</span> message
    #<span class="hljs-keyword">success</span> = re.findall(r<span class="hljs-string">'RuntimeException: (.*)'</span>, <span class="hljs-keyword">output</span>)
    #<span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(<span class="hljs-keyword">success</span>) &gt; <span class="hljs-number">0</span>:
    #    <span class="hljs-keyword">error</span>(<span class="hljs-keyword">success</span>[<span class="hljs-number">0</span>])
    #    <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)

    # zipalign <span class="hljs-keyword">to</span> align <span class="hljs-keyword">byte</span> boundaries
    zipalign = <span class="hljs-keyword">self</span>.sdk.get_zipalign()
    <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(app_apk+<span class="hljs-string">'z'</span>):
        os.remove(app_apk+<span class="hljs-string">'z'</span>)
    ALIGN_32_BIT = <span class="hljs-number">4</span>
    <span class="hljs-keyword">output</span> = run.run([zipalign, <span class="hljs-string">'-v'</span>, <span class="hljs-keyword">str</span>(ALIGN_32_BIT), app_apk, app_apk+<span class="hljs-string">'z'</span>])
    # TODO - <span class="hljs-keyword">Document</span> <span class="hljs-keyword">Exit</span> message
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">output</span> == <span class="hljs-keyword">None</span>:
        <span class="hljs-keyword">error</span>(<span class="hljs-string">"System Error while compiling Android classes.dex"</span>)
        <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">else</span>:
        os.unlink(app_apk)
        os.<span class="hljs-keyword">rename</span>(app_apk+<span class="hljs-string">'z'</span>,app_apk)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.dist_dir:
        <span class="hljs-keyword">self</span>.post_build()
        <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>()

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.build_only:
        <span class="hljs-keyword">return</span> (<span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>)

    <span class="hljs-keyword">out</span> = <span class="hljs-keyword">self</span>.run_adb(<span class="hljs-string">'get-state'</span>)
    #<span class="hljs-keyword">out</span> = subprocess.Popen([<span class="hljs-keyword">self</span>.sdk.get_adb(), <span class="hljs-keyword">self</span>.device_type_arg, <span class="hljs-string">'get-state'</span>], stderr=subprocess.<span class="hljs-keyword">PIPE</span>, stdout=subprocess.<span class="hljs-keyword">PIPE</span>).communicate()[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">out</span> = <span class="hljs-keyword">str</span>(<span class="hljs-keyword">out</span>).strip()

    # try a few times <span class="hljs-keyword">as</span> sometimes it fails waiting <span class="hljs-keyword">on</span> boot
    attempts = <span class="hljs-number">0</span>
    launched = <span class="hljs-literal">False</span>
    launch_failed = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">while</span> attempts &lt; <span class="hljs-number">5</span>:
        try:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">install</span>:
                <span class="hljs-keyword">self</span>.wait_for_device(<span class="hljs-string">'d'</span>)
                info(<span class="hljs-string">"Installing application on device"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">self</span>.wait_for_device(<span class="hljs-string">'e'</span>)
                info(<span class="hljs-string">"Installing application on emulator"</span>)

            <span class="hljs-keyword">output</span> = <span class="hljs-keyword">self</span>.run_adb(<span class="hljs-string">'install'</span>, <span class="hljs-string">'-r'</span>, app_apk)
            #<span class="hljs-keyword">output</span> = run.run(cmd)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">output</span> == <span class="hljs-keyword">None</span>:
                launch_failed = <span class="hljs-literal">True</span>
            elif <span class="hljs-string">"Failure"</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">output</span>:
                <span class="hljs-keyword">error</span>(<span class="hljs-string">"Failed installing %s: %s"</span> % (<span class="hljs-keyword">self</span>.app_id, <span class="hljs-keyword">output</span>))
                launch_failed = <span class="hljs-literal">True</span>
            elif <span class="hljs-keyword">not</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">install</span>:
                launched = <span class="hljs-literal">True</span>
            break
        <span class="hljs-keyword">except</span> <span class="hljs-keyword">Exception</span>, <span class="hljs-keyword">e</span>:
            <span class="hljs-keyword">error</span>(<span class="hljs-keyword">e</span>)
            <span class="hljs-keyword">time</span>.<span class="hljs-keyword">sleep</span>(<span class="hljs-number">3</span>)
            attempts+=<span class="hljs-number">1</span>

    <span class="hljs-keyword">return</span> (launched, launch_failed)

<span class="hljs-keyword">def</span> run_app(<span class="hljs-keyword">self</span>):
    info(<span class="hljs-string">"Launching application ... %s"</span> % <span class="hljs-keyword">self</span>.<span class="hljs-keyword">name</span>)
    <span class="hljs-keyword">output</span> = <span class="hljs-keyword">self</span>.run_adb(<span class="hljs-string">'shell'</span>, <span class="hljs-string">'am'</span>, <span class="hljs-string">'start'</span>,
        <span class="hljs-string">'-a'</span>, <span class="hljs-string">'android.intent.action.MAIN'</span>,
        <span class="hljs-string">'-c'</span>,<span class="hljs-string">'android.intent.category.LAUNCHER'</span>,
        <span class="hljs-string">'-n'</span>, <span class="hljs-string">'%s/.%sActivity'</span> % (<span class="hljs-keyword">self</span>.app_id , <span class="hljs-keyword">self</span>.classname))
    <span class="hljs-keyword">trace</span>(<span class="hljs-string">"Launch output: %s"</span> % <span class="hljs-keyword">output</span>)

<span class="hljs-keyword">def</span> wait_for_sdcard(<span class="hljs-keyword">self</span>):
    info(<span class="hljs-string">"Waiting for SDCard to become available.."</span>)
    waited = <span class="hljs-number">0</span>
    max_wait = <span class="hljs-number">60</span>
    <span class="hljs-keyword">while</span> waited &lt; max_wait:
        <span class="hljs-keyword">output</span> = <span class="hljs-keyword">self</span>.run_adb(<span class="hljs-string">'shell'</span>, <span class="hljs-string">'mount'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">output</span> != <span class="hljs-keyword">None</span>:
            mount_points = <span class="hljs-keyword">output</span>.splitlines()
            <span class="hljs-keyword">for</span> mount_point <span class="hljs-keyword">in</span> mount_points:
                tokens = mount_point.<span class="hljs-keyword">split</span>()
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(tokens) &lt; <span class="hljs-number">2</span>: continue
                mount_path = tokens[<span class="hljs-number">1</span>]
                <span class="hljs-keyword">if</span> mount_path <span class="hljs-keyword">in</span> [<span class="hljs-string">'/sdcard'</span>, <span class="hljs-string">'/mnt/sdcard'</span>]:
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">error</span>(<span class="hljs-string">"Error checking for SDCard using 'mount'"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">time</span>.<span class="hljs-keyword">sleep</span>(<span class="hljs-number">1</span>)
        waited += <span class="hljs-number">1</span>

    <span class="hljs-keyword">error</span>(<span class="hljs-string">"Timed out waiting for SDCard to become available (%ds)"</span> % max_wait)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>


<span class="hljs-keyword">def</span> push_deploy_json(<span class="hljs-keyword">self</span>):
    deploy_data = {
        <span class="hljs-string">"debuggerEnabled"</span>: <span class="hljs-keyword">self</span>.debugger_host != <span class="hljs-keyword">None</span>,
        <span class="hljs-string">"debuggerPort"</span>: <span class="hljs-keyword">self</span>.debugger_port,
        <span class="hljs-string">"fastdevPort"</span>: <span class="hljs-keyword">self</span>.fastdev_port
    }
    deploy_json = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.project_dir, <span class="hljs-string">'bin'</span>, <span class="hljs-string">'deploy.json'</span>)
    <span class="hljs-keyword">open</span>(deploy_json, <span class="hljs-string">'w+'</span>).write(simplejson.dumps(deploy_data))
    sdcard_available = <span class="hljs-keyword">self</span>.wait_for_sdcard()
    <span class="hljs-keyword">if</span> sdcard_available:
        <span class="hljs-keyword">self</span>.run_adb(<span class="hljs-string">'shell'</span>, <span class="hljs-string">'mkdir /sdcard/%s || echo'</span> % <span class="hljs-keyword">self</span>.app_id)
        <span class="hljs-keyword">self</span>.run_adb(<span class="hljs-string">'push'</span>, deploy_json, <span class="hljs-string">'/sdcard/%s/deploy.json'</span> % <span class="hljs-keyword">self</span>.app_id)
    os.unlink(deploy_json)

<span class="hljs-keyword">def</span> verify_fastdev(<span class="hljs-keyword">self</span>):
    lock_file = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.top_dir, <span class="hljs-string">'.fastdev.lock'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> fastdev.is_running(<span class="hljs-keyword">self</span>.top_dir):
        <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(lock_file):
            os.unlink(lock_file)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">data</span> = simplejson.loads(<span class="hljs-keyword">open</span>(lock_file, <span class="hljs-string">'r'</span>).<span class="hljs-keyword">read</span>())
        <span class="hljs-keyword">self</span>.fastdev_port = <span class="hljs-keyword">data</span>[<span class="hljs-string">"port"</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">def</span> fastdev_kill_app(<span class="hljs-keyword">self</span>):
    lock_file = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.top_dir, <span class="hljs-string">".fastdev.lock"</span>)
    <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(lock_file):
        <span class="hljs-keyword">class</span> Options(<span class="hljs-keyword">object</span>): pass
        options = Options()
        options.lock_file = lock_file

        try:
            <span class="hljs-keyword">return</span> fastdev.kill_app(<span class="hljs-keyword">self</span>.top_dir, options)
        <span class="hljs-keyword">except</span> <span class="hljs-keyword">Exception</span>, <span class="hljs-keyword">e</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> merge_internal_module_resources(<span class="hljs-keyword">self</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">self</span>.android_jars:
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">for</span> jar <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.android_jars:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(jar):
            continue
        res_zip = jar[:-<span class="hljs-number">4</span>] + <span class="hljs-string">'.res.zip'</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(res_zip):
            continue
        res_zip_file = zipfile.ZipFile(res_zip, <span class="hljs-string">"r"</span>)
        try:
            zip_extractall(res_zip_file, <span class="hljs-keyword">self</span>.project_dir)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">raise</span>
        finally:
            res_zip_file.<span class="hljs-keyword">close</span>()

<span class="hljs-keyword">def</span> build_and_run(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">install</span>, avd_id, keystore=<span class="hljs-keyword">None</span>, keystore_pass=<span class="hljs-string">'tirocks'</span>, keystore_alias=<span class="hljs-string">'tidev'</span>, dist_dir=<span class="hljs-keyword">None</span>, build_only=<span class="hljs-literal">False</span>, device_args=<span class="hljs-keyword">None</span>, debugger_host=<span class="hljs-keyword">None</span>):
    deploy_type = <span class="hljs-string">'development'</span>
    <span class="hljs-keyword">self</span>.build_only = build_only
    <span class="hljs-keyword">self</span>.device_args = device_args
    <span class="hljs-keyword">self</span>.postbuild_modules = []
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">install</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.device_args == <span class="hljs-keyword">None</span>:
            <span class="hljs-keyword">self</span>.device_args = [<span class="hljs-string">'-d'</span>]
        <span class="hljs-keyword">if</span> keystore == <span class="hljs-keyword">None</span>:
            deploy_type = <span class="hljs-string">'test'</span>
        <span class="hljs-keyword">else</span>:
            deploy_type = <span class="hljs-string">'production'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.device_args == <span class="hljs-keyword">None</span>:
        <span class="hljs-keyword">self</span>.device_args = [<span class="hljs-string">'-e'</span>]

    <span class="hljs-keyword">self</span>.deploy_type = deploy_type
    (java_failed, java_status) = prereq.check_java()
    <span class="hljs-keyword">if</span> java_failed:
        <span class="hljs-keyword">error</span>(java_status)
        <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)

    # attempt <span class="hljs-keyword">to</span> <span class="hljs-keyword">load</span> <span class="hljs-keyword">any</span> compiler plugins
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">len</span>(<span class="hljs-keyword">self</span>.tiappxml.properties[<span class="hljs-string">'plugins'</span>]) &gt; <span class="hljs-number">0</span>:
        titanium_dir = os.<span class="hljs-keyword">path</span>.abspath(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(template_dir,<span class="hljs-string">'..'</span>,<span class="hljs-string">'..'</span>,<span class="hljs-string">'..'</span>,<span class="hljs-string">'..'</span>))
        local_compiler_dir = os.<span class="hljs-keyword">path</span>.abspath(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.top_dir,<span class="hljs-string">'plugins'</span>))
        tp_compiler_dir = os.<span class="hljs-keyword">path</span>.abspath(os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(titanium_dir,<span class="hljs-string">'plugins'</span>))
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(tp_compiler_dir) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(local_compiler_dir):
            <span class="hljs-keyword">error</span>(<span class="hljs-string">"Build Failed (Missing plugins directory)"</span>)
            <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)
        compiler_config = {
            <span class="hljs-string">'platform'</span>:<span class="hljs-string">'android'</span>,
            <span class="hljs-string">'tiapp'</span>:<span class="hljs-keyword">self</span>.tiappxml,
            <span class="hljs-string">'project_dir'</span>:<span class="hljs-keyword">self</span>.top_dir,
            <span class="hljs-string">'titanium_dir'</span>:titanium_dir,
            <span class="hljs-string">'appid'</span>:<span class="hljs-keyword">self</span>.app_id,
            <span class="hljs-string">'template_dir'</span>:template_dir,
            <span class="hljs-string">'project_name'</span>:<span class="hljs-keyword">self</span>.<span class="hljs-keyword">name</span>,
            <span class="hljs-string">'command'</span>:<span class="hljs-keyword">self</span>.command,
            <span class="hljs-string">'build_dir'</span>:s.project_dir,
            <span class="hljs-string">'app_name'</span>:<span class="hljs-keyword">self</span>.<span class="hljs-keyword">name</span>,
            <span class="hljs-string">'android_builder'</span>:<span class="hljs-keyword">self</span>,
            <span class="hljs-string">'deploy_type'</span>:deploy_type,
            <span class="hljs-string">'dist_dir'</span>:dist_dir,
            <span class="hljs-string">'logger'</span>:<span class="hljs-keyword">log</span>
        }
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">plugin</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.tiappxml.properties[<span class="hljs-string">'plugins'</span>]:
            local_plugin_file = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(local_compiler_dir,<span class="hljs-keyword">plugin</span>[<span class="hljs-string">'name'</span>],<span class="hljs-string">'plugin.py'</span>)
            plugin_file = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(tp_compiler_dir,<span class="hljs-keyword">plugin</span>[<span class="hljs-string">'name'</span>],<span class="hljs-keyword">plugin</span>[<span class="hljs-string">'version'</span>],<span class="hljs-string">'plugin.py'</span>)
            info(<span class="hljs-string">"plugin=%s"</span> % plugin_file)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(local_plugin_file) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(plugin_file):
                <span class="hljs-keyword">error</span>(<span class="hljs-string">"Build Failed (Missing plugin for %s)"</span> % <span class="hljs-keyword">plugin</span>[<span class="hljs-string">'name'</span>])
                <span class="hljs-keyword">sys</span>.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)
            info(<span class="hljs-string">"Detected compiler plugin: %s/%s"</span> % (<span class="hljs-keyword">plugin</span>[<span class="hljs-string">'name'</span>],<span class="hljs-keyword">plugin</span>[<span class="hljs-string">'version'</span>]))
            code_path = plugin_file
            <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(local_plugin_file):    
                code_path = local_plugin_file
            compiler_config[<span class="hljs-string">'plugin'</span>]=<span class="hljs-keyword">plugin</span>
            fin = <span class="hljs-keyword">open</span>(code_path, <span class="hljs-string">'rb'</span>)
            <span class="hljs-keyword">m</span> = hashlib.<span class="hljs-keyword">md5</span>()
            <span class="hljs-keyword">m</span>.<span class="hljs-keyword">update</span>(<span class="hljs-keyword">open</span>(code_path,<span class="hljs-string">'rb'</span>).<span class="hljs-keyword">read</span>()) 
            code_hash = <span class="hljs-keyword">m</span>.hexdigest()
            <span class="hljs-keyword">p</span> = imp.load_source(code_hash, code_path, fin)
            module_functions = dict(inspect.getmembers(<span class="hljs-keyword">p</span>, inspect.isfunction))
            <span class="hljs-keyword">if</span> module_functions.has_key(<span class="hljs-string">'postbuild'</span>):
                debug(<span class="hljs-string">"plugin contains a postbuild function. Will execute after project is built and packaged"</span>)
                <span class="hljs-keyword">self</span>.postbuild_modules.append((<span class="hljs-keyword">plugin</span>[<span class="hljs-string">'name'</span>], <span class="hljs-keyword">p</span>))
            <span class="hljs-keyword">p</span>.compile(compiler_config)
            fin.<span class="hljs-keyword">close</span>()


    # <span class="hljs-keyword">in</span> Windows, <span class="hljs-keyword">if</span> the adb <span class="hljs-keyword">server</span> isn<span class="hljs-string">'t running, calling "adb devices"
    # will fork off a new adb server, and cause a lock-up when we 
    # try to pipe the process'</span> stdout/stderr. the workaround <span class="hljs-keyword">is</span> 
    # <span class="hljs-keyword">to</span> simply <span class="hljs-keyword">call</span> adb <span class="hljs-keyword">start</span>-<span class="hljs-keyword">server</span> here, <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> care about
    # the <span class="hljs-keyword">return</span> code / pipes. (this <span class="hljs-keyword">is</span> harmless <span class="hljs-keyword">if</span> adb <span class="hljs-keyword">is</span> already running)
    # <span class="hljs-comment">-- thanks to Bill Dawson for the workaround</span>
    <span class="hljs-keyword">if</span> platform.<span class="hljs-keyword">system</span>() == <span class="hljs-string">"Windows"</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> build_only:
        run.run([<span class="hljs-keyword">self</span>.sdk.get_adb(), <span class="hljs-string">"start-server"</span>], <span class="hljs-literal">True</span>, ignore_output=<span class="hljs-literal">True</span>)

    ti_version_file = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.support_dir, <span class="hljs-string">'..'</span>, <span class="hljs-string">'version.txt'</span>)
    <span class="hljs-keyword">if</span> os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">exists</span>(ti_version_file):
        ti_version_info = read_properties(<span class="hljs-keyword">open</span>(ti_version_file, <span class="hljs-string">'r'</span>), <span class="hljs-string">'='</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ti_version_info <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span> <span class="hljs-keyword">and</span> <span class="hljs-string">'version'</span> <span class="hljs-keyword">in</span> ti_version_info:
            ti_version_string = <span class="hljs-string">'Titanium SDK version: %s'</span> % ti_version_info[<span class="hljs-string">'version'</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-string">'timestamp'</span> <span class="hljs-keyword">in</span> ti_version_info <span class="hljs-keyword">or</span> <span class="hljs-string">'githash'</span> <span class="hljs-keyword">in</span> ti_version_info:
                ti_version_string += <span class="hljs-string">' ('</span>
                <span class="hljs-keyword">if</span> <span class="hljs-string">'timestamp'</span> <span class="hljs-keyword">in</span> ti_version_info:
                    ti_version_string += <span class="hljs-string">'%s'</span> % ti_version_info[<span class="hljs-string">'timestamp'</span>]
                <span class="hljs-keyword">if</span> <span class="hljs-string">'githash'</span> <span class="hljs-keyword">in</span> ti_version_info:
                    ti_version_string += <span class="hljs-string">' %s'</span> % ti_version_info[<span class="hljs-string">'githash'</span>]
                ti_version_string += <span class="hljs-string">')'</span>

            info(ti_version_string)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> build_only:
        <span class="hljs-keyword">if</span> deploy_type == <span class="hljs-string">'development'</span>:
            <span class="hljs-keyword">self</span>.wait_for_device(<span class="hljs-string">'e'</span>)
        elif deploy_type == <span class="hljs-string">'test'</span>:
            <span class="hljs-keyword">self</span>.wait_for_device(<span class="hljs-string">'d'</span>)

    <span class="hljs-keyword">self</span>.<span class="hljs-keyword">install</span> = <span class="hljs-keyword">install</span>
    <span class="hljs-keyword">self</span>.dist_dir = dist_dir
    <span class="hljs-keyword">self</span>.aapt = <span class="hljs-keyword">self</span>.sdk.get_aapt()
    <span class="hljs-keyword">self</span>.android_jar = <span class="hljs-keyword">self</span>.sdk.get_android_jar()
    <span class="hljs-keyword">self</span>.titanium_jar = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.support_dir,<span class="hljs-string">'titanium.jar'</span>)
    <span class="hljs-keyword">self</span>.kroll_apt_jar = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.support_dir, <span class="hljs-string">'kroll-apt.jar'</span>)

    dx = <span class="hljs-keyword">self</span>.sdk.get_dx()
    <span class="hljs-keyword">self</span>.apkbuilder = <span class="hljs-keyword">self</span>.sdk.get_apkbuilder()
    <span class="hljs-keyword">self</span>.sdcard_resources = <span class="hljs-string">'/sdcard/Ti.debug/%s/Resources'</span> % <span class="hljs-keyword">self</span>.app_id

    <span class="hljs-keyword">self</span>.resources_installed = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> deploy_type == <span class="hljs-string">"production"</span>:
        <span class="hljs-keyword">self</span>.app_installed = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">self</span>.app_installed = <span class="hljs-keyword">not</span> build_only <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.is_app_installed()
        debug(<span class="hljs-string">"%s installed? %s"</span> % (<span class="hljs-keyword">self</span>.app_id, <span class="hljs-keyword">self</span>.app_installed))

        #<span class="hljs-keyword">self</span>.resources_installed = <span class="hljs-keyword">not</span> build_only <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.are_resources_installed()
        #debug(<span class="hljs-string">"%s resources installed? %s"</span> % (<span class="hljs-keyword">self</span>.app_id, <span class="hljs-keyword">self</span>.resources_installed))

    <span class="hljs-keyword">if</span> keystore == <span class="hljs-keyword">None</span>:
        keystore = os.<span class="hljs-keyword">path</span>.<span class="hljs-keyword">join</span>(<span class="hljs-keyword">self</span>.support_dir,<span class="hljs-string">'dev_keystore'</span>)

    <span class="hljs-keyword">self</span>.keystore = keystore
    <span class="hljs-keyword">self</span>.keystore_pass = keystore_pass
    <span class="hljs-keyword">self</span>.ke</span>
</code></pre>
						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="April 10th 2012, 2:59:25 pm">April 10th 2012</span>
								by <span class='authorname'>Jens Eckervogt</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-235673" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-235695">
				
						<section>
							<p>WHY DOES IT NOT WORK BECAUSE IT GETS ERROR :( STOP DEAL ME MY NICE DEVELOPMENT TIME :( I am very mad for Titanium Developers :( Bedcause it does not work python gets crazy :( I can not understand How do i fix :(( I need use with Android App :(( I miss Android Develeopments : I am very mad because it has problem :( i have been got 5 hours i am trying agian and again and again :( it does not get success. That is a problem :( I am sad :(</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="April 10th 2012, 5:42:14 pm">April 10th 2012</span>
								by <span class='authorname'>Jens Eckervogt</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-235695" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-235699">
				
						<section>
							<p>Wich version of Python? 2.72 or 3.x??</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="April 10th 2012, 6:51:56 pm">April 10th 2012</span>
								by <span class='authorname'>Jens Eckervogt</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-235699" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-235762">
				
						<section>
							<p>Yeah you are right. I have been forgotten about distirbuted installing python packages and Java Home works fine why does Titanium Mobile need only 1.6 Version :&#x2F; I am using only 1.7 :( But same trick of compablitated version of Java Development Kit :) Thank you… NOw works fine.. I am only noob into pro :)</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="April 11th 2012, 10:06:00 am">April 11th 2012</span>
								by <span class='authorname'>Jens Eckervogt</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-235762" rel="permalink">permalink</a>
							</div>

							<h5>2 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Great, Happy coding.</p>
</p>
										<div class="author">
											&mdash; commented <span title="April 11th 2012, 10:18:23 am">April 11th 2012</span>
											by <span class='authorname'>Gaurang Chhatbar</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Thanks. But For Desktop Application does not show from Javascript frameworks? How do i see If i am using javascript like createButtom under Desktop. But It does not show… How do i fix? Or did i make worng?</p>
</p>
										<div class="author">
											&mdash; commented <span title="April 11th 2012, 5:48:29 pm">April 11th 2012</span>
											by <span class='authorname'>Jens Eckervogt</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-245644">
				
						<section>
							<p>Hello guys, i am very mad because developers have delete function &quot;Titanium Desktop&quot; Why does Titanium Studio not need ? I want develop with Titanium again :(</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="August 19th 2012, 4:48:52 pm">August 19th 2012</span>
								by <span class='authorname'>Jens Eckervogt</span><br>
								<a class="icon-bg icon-link" href="question/135168/problem-with-java-jre-and-jdk-wont-work-now---error-loading---same-worng-bit-version#answer-245644" rel="permalink">permalink</a>
							</div>

							<h5>0 Comments</h5>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
