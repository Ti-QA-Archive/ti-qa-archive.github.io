<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>FBSession:  should only be used from a single thread titanium error » Community Questions &amp; Answers </title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>FBSession:  should only be used from a single thread titanium error</h1>
		</header>
		<section>
			<p>Hello,</p>
<p>I am using Titanium 3.1.0 GA SDK with facebook module. I am building a facebook mobile app and configured the app in facebook.</p>
<p>My app.js looks like this:</p>
<p><code>fb = require(&amp;#39;facebook&amp;#39;);
fb.appid = &amp;#39;1231231231231232&amp;#39;;
fb.permissions = [&amp;#39;publish_stream&amp;#39;, &amp;#39;read_stream&amp;#39;];
fb.forceDialogAuth = false;</code></p>
<p>This is what happens…I install the app on my iphone 5 which runs on iOS 6.1.3 and after installing the app, I try to launch the app from facebook app on my mobile and I get the error - </p>
<h1 id="fbsession-should-only-be-used-from-a-single-thread-titanium-error">FBSession:  should only be used from a single thread titanium error</h1>
<p>But when If i try to launch the app by itself  (independently and not from facebook) then it works fine.</p>
<p>There is no logout for facebook in my app.</p>
<p>There are no references to the module anywhere else.</p>
<p>Any ideas…anyone?</p>
<p>Thanks,<br>KP</p>

		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="June 24th 2013, 3:43:21 pm">June 24th 2013</span>
				by <span class='authorname'>Tirumal Kumar Pappu</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>facebook fbsession</span></li>
					
				</ul>
			

			<section>
				<h5>1 Comment</h5>
				
					<ul class="comments">
					
						<li class="comment">
							<div><p>I have the same problem have you found a solution to this yet? I have it working only if I don&#39;t close the app. Let&#39;s say I force quit the app then try to launch it from the notification, then I get the error. If I delete the app and reinstall without launching it yet, I launch first from the notification and it works. Lets say I log into my app then press my home button to minimize it, then I launch from the notification then it works. As long as you set fb = require(&#39;facebook&#39;): before launching from a notification then it works. It seems to me that the old FBSession doesn&#39;t exit when the app closes or force quit. Only solution I can think of is try to log out when the app closes witch is what I&#39;m trying to figure out now.</p>
</div>
							<div class="author">
								&mdash; commented <span title="February 16th 2014, 11:56:01 am">February 16th 2014</span>
								by <span class='authorname'>Steven Robichaud</span>
							</div>
						</li>
					
					</ul>
				
			</section>
		</footer>
		<aside class="vote-box">
			<div class="score"><span>1</span> Vote</div>
			<div class="answers"><span>6</span> Answers</div>
		</aside>
	</div>

	<hr>

	<h3>6 Answers</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article id="answer-275371">
				
						<section>
							<p>Hi Steven. Just saw your video and now I understand your issue and I could reproduce it (for that I needed to compile to device). I have not have the time to test further, but if the issue is not happening when on read permissions are requested, it looks like it is a bug on the module when no &#39;single sign on&#39; is used to authenticate (which happens when you include write permissions. The FB 3 module has a reauthorize method, which can be used afterwards to enable the&#39; write to feed&#39; functionality. Perhaps segregating your auth permissions in different auth and reauth calls is a good workaround. In a few days I&#39;ll have the time to look further. If you force quit the app and restart it the issue doesn&#39;t happen. I can verify that it also doesn&#39;t happen if you open it from an url on a different app, such as the App Store. I&#39;d like also to inspect the URL FB uses to launch the app (if there is anything special there).<br>Good luck with your issue. I&#39;ll come back to this thread in a week when I resume work on FB stuff.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 18th 2014, 9:27:50 am">February 18th 2014</span>
								by <span class='authorname'>Richard Lustemberg</span><br>
								<a class="icon-bg icon-link" href="question/154019/fbsession-should-only-be-used-from-a-single-thread-titanium-error.html#answer-275371" rel="permalink">permalink</a>
							</div>

							<h5>1 Comment</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>I get the same error with read_stream as well. I had previously changed it because I was using the old login method since I was using pause&#x2F;resumed events to login and out of Facebook. If you do a force quit it will trigger the pause event. If the app crashes then it will trigger no events so I would get this error again. The odds of a user actually getting this message could be low though but knowing about the bug and knowing people could experience it bothers me.</p>
<p>It&#39;s got something to do with how it logs on. I&#39;m using SSO right now and I&#39;m pretty sure it starts a FBSession with fb423423432:&#x2F;&#x2F;authenticate…. also includes the requestID&#39;s, request token… If I launch from the custom URL I get a URL like Test:&#x2F;&#x2F;requestId=454354354  </p>
<p>That&#39;s what I use to get the Argument url</p>
<pre><code class="hljs"><span class="hljs-tag">Ti</span><span class="hljs-class">.App</span><span class="hljs-class">.getArguments</span>()<span class="hljs-class">.url</span>
</code></pre></p>
										<div class="author">
											&mdash; commented <span title="February 18th 2014, 10:12:00 am">February 18th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>1</span> Vote</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-275375">
				
						<section>
							<p>Ok so I found the problem in the Facebook module it self</p>
<p>original code from FacebookModule.m</p>
<pre><code class="hljs">-(<span class="hljs-built_in">BOOL</span>)handleRelaunch
{
    <span class="hljs-built_in">NSDictionary</span> *launchOptions = [[TiApp app] launchOptions];
    <span class="hljs-keyword">if</span> (launchOptions!=<span class="hljs-literal">nil</span>)
    {
        <span class="hljs-built_in">NSString</span> *urlString = [launchOptions objectForKey:<span class="hljs-string">@"url"</span>];
        <span class="hljs-keyword">if</span> (urlString!=<span class="hljs-literal">nil</span> &amp;&amp; [urlString hasPrefix:<span class="hljs-string">@"fb"</span>])
        {
            <span class="hljs-comment">// if we're resuming under the same URL, we need to ignore</span>
            <span class="hljs-keyword">if</span> (url!=<span class="hljs-literal">nil</span> &amp;&amp; [urlString isEqualToString:url])
            {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
            }
            RELEASE_TO_NIL(url);
            url = [urlString <span class="hljs-keyword">copy</span>];
            [facebook handleOpenURL:[<span class="hljs-built_in">NSURL</span> URLWithString:urlString]];
            <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;
}
</code></pre><p>This is the code that gets called every time you use the module and when it first starts. </p>
<p>This line is the line witch starts the FBSession process </p>
<pre><code class="hljs"> <span class="hljs-collection">[facebook handleOpenURL:<span class="hljs-collection">[NSURL URLWithString:urlString]</span>]</span><span class="hljs-comment">;</span>
</code></pre><p>notice here we are checking the the url matches the url the app just received through the argument the poblem is when you force quit the app url witch is a global variable in the FacebookModule class gets erased so when we restart the app after a force quit or crash, url is now nil and it try&#39;s to start another process</p>
<pre><code class="hljs"><span class="hljs-keyword">if</span> (url!=<span class="hljs-literal">nil</span> &amp;&amp; [urlString isEqualToString:url])
            {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
            }
</code></pre><p>Personally I don&#39;t need SSO when launching from the iOS notification. I can let the user handle login when he actually get to the app so I did the following witch will not do any Facebook login if the url came from a notification. This still launches my app. Note you could modify this bit of code to whatever liking you want.</p>
<pre><code class="hljs">-(<span class="hljs-built_in">BOOL</span>)handleRelaunch
{
    <span class="hljs-built_in">NSDictionary</span> *launchOptions = [[TiApp app] launchOptions];
    <span class="hljs-keyword">if</span> (launchOptions!=<span class="hljs-literal">nil</span>)
    {
        <span class="hljs-built_in">NSString</span> *urlString = [launchOptions objectForKey:<span class="hljs-string">@"url"</span>];

            <span class="hljs-keyword">if</span> ([urlString rangeOfString:<span class="hljs-string">@"notification"</span>]<span class="hljs-variable">.location</span>==<span class="hljs-built_in">NSNotFound</span>)
            {
                <span class="hljs-comment">//string not found</span>
            }
            <span class="hljs-keyword">else</span>
            {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
            }

    <span class="hljs-keyword">if</span> (urlString!=<span class="hljs-literal">nil</span> &amp;&amp; [urlString hasPrefix:<span class="hljs-string">@"fb"</span>])
    {
        <span class="hljs-comment">// if we're resuming under the same URL, we need to ignore</span>
        <span class="hljs-keyword">if</span> (url!=<span class="hljs-literal">nil</span> &amp;&amp; [urlString isEqualToString:url])
        {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
        }
            RELEASE_TO_NIL(url);
            url = [urlString <span class="hljs-keyword">copy</span>];
            [facebook handleOpenURL:[<span class="hljs-built_in">NSURL</span> URLWithString:urlString]];
            <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;
}
</code></pre>
						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 18th 2014, 11:43:31 am">February 18th 2014</span>
								by <span class='authorname'>Steven Robichaud</span><br>
								<a class="icon-bg icon-link" href="question/154019/fbsession-should-only-be-used-from-a-single-thread-titanium-error.html#answer-275375" rel="permalink">permalink</a>
							</div>

							<h5>2 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>If the OP is curious for a fix for newsfeed it&#39;s the same thing add </p>
<pre><code class="hljs"> <span class="hljs-keyword">if</span> ([urlString rangeOfString:<span class="hljs-string">@"fromNewsFeed"</span>]<span class="hljs-variable">.location</span>==<span class="hljs-built_in">NSNotFound</span>)
{
 <span class="hljs-comment">//string not found</span>
}
<span class="hljs-keyword">else</span>
{
<span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}
</code></pre><p>notice I&#39;m looking for fromNewsFeed in the url we receive from the deep link</p>
<p>inside your Javascript code this would be the data you pass to posting the news feed</p>
<pre><code class="hljs">var data = {
<span class="hljs-string">link :</span> <span class="hljs-string">"https:/www.yourwebpage.com/index.php?fromNewsFeed=true&amp;app_request_type=user_to_user&amp;request_ids[]="</span> + requestID,
<span class="hljs-string">name :</span> <span class="hljs-string">"Some Name"</span>,
<span class="hljs-string">message :</span> <span class="hljs-string">"Your Message"</span>,
<span class="hljs-string">caption :</span> <span class="hljs-string">"Some Caption"</span>,
<span class="hljs-string">picture :</span> <span class="hljs-string">"http://www.yourimage.com"</span>,
<span class="hljs-string">description :</span> <span class="hljs-string">"Your description"</span>
};
</code></pre><p>Notice I added ?fromNewsFeed=true this is called POST and would not affect anything your URL is doing. You can add it to any URL you wish to use just add it to the end. ? states the start of the post variables so the first one is always a ?. Then &amp; separates different variables so at the end of this url I could do + &quot;&amp;someOtherVariable=SomeOtherValue&amp;someMoreVariables=MoreValues&quot;</p>
<p>Your app also receives this data and can be access by calling</p>
<pre><code class="hljs"><span class="hljs-variable"><span class="hljs-keyword">var</span> url</span> = Ti.App.getArguments().url;
</code></pre></p>
										<div class="author">
											&mdash; commented <span title="February 20th 2014, 10:15:14 am">February 20th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>In the end I came back to this 7 month later. Great job Steven! Perhaps a beginning for a pull request…</p>
</p>
										<div class="author">
											&mdash; commented <span title="September 3rd 2014, 6:47:34 pm">September 3rd 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>1</span> Vote</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-264769">
				
						<section>
							<p>I had the same problem myself.  Luckily your end users wont have the icon in their App as it&#39;s a link to your developer account.  The error only occurs if you are already logged into Facebook via the App</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="June 24th 2013, 4:00:14 pm">June 24th 2013</span>
								by <span class='authorname'>Nick Milner</span><br>
								<a class="icon-bg icon-link" href="question/154019/fbsession-should-only-be-used-from-a-single-thread-titanium-error.html#answer-264769" rel="permalink">permalink</a>
							</div>

							<h5>8 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Thanks, Nick.</p>
<p>I get your first part of the answer that the the link is tied to my developer Account. But i did not get your second part of the clarification.</p>
<p>The end users on facebook should be able to launch my app from their news feed (that&#39;s how I redirect them to launch my app) and if app is installed  the first time, it will open the app and that&#39;s how I get the error. If the user has used the app directly for few times, then I am not getting the error ,the error occurs only after I install the app and click on the facebook news feed and its redirected to the app and i get the error. Any ideas or can you clarify on the second part of your solution?</p>
</p>
										<div class="author">
											&mdash; commented <span title="June 24th 2013, 4:08:37 pm">June 24th 2013</span>
											by <span class='authorname'>Tirumal Kumar Pappu</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Ah - I didn&#39;t know about that entry point into the app, i had just seen the link inside the FB app to mine and it wasnt appearing for anyone else.  </p>
<p>When I launch my app from inside the FB one, I only got that error IF i have already logged into FB from within my app, else it is fine.</p>
<p>Sorry, its not really a solution but an observation that it didnt seem to matter, but now you&#39;ve mentioned the other entry points into the app (from news feed) i&#39;m not so happy either. I&#39;ll take a peek at the source and see if there&#39;s anything obvious that can fix this…</p>
</p>
										<div class="author">
											&mdash; commented <span title="June 24th 2013, 4:19:08 pm">June 24th 2013</span>
											by <span class='authorname'>Nick Milner</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>btw - Are you getting the iOS integrated sign on to work or is it linking to the webView to login ?  I only ask because I notice your permissions are;</p>
<pre><code class="hljs"><span class="hljs-atom">fb</span>.<span class="hljs-atom">permissions</span> = [<span class="hljs-string">'publish_stream'</span>, <span class="hljs-string">'read_stream'</span>];
</code></pre><p>and according to the docs, iOS integrated sign on will only work for READ permission requests  (and not publish_stream)</p>
</p>
										<div class="author">
											&mdash; commented <span title="June 24th 2013, 4:22:11 pm">June 24th 2013</span>
											by <span class='authorname'>Nick Milner</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>… you need to use the reauthorize() method to get WRITE permissions..</p>
</p>
										<div class="author">
											&mdash; commented <span title="June 24th 2013, 4:23:29 pm">June 24th 2013</span>
											by <span class='authorname'>Nick Milner</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I am using the iOS integrated sign on to work.</p>
<p>I changed it to only<br><code>fb.permissions = [&amp;#39;read_stream&amp;#39;];</code>, I still get the error upon launching the app from fb news feed.</p>
</p>
										<div class="author">
											&mdash; commented <span title="June 24th 2013, 4:37:21 pm">June 24th 2013</span>
											by <span class='authorname'>Tirumal Kumar Pappu</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Have you got this sorted?</p>
</p>
										<div class="author">
											&mdash; commented <span title="July 2nd 2013, 2:14:58 pm">July 2nd 2013</span>
											by <span class='authorname'>Richard Harrysson</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I&#39;m seeing this issue also when launching my app from the Facebook app.  Anyone found a solution yet?</p>
</p>
										<div class="author">
											&mdash; commented <span title="September 4th 2013, 7:58:01 pm">September 4th 2013</span>
											by <span class='authorname'>j ro</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I got the same error as you. Previously to this I had my app launching from a mobile website instead of the deep linking facebook offers through the setting witch I think is what we are both using. Before I could launch my app no problem. Now that I&#39;m using the feature from Facebook I got my app to launch but it gives me this error when calling any Facebook module call. If my app is logged in and go to my main screen then facebook and launch the app without the login it works. I&#39;m a bit confused here lol</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 15th 2014, 8:50:20 am">February 15th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-268659">
				
						<section>
							<p>It looks related to <a href="https:&#x2F;&#x2F;jira.appcelerator.org&#x2F;browse&#x2F;TC-2904">https:&#x2F;&#x2F;jira.appcelerator.org&#x2F;browse&#x2F;TC-2904</a> . I was having the same issue when calling Facebook methods after login. I used the built in FB method and the issue stopped. It might be that both the module and the built in sdk objects get called. The workaround I used was to call the built in Ti.Facebook methods</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="September 17th 2013, 10:32:41 am">September 17th 2013</span>
								by <span class='authorname'>Richard Lustemberg</span><br>
								<a class="icon-bg icon-link" href="question/154019/fbsession-should-only-be-used-from-a-single-thread-titanium-error.html#answer-268659" rel="permalink">permalink</a>
							</div>

							<h5>1 Comment</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>I still get the error. I made sure that my app is not calling module and the sdk but I still get the error. Not sure how I could resolve this…</p>
</p>
										<div class="author">
											&mdash; commented <span title="October 7th 2013, 5:05:36 pm">October 7th 2013</span>
											by <span class='authorname'>Tirumal Kumar Pappu</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-275285">
				
						<section>
							<p>In the end I figured out long ago why I had the issue and I know I&#39;m remembering to share it.<br>Although I had updated my FB code to call the module, I had forgotten to update code in an event listener which was still calling the built in app. The result was calling the FB sdk from 2 threads.<br>So, just make sure that there&#39;s nothing left pointing to the built in FB module.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 16th 2014, 3:33:54 pm">February 16th 2014</span>
								by <span class='authorname'>Richard Lustemberg</span><br>
								<a class="icon-bg icon-link" href="question/154019/fbsession-should-only-be-used-from-a-single-thread-titanium-error.html#answer-275285" rel="permalink">permalink</a>
							</div>

							<h5>1 Comment</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>&#39;was still calling the built in app&#39; . I meant the built in module, the one in the Ti.Facebook namespace.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 16th 2014, 3:34:26 pm">February 16th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-275287">
				
						<section>
							<p>Ok I finally got this working. Might be a bug in the module itself but I&#39;m not even sure where to find the source for it. </p>
<pre><code class="hljs"><span class="hljs-atom">fb</span>.<span class="hljs-atom">permissions</span> = [<span class="hljs-string">'publish_stream'</span>, <span class="hljs-string">'read_stream'</span>];

<span class="hljs-atom">shoulde</span> <span class="hljs-atom">be</span> 

<span class="hljs-atom">fb</span>.<span class="hljs-atom">permissions</span> = [<span class="hljs-string">'read_stream'</span>];
</code></pre><p>this will avoid the your app popping up the facebook app(witch is like a pause&#x2F;resumed so it causes conflict) for authentication and will have a pop up for the user if the app is not authenticated. With publish_stream, it caused more problems for me.</p>
<p>Next what I did is I added an eventListener for pause and resumed. If you force quit from inside the app it still triggers a pause event and when it closes it also triggers a pause event, so it&#39;s pretty much guaranteed.</p>
<pre><code class="hljs">Titanium.App.addEventListener(<span class="hljs-string">'pause'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    fb.logout();        
});

Titanium.App.addEventListener(<span class="hljs-string">'resumed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    fb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'facebook'</span>);
    fb.appid = <span class="hljs-string">'1231231231231232'</span>;
    fb.permissions = [<span class="hljs-string">'read_stream'</span>];    
    fb.authorize();        
});
</code></pre><p>This works for me and the logout and login runs in the background so you don&#39;t even notice it. This is the only fix I could come up with at the moment.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="February 16th 2014, 3:58:45 pm">February 16th 2014</span>
								by <span class='authorname'>Steven Robichaud</span><br>
								<a class="icon-bg icon-link" href="question/154019/fbsession-should-only-be-used-from-a-single-thread-titanium-error.html#answer-275287" rel="permalink">permalink</a>
							</div>

							<h5>17 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Also note this is not a great fix but it works until I can look at the facebook module source code and fix the bug. I might even convert my entire app into native code.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 8:45:32 am">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Hi Steven: I am using both publish_stream and read_stream without any issues. As you&#39;ve noticed, including more than read permissions makes the app bypass IOS built in FB login and launches the old style auth, either using the app or a web view. When it launches the FB app to authenticate, by no means the FB triggers the single thread exception as it is running under a different process, outside of the Titanium app scope. I would do a text search looking for FB from different namespaces. I&#39;ve made that error myself when cutting and pasting code from an old library of mine.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 9:44:57 am">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I tried putting the code in my main and just opening the very first window in my app. So in my main I have the fb = require… and the authorize so it logs in when I start my app. That way I know I&#39;m not in any listeners or anything since I ran main and opened a window that does not call any facebook calls. I then force quit my app then try to launch it from the iOS notification and I get this error. If I left me app running then press the home button instead of a force quit then it works. I&#39;m using Facebook module 3.1.1 and Titanium SDK 3.2.0, I&#39;m working on a commercial project right now so I must figure this out soon lol I&#39;m looking at the Facebook source right now and I&#39;m trying to understand what&#39;s happening when I launch from a notification vs when I run the app from the icon on my device. I can say for sure that problem is 2 FBSessions are being called, when you force quit the app.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 9:59:13 am">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Could you post the code you have on your fb events (login , logout) callbacks?</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 11:23:48 am">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Sorry I can&#39;t share my code since I signed an agreement with the people I&#39;m working for. But you can make a basic program that opens a single window and try it your self. This error have absolutely nothing to do with my code since you will get this error even with the simplest program with no logic in it. My guess is that when I force quit the app FBSession still exists. This could be a Titanium error or even a Facebook error I&#39;m not sure since I never used it with native code.</p>
<p>Just so we are clear I&#39;m not running this anywhere else then my main, and I completely understand your point with eventListeners but I don&#39;t have any running. I had a problem with not clearing them in the past and I decided to put an alert in it and I experienced multiple listeners because I wasn&#39;t removing it and adding more and more as my program would run.</p>
<p>In main before opening anything I put </p>
<pre><code class="hljs">   var fb = require('facebook')<span class="hljs-comment">;</span>
    fb.appid = '<span class="hljs-number">1231231231231</span>232'<span class="hljs-comment">;</span>
    fb.permissions = ['read_stream']<span class="hljs-comment">;   </span>
    fb.authorize()<span class="hljs-comment">;</span>
</code></pre><p>So only my main knows about the variable fb. I don&#39;t use it or call it anywhere else in my program. I then force quit the app(Pressing the home button twice then slide the app upwards then it&#39;s gone), then launch from the iOS notification(Single Sign On) and I get the error. If I don&#39;t force quit my app, it works no problem. If the app crashes then you will get that error when trying to log on form the notification as well. I&#39;m making sure this thing is dummy proof, many users know how to force quit their apps so I want to make sure it won&#39;t mess with anything else. Again the above code is the first thing that happens in my main no other instance anywhere else(Obviously I&#39;m calling them but no on the first window witch I open, I double checked to make sure also.)</p>
<p>Also note I just removed Single Sign On from the Facebook app and added a Website instead. Under Mobile Site URL I added webpage I made quick and I decided to use a custom URL instead. The custom URL </p>
<p>inside a php file.</p>
<pre><code class="hljs">location.href = <span class="hljs-string">"Test://user?requestID="</span>+<span class="hljs-property">id</span>;
</code></pre><p>Test is my custom URL scheme name then I&#39;m sending the requestID that came from that specific notification, I got functioning code for it.</p>
<p>Note I would rather have it the other way so it links to the app store if the app is not installed.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 1:34:02 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>The problem seems to be Single Sign On</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 1:35:29 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>but do you have any callback registered for FB events?</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 1:51:12 pm">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>and BTW, just let me know which SDK you are using, just in case. I&#39;ll try to reproduce your issue</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 1:54:28 pm">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>sorry, I just saw it is 3.2.0</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 1:56:07 pm">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Nope no callbacks.  And yea SDK 3.2.0 and Facebook module 3.1.1. I&#39;m now logging in with the facebook login dialog and still get the same error. I might build a native app to see if I get the same issues. I know Objective C but I&#39;ve never used the Facebook SDK before, so I can&#39;t say if the problem would be on both.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 2:09:11 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>SDK 3.2.1</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 2:36:25 pm">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I&#39;ve just run the following with no issues:</p>
<pre><code class="hljs"><span class="hljs-comment">/*
* Single Window Application Template:
* A basic starting point for your application.  Mostly a blank canvas.
*
* In app.js, we generally take care of a few things:
* - Bootstrap the application with any data we need
* - Check for dependencies like device type, platform version or network connection
* - Require and open our top-level UI component
*
*/</span>

<span class="hljs-comment">//bootstrap and check dependencies</span>
<span class="hljs-keyword">if</span> (Ti.version &lt; <span class="hljs-number">1.8</span>) {
    alert(<span class="hljs-string">'Sorry - this application template requires Titanium Mobile SDK 1.8 or later'</span>);
}

<span class="hljs-comment">// This is a single context application with multiple windows in a stack</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> fb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'facebook'</span>);
    fb.appid = <span class="hljs-string">'123123412341234'</span>;
    fb.permissions = [<span class="hljs-string">'read_stream'</span>, <span class="hljs-string">'publish_stream'</span>];
    fb.addEventListener (<span class="hljs-string">'login'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>)</span>{
        Ti.API.info (<span class="hljs-built_in">JSON</span>.stringify(e));
    });

    <span class="hljs-comment">//render appropriate components based on the platform and form factor</span>
    <span class="hljs-keyword">var</span> osname = Ti.Platform.osname, version = Ti.Platform.version, height = Ti.Platform.displayCaps.platformHeight, width = Ti.Platform.displayCaps.platformWidth;

    <span class="hljs-comment">//considering tablets to have width over 720px and height over 600px - you can define your own</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkTablet</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> platform = Ti.Platform.osname;

        <span class="hljs-keyword">switch</span> (platform) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'ipad'</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'android'</span>:
                <span class="hljs-keyword">var</span> psc = Ti.Platform.Android.physicalSizeCategory;
                <span class="hljs-keyword">var</span> tiAndroid = Ti.Platform.Android;
                <span class="hljs-keyword">return</span> psc === tiAndroid.PHYSICAL_SIZE_CATEGORY_LARGE || psc === tiAndroid.PHYSICAL_SIZE_CATEGORY_XLARGE;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.min(Ti.Platform.displayCaps.platformHeight, Ti.Platform.displayCaps.platformWidth) &gt;= <span class="hljs-number">400</span>
        }
    }

    <span class="hljs-keyword">var</span> isTablet = checkTablet();
    <span class="hljs-built_in">console</span>.log(isTablet);

    <span class="hljs-keyword">var</span> Window;
    <span class="hljs-keyword">if</span> (isTablet) {
        Window = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ui/tablet/ApplicationWindow'</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Android uses platform-specific properties to create windows.</span>
        <span class="hljs-comment">// All other platforms follow a similar UI pattern.</span>
        <span class="hljs-keyword">if</span> (osname === <span class="hljs-string">'android'</span>) {
            Window = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ui/handheld/android/ApplicationWindow'</span>);
        } <span class="hljs-keyword">else</span> {
            Window = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ui/handheld/ApplicationWindow'</span>);
        }
    }

    <span class="hljs-keyword">var</span> win = <span class="hljs-keyword">new</span> Window;
    win.addEventListener(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        fb.authorize();
    });

    win.open();
})();
</code></pre><p>Basically, a single window test application (of course the fb app id is dummy). FB app id is also in Tiapp.xml</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 2:36:45 pm">February 17th 2014</span>
											by <span class='authorname'>Richard Lustemberg</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Did you force quit the app then reopen it through a facebook mobile notification?</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 2:48:18 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I&#39;m making a video right now to show you the steps. I made a new project and just put </p>
<pre><code class="hljs">
<span class="hljs-keyword">var</span> fb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'facebook'</span>);
fb.appid = <span class="hljs-string">'617986091581862'</span>;
fb.permissions = [<span class="hljs-string">'read_stream'</span>, <span class="hljs-string">'publish_stream'</span>];
fb.authorize();
</code></pre><p>at the top of the app.js then I login then force quit, then launch from iOS notification then I get the error. I tested this with native iOS code and I don&#39;t get this error.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 3:17:37 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Here we go I made a video witch shows me running 2 different programs. I&#39;m using same bundle ID and App ID in both. Note I only get the error after a force quit. If I would reopen the app then close it(Not a force quit) then it would work. With native code it seems to work correctly.</p>
<p>http:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=50R6OqPZsWo&amp;feature=youtu.be</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 3:44:57 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Just realized it&#39;s only half my video sorry here&#39;s me running native code no problem http:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=kuxndIO8j1A&amp;feature=youtu.be</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 17th 2014, 4:14:48 pm">February 17th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I guess there is no fix to this? Thanks for the help anyways must be a bug inside the module.</p>
</p>
										<div class="author">
											&mdash; commented <span title="February 18th 2014, 8:43:53 am">February 18th 2014</span>
											by <span class='authorname'>Steven Robichaud</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
