<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>alloy compiler conditional code not work » Community Questions &amp; Answers » Appcelerator Developer Center</title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>alloy compiler conditional code not work</h1>
		</header>
		<section>
			<p>it&#39;s very strange today that when I go back to Mac to build app for iPhone with Ti3.1.2GA and Alloy 1.2, the conditional code does not work any more. Let me have some sample code here:</p>
<pre><code class="hljs"><span class="hljs-keyword">if</span>(OS_ANDROID) {
    <span class="hljs-keyword">return</span> wrong code.
}
</code></pre><p>I build for iOS, but this line gives error in result.</p>
<p>I tried the code below:</p>
<pre><code class="hljs"><span class="hljs-keyword">if</span>(OS_MOBILEWEB) {
    <span class="hljs-keyword">return</span> wrong code.
}
</code></pre><p>and below:</p>
<pre><code class="hljs"><span class="hljs-keyword">if</span>(OS_IOS) {
    <span class="hljs-keyword">return</span> wrong code.
}
</code></pre><p>all of them report errors during compiling.</p>
<p>Looks like alloy compiler does not accept the conditional code anymore. Any clues?</p>

		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="August 17th 2013, 9:14:04 am">August 17th 2013</span>
				by <span class='authorname'>Mason Zhang</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>alloy</span></li>
					
						<li><span class='tagname'>ios</span></li>
					
				</ul>
			

			<section>
				<h5>4 Comments</h5>
				
					<ul class="comments">
					
						<li class="comment">
							<div><p>what&#39;s inside the conditions ?</p>
</div>
							<div class="author">
								&mdash; commented <span title="August 17th 2013, 9:32:13 am">August 17th 2013</span>
								by <span class='authorname'>Hani Hamadeh</span>
							</div>
						</li>
					
						<li class="comment">
							<div><p>You&#39;re going to need to elaborate, like provide some code or test case because I&#39;m not seeing the same behavior, nor do I think anyone else is.</p>
</div>
							<div class="author">
								&mdash; commented <span title="August 17th 2013, 10:13:43 am">August 17th 2013</span>
								by <span class='authorname'>Tony Lukasavage</span>
							</div>
						</li>
					
						<li class="comment">
							<div><p>I logged a bug here: https:&#x2F;&#x2F;jira.appcelerator.org&#x2F;browse&#x2F;TC-2765, and put the code there. Normally it works, but with the code I provided, you&#39;ll see the defect.</p>
</div>
							<div class="author">
								&mdash; commented <span title="August 17th 2013, 11:01:54 am">August 17th 2013</span>
								by <span class='authorname'>Mason Zhang</span>
							</div>
						</li>
					
						<li class="comment">
							<div><p>Please check my answer below and see if that resolves your issues. Putting function declarations inside blocks is a bad practice in javascript, so it would be good to fix the structure of your code yo avoid these types of issues in the future.</p>
</div>
							<div class="author">
								&mdash; commented <span title="August 17th 2013, 11:09:37 am">August 17th 2013</span>
								by <span class='authorname'>Tony Lukasavage</span>
							</div>
						</li>
					
					</ul>
				
			</section>
		</footer>
		<aside class="vote-box vote-box-answered">
			<div class="score"><span>0</span> Votes</div>
			<div class="answers"><span>2</span> Answers</div>
		</aside>
	</div>

	<hr>

	<h3>2 Answers</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article class="accepted-answer" id="answer-267311">
						<header>
							<h2><span class="icon-bg icon-check-1"></span>Accepted Answer</h2>
						</header>
				
						<section>
							<p>Just to be certain, I slightly modified the basic alloy app and it responds to the compiler conditionals exactly as expected. Try this and see if it works. If it does, then there&#39;s some other issues with your code and we&#39;re going to need an actual test case that reproduces the issue. </p>
<h3 id="index-xml">index.xml</h3>
<pre><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">Alloy</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">Window</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">Label</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"label"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"doClick"</span>&gt;</span>Hello, World<span class="hljs-tag">&lt;/<span class="hljs-title">Label</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">Window</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">Alloy</span>&gt;</span>
</code></pre><h3 id="index-js">index.js</h3>
<pre><code class="hljs">function doClick(e) {
    var <span class="hljs-keyword">text</span> = <span class="hljs-string">'none'</span>;
       <span class="hljs-keyword">if</span> (OS_IOS) {
           <span class="hljs-keyword">text</span> = <span class="hljs-string">'ios'</span>;
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (OS_ANDROID) {
           <span class="hljs-keyword">text</span> = <span class="hljs-string">'android'</span>;
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (OS_MOBILEWEB) {
           <span class="hljs-keyword">text</span> = <span class="hljs-string">'mobileweb'</span>;
       }
       alert(<span class="hljs-keyword">text</span>);
}

<span class="hljs-variable">$.</span>index.open();
</code></pre><h3 id="index-tss">index.tss</h3>
<pre><code class="hljs">"<span class="hljs-class">.container</span>": <span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">backgroundColor</span>:<span class="hljs-value"><span class="hljs-string">"white"</span>
</span></span></span>},
"<span class="hljs-tag">Label</span>": <span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">width</span>:<span class="hljs-value"> Ti.UI.SIZE,
    height: Ti.UI.SIZE,
    color: <span class="hljs-string">"#000"</span>
</span></span></span>}
</code></pre>
						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="August 17th 2013, 10:37:02 am">August 17th 2013</span>
								by <span class='authorname'>Tony Lukasavage</span><br>
								<a class="icon-bg icon-link" href="question/156082/alloy-compiler-conditional-code-not-work#answer-267311" rel="permalink">permalink</a>
							</div>

							<h5>7 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Mason, why are you executing code like in your answer? What&#39;s the point of the timeouts with a zero delay? Also, you are always leaving behind multiple definitions of the functions, so weird behavior is to be expected.</p>
<p>So here&#39;s what&#39;s happening. When your code gets compiled, a number of operations are being performed, one of which is the hoisting of functions declarations and the handling of the compiler conditionals. Unfortunately, hoisting function declarations currently happens first, which means that your functions are being hoisted out of the conditionals you set, so all of them are saved. </p>
<p>You can however work around this with function expressions. Let&#39;s take your code and modify to work as expected:</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> aaa, bbb;

<span class="hljs-keyword">if</span>(OS_ANDROID) {
    aaa = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        Ti.API.info(<span class="hljs-string">'android aaa'</span>);
    }
}
<span class="hljs-keyword">else</span> {
    bbb = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        Ti.API.info(<span class="hljs-string">'not android bbb'</span>);
    }
}

<span class="hljs-keyword">if</span>(OS_IOS) {
    aaa = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        Ti.API.info(<span class="hljs-string">'ios aaa'</span>);
    }
}
<span class="hljs-keyword">else</span> {
    bbb = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        Ti.API.info(<span class="hljs-string">'not ios bbb'</span>);
    }
}

$.index.open();

aaa();
bbb();
</code></pre><p>Running this you can see that only the functions you expect get generated and all works well. FWIW, I saw this problem in 1.1.3 as well, so I don&#39;t think it&#39;s a regression.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 11:01:52 am">August 17th 2013</span>
											by <span class='authorname'>Tony Lukasavage</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Hi Tony, Thanks a bunch for your help! Right, it&#39;s not a regression. I got this issue in 1.1.2 and then upgrade to 1.2.0 and see if it fixed or not. And your workaround works on my project! excellent!!!</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 11:09:11 am">August 17th 2013</span>
											by <span class='authorname'>Mason Zhang</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>mark the answer as best so anyone else encountering a similar issue knows the answer was found</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 11:10:31 am">August 17th 2013</span>
											by <span class='authorname'>Tony Lukasavage</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Marked the answer as the best. Just to answer your previous question. Actually the code I pasted there is just the code I try to reproduce the defect. The really code is much more complicated. I found some unexpected behavior on iOS, and then spent 1 day for troubleshooting, finally I found that the conditional code does not work, so some logic for Android is applied to iOS. The code just silently passed all the check but will give wrong result during runtime.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 11:19:01 am">August 17th 2013</span>
											by <span class='authorname'>Mason Zhang</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>To be clear, the conditionals work just fine. The issue is because function declarations are hoisted to the top of the current functional scope. Putting them in a conditional block does not contain them to that block&#39;s scope, just like variables in Javascript. So what is happening is that the functions were being hoisted out of the conditionals before the conditionals were ever evaluated.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 11:27:05 am">August 17th 2013</span>
											by <span class='authorname'>Tony Lukasavage</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I took some time to change all the function definition to function expression. But got other issues. Here are sample code:</p>
<p>still on Mac OS X 10.7, iOS simulator, TI 3.1.2.GA, Alloy 1.2.0</p>
<p>view.xml</p>
<pre><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">View</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"buttonGroup"</span> <span class="hljs-attribute">platform</span>=<span class="hljs-value">"ios"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">Button</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"startButton"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"start"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">Button</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"interruptButton"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"interrupt"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">View</span>&gt;</span>
</code></pre><p>controller.js</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> interrupt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">debugger</span>;
}
</code></pre><p>This function will be executed twice when click the button.</p>
<p>but if I change the code back to this way: </p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">interrupt</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">debugger</span>;
}
</code></pre><p>This works fine.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 18th 2013, 3:17:04 am">August 18th 2013</span>
											by <span class='authorname'>Mason Zhang</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Finally it should be still the conditional code issue:</p>
<p>my view.xml</p>
<pre><code class="hljs">        <span class="hljs-tag">&lt;<span class="hljs-title">View</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"timerView"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">View</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"buttonGroup"</span> <span class="hljs-attribute">platform</span>=<span class="hljs-value">"android"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">ImageView</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"startButton"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"start"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">ImageView</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"interruptButton"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"interrupt"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">View</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">View</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"buttonGroup"</span> <span class="hljs-attribute">platform</span>=<span class="hljs-value">"ios"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">Button</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"startButton"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"start"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">Button</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"interruptButton"</span> <span class="hljs-attribute">onClick</span>=<span class="hljs-value">"interrupt"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">View</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">View</span>&gt;</span>
</code></pre><p>the generated code:</p>
<pre><code class="hljs">    <span class="hljs-constant">__defers[</span><span class="hljs-string">"$.__views.startButton!click!start"</span>] &amp;&amp; <span class="hljs-variable">$.</span><span class="hljs-constant">__views.</span>startButton.addEventListener(<span class="hljs-string">"click"</span>, start);
    <span class="hljs-constant">__defers[</span><span class="hljs-string">"$.__views.interruptButton!click!interrupt"</span>] &amp;&amp; <span class="hljs-variable">$.</span><span class="hljs-constant">__views.</span>interruptButton.addEventListener(<span class="hljs-string">"click"</span>, interrupt);
    <span class="hljs-constant">__defers[</span><span class="hljs-string">"$.__views.startButton!click!start"</span>] &amp;&amp; <span class="hljs-variable">$.</span><span class="hljs-constant">__views.</span>startButton.addEventListener(<span class="hljs-string">"click"</span>, start);
    <span class="hljs-constant">__defers[</span><span class="hljs-string">"$.__views.interruptButton!click!interrupt"</span>] &amp;&amp; <span class="hljs-variable">$.</span><span class="hljs-constant">__views.</span>interruptButton.addEventListener(<span class="hljs-string">"click"</span>, interrupt);
</code></pre><p>The defers are duplicated. So if I use function definition, then everything works because defer will not be used. But if I use function expression, then there will be trouble.</p>
<p>I still think this kind of issue is too bad for developers, the code just silently wrong.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 18th 2013, 3:25:34 am">August 18th 2013</span>
											by <span class='authorname'>Mason Zhang</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box vote-box-answered">
							<div class="score"><span>2</span> Votes</div>
						</aside>
					</article>
				</li>
			
				<li class="answer">
				
					<article id="answer-267310">
				
						<section>
							<p>alloy code:</p>
<pre><code class="hljs">setTimeout(aaa, <span class="hljs-number">0</span>);
setTimeout(bbb, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span>(OS_ANDROID) {
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaa</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">'android aaa'</span>);
    }
}
<span class="hljs-keyword">else</span> {
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bbb</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">'not android bbb'</span>);
    }
}

<span class="hljs-keyword">if</span>(OS_IOS) {
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaa</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">'ios aaa'</span>);
    }
}
<span class="hljs-keyword">else</span> {
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bbb</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">'not ios bbb'</span>);
    }
}
</code></pre><p>compiled code:</p>
<pre><code class="hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaa</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">"android aaa"</span>);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bbb</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">"not android bbb"</span>);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaa</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">"ios aaa"</span>);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bbb</span><span class="hljs-params">()</span> </span>{
        Ti.API.info(<span class="hljs-string">"not ios bbb"</span>);
    }
    setTimeout(aaa, <span class="hljs-number">0</span>);
    setTimeout(bbb, <span class="hljs-number">0</span>);
</code></pre><p>But if I put setTimeout(aaa,0) inside the if(OS_…), then everything is fine. I&#39;m sure it&#39;s a defect in alloy.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="August 17th 2013, 10:35:48 am">August 17th 2013</span>
								by <span class='authorname'>Mason Zhang</span><br>
								<a class="icon-bg icon-link" href="question/156082/alloy-compiler-conditional-code-not-work#answer-267310" rel="permalink">permalink</a>
							</div>

							<h5>2 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>please use comments to keep the conversation in order, don&#39;t add answers. Also, see my answer.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 10:42:24 am">August 17th 2013</span>
											by <span class='authorname'>Tony Lukasavage</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Thanks a lot. Will do.</p>
</p>
										<div class="author">
											&mdash; commented <span title="August 17th 2013, 11:14:05 am">August 17th 2013</span>
											by <span class='authorname'>Mason Zhang</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
