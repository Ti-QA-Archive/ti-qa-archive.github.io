<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>Trigger Geolocation Twice Android » Community Questions &amp; Answers » Appcelerator Developer Center</title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>Trigger Geolocation Twice Android</h1>
		</header>
		<section>
			<p>Hi.</p>
<p>I have a HUGE (at least for me … ) problem with to get the geolocation to trigger twice in the same view&#x2F;window.</p>
<p>My app has a star and a stop button.</p>
<p>When you start to drive you press start and then… u guessed it, you press stop.</p>
<p>I want to get the current position cords for each press. lat + long</p>
<p>I get it when i press start but when i press stop it just wont work.</p>
<p>I get (if i&#39;m lucky a lat that is COMPLETELY of the charts and no long.</p>
<p>This is the code part where i get the cords.</p>
<p>I hope that anyone can point me in the direction and&#x2F;or spot my misstake.</p>
<p>The buttons are in a view where to start button is visible and then hides when pressed and the Stop button will be visible.</p>
<p>When the stop button is pressed it will hide and the start will come back in the view.</p>
<p>Anyway here is my code.</p>
<p>If you would like to see full code pls let me know.</p>
<pre><code class="hljs">btnStart.addEventListener('click', function() {


       Ti.Geolocation.frequency=1<span class="hljs-comment">;</span>

        Titanium.Geolocation.accuracy = Titanium.Geolocation.ACCURACY_HIGH<span class="hljs-comment">;</span>
        Titanium.Geolocation.distanceFilter = 1<span class="hljs-comment">;</span>
        //Ti.Geolocation.purpose = "Drivin Mode"<span class="hljs-comment">;</span>
        Titanium.Geolocation.getCurrentPosition(function(e) {

            lat1 = e.coords.latitude<span class="hljs-comment">;</span>
            log1 = e.coords.longitude<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
        alert(lat1 +'  '+ log1)<span class="hljs-comment">;</span>

        btnStart.hide()<span class="hljs-comment">;</span>
        view.add(btnStop)<span class="hljs-comment">;</span>


})<span class="hljs-comment">;</span>

btnStop.addEventListener('click', function() {


    Ti.Geolocation.frequency=1<span class="hljs-comment">;</span>

    Titanium.Geolocation.accuracy = Titanium.Geolocation.ACCURACY_HIGH<span class="hljs-comment">;</span>
    Titanium.Geolocation.distanceFilter = 1<span class="hljs-comment">;</span>
    //Ti.Geolocation.purpose = "Drivin Mode"<span class="hljs-comment">;</span>
    Titanium.Geolocation.getCurrentPosition(function(e) {

        lat2 = e.coords.latitude<span class="hljs-comment">;</span>
        log2 = e.coords.longitude<span class="hljs-comment">;</span>

    alert(lat2 + '  '+ log2)<span class="hljs-comment">;</span>
           btnStart.show()<span class="hljs-comment">;</span>
           view.remove(btnStop)<span class="hljs-comment">;</span>

})<span class="hljs-comment">;</span>
</code></pre><p>Pls help before i loose my mind here….</p>
<p>Thanx</p>

		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="November 27th 2012, 9:18:20 pm">November 27th 2012</span>
				by <span class='authorname'>Richard Harrysson</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>android</span></li>
					
						<li><span class='tagname'>geolocation</span></li>
					
						<li><span class='tagname'>mobile</span></li>
					
				</ul>
			

			<section>
				<h5>1 Comment</h5>
				
					<ul class="comments">
					
						<li class="comment">
							<div><p>Hello,<br>which SDK are you using? Is this happening on the device or the emulator? Which version of Android OS?</p>
<p>Best,<br>M</p>
</div>
							<div class="author">
								&mdash; commented <span title="November 27th 2012, 9:21:36 pm">November 27th 2012</span>
								by <span class='authorname'>Mauro Parra</span>
							</div>
						</li>
					
					</ul>
				
			</section>
		</footer>
		<aside class="vote-box">
			<div class="score"><span>0</span> Votes</div>
			<div class="answers"><span>1</span> Answer</div>
		</aside>
	</div>

	<hr>

	<h3>1 Answer</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article id="answer-251802">
				
						<section>
							<p>Hi</p>
<p>Your problem is due to the method you are using to determine the current location.<a href="http:&#x2F;&#x2F;docs.appcelerator.com&#x2F;titanium&#x2F;latest&#x2F;#!&#x2F;api&#x2F;Titanium.Geolocation-method-getCurrentPosition">getCurrentPosition</a>. </p>
<p>This is not designed to do what you think it does.  It will return the last known (determined) position and WILL NOT obtain a new one each time you check it.  See the docs link above.</p>
<p>You need to listen for the location change events and handle the start and stop of that event on your button presses.</p>
<p>BTW quick tip, use <code>setVisible</code> to show and hide buttons (views) as it is more efficient and less prone to surprise bugs that occur due to unexpected behaviours that adding and removing may cause.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="November 27th 2012, 9:47:59 pm">November 27th 2012</span>
								by <span class='authorname'>Malcolm Hollingsworth</span><br>
								<a class="icon-bg icon-link" href="question/145129/trigger-geolocation-twice-android#answer-251802" rel="permalink">permalink</a>
							</div>

							<h5>9 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>Ok.</p>
<p>Do you have any example on how doing that?  I can seem to find how to do that.<br>I really could use some code example here. #androiddevishard</p>
<p>I Will change My buttons to setVisible. Thanx for the tip! :)</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 27th 2012, 10:53:15 pm">November 27th 2012</span>
											by <span class='authorname'>Richard Harrysson</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>This is the guide for location services - it contains lots of info including setting up the location event handler and making sure the emulator has useful test data.</p>
<p><a href="http:&#x2F;&#x2F;docs.appcelerator.com&#x2F;titanium&#x2F;latest&#x2F;#!&#x2F;guide&#x2F;Tracking_Position_and_Heading">http:&#x2F;&#x2F;docs.appcelerator.com&#x2F;titanium&#x2F;latest&#x2F;#!&#x2F;guide&#x2F;Tracking_Position_and_Heading</a></p>
<p>This should give you everything you need to solve your problem very quickly.</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 27th 2012, 11:00:26 pm">November 27th 2012</span>
											by <span class='authorname'>Malcolm Hollingsworth</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Richard,</p>
<p>in addition to what Malcolm suggested correctly, you may also have a look<br><a href="http:&#x2F;&#x2F;developer.appcelerator.com&#x2F;question&#x2F;144890&#x2F;refresh-geolocation-only-when-pressing-a-button">here</a>.</p>
<p>Greetings,</p>
<p>Matthias</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 28th 2012, 5:26:18 am">November 28th 2012</span>
											by <span class='authorname'>Matthias Kroeger</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Ok i have tried to do it but with no luck. I get &quot;Cannot find property &quot;text&quot; of undefined&quot; when i press start.</p>
<p>And when i press Stop i get </p>
<pre><code class="hljs"><span class="hljs-label">geoloacation.addEventlistner</span>(<span class="hljs-string">"location"</span>, locationHandler)<span class="hljs-comment">;lat2=a.coords.latitude.</span>
</code></pre><p>What have i done wrong?</p>
<p>I cant find it and i am loosing my head here…..</p>
<p>Here is my new code. I&#39;ll give you the whole shebang so sorry for the droves…</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> velo = {};
velo.getLastWeek = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> today = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">var</span> nextWeek = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(today.getTime() + <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">var</span> lastWeek = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(today.getTime() - <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);

    <span class="hljs-keyword">return</span> lastWeek;
}

velo.getDayName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> today = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">var</span> day = today.getDay();
    <span class="hljs-keyword">var</span> dayName = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">switch</span>(day) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            dayName = <span class="hljs-string">'MÃ¥ndag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
            dayName = <span class="hljs-string">'Tisdag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
            dayName = <span class="hljs-string">'Onsdag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
            dayName = <span class="hljs-string">'Torsdag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
            dayName = <span class="hljs-string">'Fredag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
            dayName = <span class="hljs-string">'LÃ¶rdag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:
            dayName = <span class="hljs-string">'SÃ¶ndag'</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            dayname = <span class="hljs-string">''</span>;
            <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">return</span> dayName;
}

velo.getLastWeek();

Ti.App.Distance = <span class="hljs-number">0</span>;

velo.getDistance = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">lat1, lon1, lat2, lon2</span>) </span>{
    <span class="hljs-keyword">var</span> R = <span class="hljs-number">6371</span>;
    <span class="hljs-comment">// m (change this constant to get miles)</span>
    <span class="hljs-keyword">var</span> dLat = (lat2 - lat1) * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span>;
    <span class="hljs-keyword">var</span> dLon = (lon2 - lon1) * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span>;
    <span class="hljs-keyword">var</span> a = <span class="hljs-built_in">Math</span>.sin(dLat / <span class="hljs-number">2</span>) * <span class="hljs-built_in">Math</span>.sin(dLat / <span class="hljs-number">2</span>) + <span class="hljs-built_in">Math</span>.cos(lat1 * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span>) * <span class="hljs-built_in">Math</span>.cos(lat2 * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span>) * <span class="hljs-built_in">Math</span>.sin(dLon / <span class="hljs-number">2</span>) * <span class="hljs-built_in">Math</span>.sin(dLon / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">var</span> c = <span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.atan2(<span class="hljs-built_in">Math</span>.sqrt(a), <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1</span> - a));
    <span class="hljs-keyword">var</span> d = R * c;

    Ti.API.info(<span class="hljs-string">'Antal Km : '</span> + d);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(d);
};

velo.getTime = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">start, end</span>) </span>{
    <span class="hljs-keyword">var</span> difference = (end - start) / <span class="hljs-number">1000</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(difference / <span class="hljs-number">60</span>);
}

velo.getDate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> datetime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">var</span> currDay = datetime.getDate();
    <span class="hljs-keyword">var</span> currMonth = datetime.getMonth() + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> currYear = datetime.getFullYear();
    <span class="hljs-keyword">var</span> hours = datetime.getHours();
    <span class="hljs-keyword">var</span> minutes = datetime.getMinutes();

    <span class="hljs-keyword">if</span> (currDay &lt;= <span class="hljs-number">9</span>) {
        currDay = <span class="hljs-string">'0'</span> + currDay;
    }
    <span class="hljs-keyword">if</span> (currMonth &lt;= <span class="hljs-number">9</span>) {
        currMonth = <span class="hljs-string">'0'</span> + currMonth;
    }

    <span class="hljs-keyword">return</span> currYear + <span class="hljs-string">'-'</span> + currMonth + <span class="hljs-string">'-'</span> + currDay;
}
<span class="hljs-keyword">var</span> win = Ti.UI.currentWindow;
<span class="hljs-keyword">var</span> log1;
<span class="hljs-keyword">var</span> lat1;
<span class="hljs-keyword">var</span> log2;
<span class="hljs-keyword">var</span> lat2;
<span class="hljs-keyword">var</span> startHeading, endHeading;
<span class="hljs-keyword">var</span> projectNumber = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> name = <span class="hljs-string">''</span>, Description = <span class="hljs-string">''</span>, startTime = <span class="hljs-string">''</span>;

<span class="hljs-keyword">var</span> view = Ti.UI.createView({
    height : <span class="hljs-string">'auto'</span>,
    width : <span class="hljs-string">'auto'</span>,
    backgroundColor : <span class="hljs-string">'#fff'</span>,
    backgroundImage : <span class="hljs-string">'images/home.jpg'</span>
});

<span class="hljs-keyword">var</span> txtProjectNumber = Ti.UI.createTextField({
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'200dp'</span>,
    top : <span class="hljs-string">'40dp'</span>,
    hintText : <span class="hljs-string">'Projektnr'</span>,
    editable : <span class="hljs-literal">false</span>,
    value : Ti.App.projectNumber
});

<span class="hljs-keyword">var</span> txtName = Ti.UI.createTextField({
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'200dp'</span>,
    top : <span class="hljs-string">'100dp'</span>,
    hintText : <span class="hljs-string">'Projektnamn'</span>,
    editable : <span class="hljs-literal">false</span>,
    value : <span class="hljs-string">''</span>
});

<span class="hljs-keyword">var</span> txtDesc = Ti.UI.createTextField({
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'200dp'</span>,
    top : <span class="hljs-string">'100dp'</span>,
    hintText : <span class="hljs-string">'Notering'</span>
});

<span class="hljs-keyword">var</span> btnStart = Ti.UI.createButton({
    title : <span class="hljs-string">'Start'</span>,
    backgroundColor : <span class="hljs-string">'#87a6c0'</span>,
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'150dp'</span>,
    top : <span class="hljs-string">'160dp'</span>
});
<span class="hljs-keyword">var</span> btnStop = Ti.UI.createButton({
    title : <span class="hljs-string">'Stop'</span>,
    backgroundColor : <span class="hljs-string">'#87a6c0'</span>,
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'150dp'</span>,
    top : <span class="hljs-string">'160dp'</span>,
});



btnStart.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
     Ti.Geolocation.accuracy = Ti.Geolocation.ACCURACY_HIGH;
     <span class="hljs-comment">// add location event listener</span>
    Ti.Geolocation.addEventListener(<span class="hljs-string">"location"</span>, locationHandler);


    <span class="hljs-keyword">var</span> date = velo.getDate();
        <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        startTime = start.getTime();

        <span class="hljs-keyword">var</span> day = velo.getDayName();
        <span class="hljs-keyword">var</span> db = Ti.Database.install(<span class="hljs-string">'TimeReport.sqlite'</span>, <span class="hljs-string">'TimeReport'</span>);
        db.execute(<span class="hljs-string">'insert into TimeReport("project_number","description", "latitude1", "longitude1", "date", "day", "startTime") values(?,?,?,?,?,?,?)'</span>, projectNumber, Description, lat1, log1, date, day, startTime);
        db.close();

        txtProjectNumber.hide();
        txtName.hide();
        txtDesc.hide();
        btnStart.hide();
        view.add(btnStop);

});
</code></pre><p>And…</p>
<pre><code class="hljs"> <span class="hljs-keyword">var</span> locationHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">if</span> (e.success) {       
        <span class="hljs-comment">// display current position</span>
        log1 = e.coords.longitude;
        lat1 = e.coords.latitude;
        <span class="hljs-comment">// Message</span>


        <span class="hljs-comment">// display location update timestamp</span>
        <span class="hljs-keyword">var</span> displayDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        displayDate.setTime(e.coords.timestamp);


        alert(<span class="hljs-string">"location success: coords="</span> + <span class="hljs-string">"long="</span> + e.coords.longitude + <span class="hljs-string">" lat="</span> + e.coords.latitude + <span class="hljs-string">"Timestamp="</span> + displayDate);

    } 
    <span class="hljs-comment">// remove location listener</span>
    Ti.Geolocation.removeEventListener(<span class="hljs-string">"location"</span>, locationHandler);
};






btnStop.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
     Ti.Geolocation.accuracy = Ti.Geolocation.ACCURACY_HIGH;

    txtDesc.setValue(<span class="hljs-string">''</span>);
     Ti.Geolocation.addEventListener(<span class="hljs-string">"location"</span>, locationHandler);



        lat2 = e.coords.latitude;
        log2 = e.coords.longitude;

    alert(lat2 + log2);



        <span class="hljs-keyword">var</span> btnViewMap = Ti.UI.createButton({
            title : <span class="hljs-string">'View Map'</span>,
            height : <span class="hljs-string">'40dp'</span>,
            width : <span class="hljs-string">'150dp'</span>,
            top : <span class="hljs-string">'250dp'</span>
        });

        btnViewMap.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
            googleMapsLink = <span class="hljs-string">"http://maps.google.com/maps?saddr="</span>+lat1+<span class="hljs-string">","</span>+log1+<span class="hljs-string">"&amp;daddr="</span>+lat2+<span class="hljs-string">","</span>+log2;
            Ti.Platform.openURL(googleMapsLink);
        });

        view.add(btnViewMap);
    });
    <span class="hljs-keyword">var</span> start = lat1 + <span class="hljs-string">','</span> + log1;
    <span class="hljs-keyword">var</span> end = lat2 + <span class="hljs-string">','</span> + log2;
    <span class="hljs-keyword">var</span> url = <span class="hljs-string">'http://maps.googleapis.com/maps/api/distancematrix/json?origins='</span> + start + <span class="hljs-string">'&amp;destinations='</span> + end + <span class="hljs-string">'&amp;mode=driving%20&amp;sensor=false'</span>;

    <span class="hljs-keyword">var</span> xhr = Ti.Network.createHTTPClient();
    <span class="hljs-keyword">var</span> json;
    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> dist;
            json = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.responseText);
            <span class="hljs-keyword">var</span> dis = json.rows[<span class="hljs-number">0</span>].elements[<span class="hljs-number">0</span>].distance.text;
            <span class="hljs-keyword">if</span> (dis.search(<span class="hljs-string">'km'</span>) !== -<span class="hljs-number">1</span>) {
                dist = dis.replace(<span class="hljs-string">' km'</span>, <span class="hljs-string">''</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dis.search(<span class="hljs-string">'m'</span>) !== -<span class="hljs-number">1</span>) {
                <span class="hljs-keyword">var</span> dist = dis.replace(<span class="hljs-string">' m'</span>, <span class="hljs-string">''</span>);
                dist = dist / <span class="hljs-number">1000</span>;
            }

            <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
            <span class="hljs-keyword">var</span> endTime = start.getTime();

            <span class="hljs-keyword">var</span> time = velo.getTime(startTime, endTime);
            <span class="hljs-keyword">var</span> db = Ti.Database.install(<span class="hljs-string">'TimeReport.sqlite'</span>, <span class="hljs-string">'TimeReport'</span>);
            db.execute(<span class="hljs-string">'update TimeReport set latitude2 = ?, longitude2 = ?, distance = ?, endTime=? where project_number = ? and startTime = ? '</span>, lat2, log2, dist, endTime, projectNumber, startTime);
            db.close();



            txtProjectNumber.show();
            txtName.show();
            txtDesc.show();
            btnStart.show();
            view.remove(btnStop);
        } <span class="hljs-keyword">catch</span>(e) {
            alert(<span class="hljs-string">'Error occured :'</span> + e);
        }

    };

    xhr.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        alert(<span class="hljs-string">'NÃ¥nting gick fel med att finna GPS kÃ¤lla'</span> + e);
    };

    xhr.open(<span class="hljs-string">'GET'</span>, url);
    xhr.send();



 <span class="hljs-keyword">var</span> locationHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">if</span> (e.success) {       
        <span class="hljs-comment">// display current position</span>
        log2 = e.coords.longitude;
        lat2 = e.coords.latitude;
        <span class="hljs-comment">// Message</span>


        <span class="hljs-comment">// display location update timestamp</span>
        <span class="hljs-keyword">var</span> displayDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        displayDate.setTime(e.coords.timestamp);


        alert(<span class="hljs-string">"location success: coords="</span> + <span class="hljs-string">"long="</span> + e.coords.longitude + <span class="hljs-string">" lat="</span> + e.coords.latitude + <span class="hljs-string">"Timestamp="</span> + displayDate);

    } 
    <span class="hljs-comment">// remove location listener</span>
    Ti.Geolocation.removeEventListener(<span class="hljs-string">"location"</span>, locationHandler);
};


view.add(txtProjectNumber);
view.add(btnStart);
<span class="hljs-comment">//view.add(txtName);</span>
view.add(txtDesc);

win.add(view);

<span class="hljs-keyword">var</span> db = Ti.Database.install(<span class="hljs-string">'/TimeReport.sqlite'</span>, <span class="hljs-string">'TimeReport'</span>);
<span class="hljs-keyword">var</span> rows = db.execute(<span class="hljs-string">'select * from TimeReport'</span>);

<span class="hljs-keyword">while</span> (rows.isValidRow()) {

    <span class="hljs-keyword">var</span> latitude2 = rows.fieldByName(<span class="hljs-string">'latitude2'</span>);
    <span class="hljs-keyword">if</span> (rows.fieldByName(<span class="hljs-string">'startTime'</span>) !== <span class="hljs-literal">null</span> &amp;&amp; rows.fieldByName(<span class="hljs-string">'endTime'</span>) === <span class="hljs-literal">null</span>) {
        projectNumber = rows.fieldByName(<span class="hljs-string">'project_number'</span>);
        startTime = rows.fieldByName(<span class="hljs-string">'startTime'</span>);
        lat1 = rows.fieldByName(<span class="hljs-string">'latitude1'</span>);
        log1 = rows.fieldByName(<span class="hljs-string">'longitude1'</span>);
        <span class="hljs-keyword">var</span> d = rows.fieldByName(<span class="hljs-string">'distance'</span>);

        view.add(btnStop);
        btnStart.hide();
        txtProjectNumber.hide();
        txtName.hide();
        txtDesc.hide();
    }

    rows.next();
}
rows.close();
db.close();
</code></pre><p>Thanx</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 28th 2012, 8:35:02 am">November 28th 2012</span>
											by <span class='authorname'>Richard Harrysson</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Hi</p>
<p>The console should tell you what line of code the error failed on, find this line and post back here.</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 28th 2012, 8:43:23 am">November 28th 2012</span>
											by <span class='authorname'>Malcolm Hollingsworth</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>I get (8,69) in runtime Error on the phone (device) I dont know how to test geo on emulator.</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 28th 2012, 8:47:09 am">November 28th 2012</span>
											by <span class='authorname'>Richard Harrysson</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>OK I will take a look at your code later on (will be a few hours though) and see if anything jumps out.</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 28th 2012, 8:59:32 am">November 28th 2012</span>
											by <span class='authorname'>Malcolm Hollingsworth</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Great. Thanx man!</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 28th 2012, 9:00:52 am">November 28th 2012</span>
											by <span class='authorname'>Richard Harrysson</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Ok.</p>
<p>Now i have managed to do the location handler and it works with no errors (Hurrah)</p>
<p>BUT.</p>
<p>When i press &quot;Start&quot; it wont get me the Lat1 and Log1.  It will display the alert from the btnStop eventlistner</p>
<pre><code class="hljs"> alert<span class="hljs-list">( <span class="hljs-string">"Log1 "</span>+Titanium.App.Properties.getString<span class="hljs-list">(<span class="hljs-string">"log1"</span>)</span>+<span class="hljs-string">"Lat1 "</span>+Titanium.App.Properties.getString<span class="hljs-list">(<span class="hljs-string">"lat1"</span>)</span>+<span class="hljs-string">"Log2 "</span>+Titanium.App.Properties.getString<span class="hljs-list">(<span class="hljs-string">"log2"</span>)</span>+<span class="hljs-string">"Lat2 "</span>+Titanium.App.Properties.getString<span class="hljs-list">(<span class="hljs-string">"lat2"</span>)</span>)</span><span class="hljs-comment">;</span>
</code></pre><p>That is kind of strange……</p>
<p>Is it not possible to have 2 locationHandler in the same view? or what….</p>
<p>Here is my code now.</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> btnStart = Ti.UI.createButton({
    title : <span class="hljs-string">'Start'</span>,
    backgroundColor : <span class="hljs-string">'#87a6c0'</span>,
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'100dp'</span>,
    left: <span class="hljs-string">'10dp'</span>,
    top : <span class="hljs-string">'160dp'</span>
});

<span class="hljs-keyword">var</span> btnStop = Ti.UI.createButton({     
    title : <span class="hljs-string">'Stop'</span>,
    backgroundColor : <span class="hljs-string">'#87a6c0'</span>,
    height : <span class="hljs-string">'40dp'</span>,
    width : <span class="hljs-string">'100dp'</span>,
    right: <span class="hljs-string">'10dp'</span>,
    top : <span class="hljs-string">'160dp'</span>,
});


btnStart.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{

        Ti.Geolocation.addEventListener(<span class="hljs-string">"location"</span>, locationHandler);

});

        <span class="hljs-keyword">var</span> locationHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">if</span> (e.success) {   
        Titanium.Geolocation.accuracy = Titanium.Geolocation.ACCURACY_HIGH;

Titanium.App.Properties.setString(<span class="hljs-string">"lat1"</span>,e.coords.latitude);
Titanium.App.Properties.setString(<span class="hljs-string">"log1"</span>,e.coords.longitude);


            lat1 = Titanium.App.Properties.getString(<span class="hljs-string">"lat1"</span>);
            log1 = Titanium.App.Properties.getString(<span class="hljs-string">"log1"</span>);;
        projectNumber = txtProjectNumber.value;
        Description = txtDesc.value;
        <span class="hljs-keyword">var</span> date = velo.getDate();
        <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        <span class="hljs-keyword">var</span> startTime = start.getTime();

        <span class="hljs-keyword">var</span> day = velo.getDayName();
        <span class="hljs-keyword">var</span> db = Ti.Database.install(<span class="hljs-string">'TimeReport.sqlite'</span>, <span class="hljs-string">'TimeReport'</span>);
        db.execute(<span class="hljs-string">'insert into TimeReport("project_number","description", "latitude1", "longitude1", "date", "day", "startTime") values(?,?,?,?,?,?,?)'</span>, projectNumber, Description, lat1, log1, date, day, startTime);
        db.close();

        txtProjectNumber.hide();
        txtName.hide();
        txtDesc.hide();

         }<span class="hljs-keyword">else</span> {
       <span class="hljs-comment">// alert("location error: code=" + e.code);</span>
       <span class="hljs-comment">// Ti.API.info("location error: message=" + e.error);</span>
    }
          <span class="hljs-comment">// remove location listener</span>
    Ti.Geolocation.removeEventListener(<span class="hljs-string">"location"</span>, locationHandler);    

};

btnStop.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-comment">//txtProjectNumber.setValue('');</span>
     Ti.Geolocation.addEventListener(<span class="hljs-string">"location"</span>, locationHandler);




    });
    <span class="hljs-comment">//Titanium.Geolocation.distanceFilter = 10;</span>
    <span class="hljs-comment">//Ti.Geolocation.purpose = "KÃ¶rjournal";</span>
    <span class="hljs-keyword">var</span> locationHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">if</span> (e.success) {  
        txtDesc.setValue(<span class="hljs-string">''</span>);

    Titanium.Geolocation.accuracy = Titanium.Geolocation.ACCURACY_HIGH;     
        <span class="hljs-comment">// display current position</span>
       Titanium.App.Properties.setString(<span class="hljs-string">"lat2"</span>,e.coords.latitude);
Titanium.App.Properties.setString(<span class="hljs-string">"log2"</span>,e.coords.longitude);


            lat2 = Titanium.App.Properties.getString(<span class="hljs-string">"lat2"</span>);
            log2 = Titanium.App.Properties.getString(<span class="hljs-string">"log2"</span>);;



     <span class="hljs-keyword">var</span> url = <span class="hljs-string">'http://maps.googleapis.com/maps/api/distancematrix/json?origins='</span> + lat1 + <span class="hljs-string">','</span> + log1 + <span class="hljs-string">'&amp;destinations='</span> + lat2 + <span class="hljs-string">','</span> + log2 + <span class="hljs-string">'&amp;mode=driving%20&amp;sensor=false'</span>;

    <span class="hljs-keyword">var</span> xhr = Ti.Network.createHTTPClient();
    <span class="hljs-keyword">var</span> json;
    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> dist;
            json = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.responseText);
            <span class="hljs-keyword">var</span> dis = json.rows[<span class="hljs-number">0</span>].elements[<span class="hljs-number">0</span>].distance.text;
            <span class="hljs-keyword">if</span> (dis.search(<span class="hljs-string">'km'</span>) !== -<span class="hljs-number">1</span>) {
                dist = dis.replace(<span class="hljs-string">' km'</span>, <span class="hljs-string">''</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dis.search(<span class="hljs-string">'m'</span>) !== -<span class="hljs-number">1</span>) {
                <span class="hljs-keyword">var</span> dist = dis.replace(<span class="hljs-string">' m'</span>, <span class="hljs-string">''</span>);
                dist = dist / <span class="hljs-number">1000</span>;
            }

            <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
            <span class="hljs-keyword">var</span> endTime = start.getTime();

            <span class="hljs-keyword">var</span> time = velo.getTime(startTime, endTime);
            <span class="hljs-keyword">var</span> db = Ti.Database.install(<span class="hljs-string">'TimeReport.sqlite'</span>, <span class="hljs-string">'TimeReport'</span>);
            db.execute(<span class="hljs-string">'update TimeReport set latitude2 = ?, longitude2 = ?, distance = ?, endTime=? where project_number = ? and startTime = ? '</span>, lat2, log2, dist, endTime, projectNumber, startTime);
            db.close();

            alert(<span class="hljs-string">'Successfully saved the Deatils :\nDistance : '</span> + dist + <span class="hljs-string">' km'</span>);

            txtProjectNumber.show();
            txtName.show();
            txtDesc.show();

        } <span class="hljs-keyword">catch</span>(ex) {
            alert(<span class="hljs-string">'Error occured :'</span> + ex);
        }

    };

    xhr.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        alert(<span class="hljs-string">'NÃ¥nting gick fel med att finna GPS kÃ¤lla'</span> + e);
    };

    xhr.open(<span class="hljs-string">'GET'</span>, url);
    xhr.send();

       alert( <span class="hljs-string">"Log1 "</span>+Titanium.App.Properties.getString(<span class="hljs-string">"log1"</span>)+<span class="hljs-string">"Lat1 "</span>+Titanium.App.Properties.getString(<span class="hljs-string">"lat1"</span>)+<span class="hljs-string">"Log2 "</span>+Titanium.App.Properties.getString(<span class="hljs-string">"log2"</span>)+<span class="hljs-string">"Lat2 "</span>+Titanium.App.Properties.getString(<span class="hljs-string">"lat2"</span>));

    } <span class="hljs-keyword">else</span> {

        alert(<span class="hljs-string">"location error: code="</span> + e.code);

    }
    <span class="hljs-comment">// remove location listener</span>
    Ti.Geolocation.removeEventListener(<span class="hljs-string">"location"</span>, locationHandler);
};
</code></pre><p>Why isnt Lat &amp; Log1 giving me the coords? And why is the &quot;click&quot; eventlistner for the btnStart giving me the alert from the btnStop eventlistner?</p>
<p>Pls help…</p>
<p>Thanx</p>
</p>
										<div class="author">
											&mdash; commented <span title="November 29th 2012, 7:33:44 pm">November 29th 2012</span>
											by <span class='authorname'>Richard Harrysson</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
