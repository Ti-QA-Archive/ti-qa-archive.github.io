<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	
		<title>Probably simple Q regarding commonjs » Community Questions &amp; Answers </title>
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="../../related/favicon.png" rel="shortcut icon" type="image/png">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
	<link href="//d3ilu1xuwhtfe2.cloudfront.net/e8e0ebd/css/style.css" rel="stylesheet" type="text/css">
	<link href="../../related/qa.css" rel="stylesheet" type="text/css">
	<link href="../../related/hybrid.css" rel="stylesheet" type="text/css">
	
	<link href="../../related/overrides.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class='mast'>    <div class='container'>        <div class='row'>            <div class='col-sm-12'>                <div class='masthead'><h1>Titanium Community Questions & Answer Archive</h1><h2>We felt that 6+ years of knowledge should not die so this is the Titanium Community Questions &amp; Answer Archive</h2></div>            </div>        </div>    </div></div>

<main class="container">
	<div class="row">
		<div class="col-sm-12">
			
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<article class="question-container">
	<div class="question">
		<header>
			<h1>Probably simple Q regarding commonjs</h1>
		</header>
		<section>
			<p>(Building for both Android and Iphone)</p>
<p>Hi<br>I am new to commonjs and this is my problem:</p>
<p>On startup of my app, I check if I am connected to the net,<br>if so I grab a fresh json file on a server and I<br>set the fresh json (in &quot;json.js&quot;).</p>
<p>In json.js, I store main_json, so in case of no internet connection,<br>the old version of the json is used.</p>
<p>In the file &quot;get_json.js&quot; I then want to use main_json in a tableview.<br>I try to grab the updated version of json like this:</p>
<pre><code class="hljs"><span class="hljs-built_in">var</span> <span class="hljs-built_in">Data</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"commonjs/json"</span>); 
<span class="hljs-built_in">var</span> myJson = <span class="hljs-built_in">Data</span><span class="hljs-built_in">.</span>getJson());
</code></pre><p>In json.js, this is the function that returns myJson:</p>
<pre><code class="hljs">exports.getJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> main_json;
};
</code></pre><p>This brings me my json, but ONLY the old one, not the data I fetched from the server.</p>
<p>This is the code in json.js:</p>
<pre><code class="hljs">
<span class="hljs-keyword">var</span> main_json = [
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"day"</span>: <span class="hljs-string">"Wednesday"</span>
        },
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
            <span class="hljs-string">"dag"</span>: <span class="hljs-string">"Monday"</span>

        },
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">3</span>,
            <span class="hljs-string">"dag"</span>: <span class="hljs-string">"Sunday"</span>

        }
  ];

  exports.getJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> main_json;
};

exports.setJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(newJson)</span></span>{
    main_json = newJson;
    alert(<span class="hljs-string">"newjson: "</span>+ newJson); <span class="hljs-comment">// newJson holds the fresh json correctly</span>
};
</code></pre><p>So my question is:<br>Why is only the old (initial) version of main_json returned?<br>Is something wrong with the way that I set the information?</p>
<p><em>Hoping someone is around this Saturday evening</em><br>Thanks and best regards &#x2F;Tove</p>

		</section>
		<footer>
			<div class="author">
				&mdash; asked <span title="July 5th 2014, 1:42:40 pm">July 5th 2014</span>
				by <span class='authorname'>Tove Walden</span>
			</div>

			
				<ul class="tags">
					
						<li><span class='tagname'>commonjs</span></li>
					
						<li><span class='tagname'>json</span></li>
					
				</ul>
			

			<section>
				<h5>0 Comments</h5>
				
			</section>
		</footer>
		<aside class="vote-box">
			<div class="score"><span>0</span> Votes</div>
			<div class="answers"><span>1</span> Answer</div>
		</aside>
	</div>

	<hr>

	<h3>1 Answer</h3>

	
		<ul class="answers">
			
				<li class="answer">
				
					<article id="answer-280395">
				
						<section>
							<p>Hi</p>
<p>I have just tested your code (the bits you supplied) and they work fine for me - in fact as CommonJS modules go - this is a great clean and simple one.  You did not provide any code to show how you set the JSON using CommonJS though - so I created a quick version.</p>
<p>This is my version of your code;</p>
<p><strong>json.js</strong> (identical to your own)</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> main_json = [
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"day"</span>: <span class="hljs-string">"Wednesday"</span>
        },
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
            <span class="hljs-string">"dag"</span>: <span class="hljs-string">"Monday"</span>

        },
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">3</span>,
            <span class="hljs-string">"dag"</span>: <span class="hljs-string">"Sunday"</span>

        }
  ];

  exports.getJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> main_json;
};

exports.setJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(newJson)</span></span>{
    main_json = newJson;
    alert(<span class="hljs-string">"newjson: "</span>+ newJson); <span class="hljs-comment">// newJson holds the fresh json correctly</span>
};
</code></pre><p><strong>Example Usage</strong></p>
<pre><code class="hljs"><span class="hljs-comment">// assumes to buttons for testing</span>
<span class="hljs-comment">// btnShow = shows</span>
<span class="hljs-comment">// btnUpdate = update</span>
<span class="hljs-comment">// I am really good at naming buttons</span>
btnShow.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
    alert(<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">require</span>(<span class="hljs-string">'commonjs/json'</span>).getJson()));
});
btnUpdate.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
    <span class="hljs-built_in">require</span>(<span class="hljs-string">'commonjs/json'</span>).setJson([
        { id: <span class="hljs-number">13</span>, dag: <span class="hljs-string">'Saturday'</span> }
    ]);
});
</code></pre><p>This is what I see;</p>
<ul>
<li>Press Show</li>
<li>Alert displays the object you have in the <strong>json.js</strong> file</li>
<li>Press Update</li>
<li>Show there is a new object</li>
<li>Press Show again</li>
<li>Alert displays new version of the object that I set in the <em>update</em> event</li>
</ul>
<p>So chances are the problem is in how you use <strong>setJson</strong>.</p>

						</section>
						<footer>
							<div class="author">
								&mdash; answered <span title="July 5th 2014, 2:08:32 pm">July 5th 2014</span>
								by <span class='authorname'>Malcolm Hollingsworth</span><br>
								<a class="icon-bg icon-link" href="question/175784/probably-simple-q-regarding-commonjs#answer-280395" rel="permalink">permalink</a>
							</div>

							<h5>6 Comments</h5>
							
								<ul class="comments">
								
									<li class="comment">
										<p><p>BTW as you are new to CommonJS I thought it worth pointing out that my shorthand syntax is just as valid as yours;</p>
<p>These are all the same;</p>
<pre><code class="hljs"><span class="hljs-comment">// using many variables</span>
<span class="hljs-built_in">var</span> <span class="hljs-built_in">Data</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"commonjs/json"</span>); 
<span class="hljs-built_in">var</span> myJson = <span class="hljs-built_in">Data</span><span class="hljs-built_in">.</span>getJson());
alert(myJson);
</code></pre><pre><code class="hljs"><span class="hljs-comment">// using less variables</span>
<span class="hljs-built_in">var</span> <span class="hljs-built_in">Data</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"commonjs/json"</span>); 
alert(<span class="hljs-built_in">Data</span><span class="hljs-built_in">.</span>getJson()));
</code></pre><pre><code class="hljs"><span class="hljs-regexp">//</span> using <span class="hljs-literal">no</span> variables
alert(<span class="hljs-built_in">require</span>(<span class="hljs-string">"commonjs/json"</span>).getJson()));
</code></pre><p>Which you choose depends on what you are doing.</p>
<ul>
<li>The first example will always work in all circumstances.</li>
<li>The second is good when it is more convenient to not have to keep typing require when you are using the module many times over in the same function or file</li>
<li>The third option is best when there is no requirement to assign any variables as you are not going to affect the module inside the calling function.</li>
</ul>
<p>The idea being; less variables means less memory required.  As Tesco has taught us;</p>
<ul>
<li><em>&quot;Every little helps&quot;</em></li>
</ul>
</p>
										<div class="author">
											&mdash; commented <span title="July 5th 2014, 2:15:22 pm">July 5th 2014</span>
											by <span class='authorname'>Malcolm Hollingsworth</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Thank you so much for great comments, Malmcolm!</p>
<p>I set the json in app.js, like this:</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> Data = <span class="hljs-built_in">require</span>(<span class="hljs-string">"commonjs/json"</span>);

<span class="hljs-keyword">var</span> url = <span class="hljs-string">"http://sample.com/files/json.json"</span>;
<span class="hljs-keyword">var</span> client = Ti.Network.createHTTPClient({
onload : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    alert(<span class="hljs-keyword">this</span>.responseText); <span class="hljs-comment">//holds the updated json</span>
    Data.setJson(<span class="hljs-keyword">this</span>.responseText);
 },
 onerror : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
 },
 timeout : <span class="hljs-number">5000</span>
});
client.open(<span class="hljs-string">"GET"</span>, url);
client.send();
</code></pre><p>Log from SET function </p>
<pre><code class="hljs"><span class="hljs-attribute">alert("newjson</span>: <span class="hljs-string">"+ newJson);</span>
</code></pre><ul>
<li>gives me the right and updated json like<br>[{&quot;id&quot;:1, …and so on (new json contains 5 objects)<br>so that looks ok</li>
</ul>
<p>The log for &quot;main_json&quot; from the GET-function gives me<br>[object Object],[object Object],[object Object]<br>(old json contains 3 objects), like this:</p>
<pre><code class="hljs">  exports.getJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    alert(main_json); <span class="hljs-comment">// [object Object],[object Object],[object Object]</span>
    <span class="hljs-keyword">return</span> main_json;
};
</code></pre><p>This works in my tableView, but unfortunatelly it is still the old main_json and not the updated one.</p>
<p>Hm.. this is tricky<br>Best &#x2F;Tove</p>
</p>
										<div class="author">
											&mdash; commented <span title="July 5th 2014, 4:42:09 pm">July 5th 2014</span>
											by <span class='authorname'>Tove Walden</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>On the surface your code looks fine, however this section is not doing what you think it is;</p>
<pre><code class="hljs">onload : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    alert(<span class="hljs-keyword">this</span>.responseText); <span class="hljs-comment">//holds the updated json</span>
    Data.setJson(<span class="hljs-keyword">this</span>.responseText);
 },
</code></pre><p>For clarity <strong>this.responseText</strong> does NOT contain the updated JSON, it contains the updated textual version of the JSON.  <strong>responseText</strong> returns back plain text not an object.</p>
<pre><code class="hljs">onload : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    alert(<span class="hljs-keyword">this</span>.responseText); <span class="hljs-comment">//holds the updated json</span>
    Data.setJson(<span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.responseText));
 },
</code></pre><p>Using the method <strong>JSON.parse(this.responseText)</strong> with the textual response it converts the text into a usable JSON object - obviously as long as the text is actually a valid JSON object.</p>
<p>Can you make this change and see if this makes any difference?  If not change the code to the following purely for testing purposes;</p>
<pre><code class="hljs"><span class="hljs-tag">onload</span> : <span class="hljs-tag">function</span>(e) {
    <span class="hljs-comment">// alert(this.responseText); // holds the updated text</span>
    <span class="hljs-comment">// set the convert text as json</span>
    <span class="hljs-comment">// Data.setJson(JSON.parse(this.responseText)); </span>
    <span class="hljs-tag">Data</span><span class="hljs-class">.setJson</span>([
        { <span class="hljs-attribute">id</span>: <span class="hljs-number">13</span>, <span class="hljs-attribute">dag</span>: <span class="hljs-string">'Saturday'</span> }
    ]);
    <span class="hljs-tag">alert</span>(Data.<span class="hljs-function">getJson</span>());
 },
</code></pre><p>Report back.</p>
</p>
										<div class="author">
											&mdash; commented <span title="July 5th 2014, 4:58:54 pm">July 5th 2014</span>
											by <span class='authorname'>Malcolm Hollingsworth</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Thanks a lot Malcolm!<br>I did the changes, and it&#39;s interesting:</p>
<p>I set the new data and the SET  function in json.js alerts the new, shorter json,<br>as well as from here in app.js</p>
<pre><code class="hljs">  <span class="hljs-tag">Data</span><span class="hljs-class">.setJson</span>([
        { <span class="hljs-attribute">id</span>: <span class="hljs-number">13</span>, <span class="hljs-attribute">dag</span>: <span class="hljs-string">'Saturday'</span> }
    ]);
    <span class="hljs-tag">alert</span>(Data.<span class="hljs-function">getJson</span>()); <span class="hljs-comment">//alerts your new shorter json</span>
 },
</code></pre><p>but from my function that is to create the tableview in get_json.js it is still the old initial json:</p>
<pre><code class="hljs"><span class="hljs-built_in">var</span> <span class="hljs-built_in">Data</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"commonjs/json"</span>); 
<span class="hljs-built_in">var</span> myJson = <span class="hljs-built_in">Data</span><span class="hljs-built_in">.</span>getJson());
alert(myJson); <span class="hljs-comment">//old json</span>
alert(<span class="hljs-built_in">Data</span><span class="hljs-built_in">.</span>getJson()); <span class="hljs-comment">//old json</span>
</code></pre><p>I bet there is something really small that I have overseen…</p>
</p>
										<div class="author">
											&mdash; commented <span title="July 6th 2014, 4:40:43 am">July 6th 2014</span>
											by <span class='authorname'>Tove Walden</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Hi again<br>I am outlining how the files look right now.<br>Please ignore previous file names - this how it looks now:</p>
<p>app.js:</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> Data = <span class="hljs-built_in">require</span>(<span class="hljs-string">"commonjs/json"</span>); <span class="hljs-comment">// Observera utan .js</span>

<span class="hljs-comment">//start get new json from server:</span>

<span class="hljs-comment">//if connection - get new json</span>
<span class="hljs-keyword">var</span> told_you_before; <span class="hljs-comment">//if set to "yes" do not show alret again</span>

    <span class="hljs-keyword">if</span> (!Titanium.Network.online) {

                 <span class="hljs-keyword">if</span>(told_you_before != <span class="hljs-string">"yes"</span>){
                <span class="hljs-comment">// display failure message</span>
                <span class="hljs-keyword">var</span> alertDialog = Titanium.UI.createAlertDialog({
                    title:<span class="hljs-string">'You are offline!'</span>,
                    message:<span class="hljs-string">'Without internet access, ... text'</span>,
                    buttonNames:[<span class="hljs-string">"OK"</span>]
                });
                alertDialog.show();
                told_you_before = <span class="hljs-string">"yes"</span>;
                }
    }
    <span class="hljs-keyword">else</span> {

get_json(); <span class="hljs-comment">//structured like this during test</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_json</span>(<span class="hljs-params"></span>)</span>{

<span class="hljs-keyword">var</span> url = <span class="hljs-string">"http://sampleurl.com/json/new_json.json"</span>;
<span class="hljs-keyword">var</span> client = Ti.Network.createHTTPClient({
 onload : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
     alert(<span class="hljs-string">'success'</span> + <span class="hljs-keyword">this</span>.responseText); <span class="hljs-comment">//works - gives me the new array</span>

     Data.setJson(<span class="hljs-keyword">this</span>.responseText);
 },
 onerror : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
     Ti.API.debug(e.error);
 },
 timeout : <span class="hljs-number">5000</span>
});
client.open(<span class="hljs-string">"GET"</span>, url);
client.send();

} <span class="hljs-comment">//end get json</span>

    }; <span class="hljs-comment">// end else</span>
</code></pre><p>As I wrote in previous post - if I replace the Data.set…. with your test version where I set the new small json and then alert Data.getJson, it brings me the updated json</p>
<p>In json.js (my commonjs file), the code still looks like this<br>However below are the present varible names</p>
<p>json.js (commonjs):</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> huvud_json = [
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"day"</span>: <span class="hljs-string">"Wednesday"</span>
        },
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
            <span class="hljs-string">"dag"</span>: <span class="hljs-string">"Monday"</span>

        },
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-number">3</span>,
            <span class="hljs-string">"dag"</span>: <span class="hljs-string">"Sunday"</span>

        }
  ];

  exports.getJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> huvud_json;
};

exports.setJson = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(newJson)</span></span>{
    huvud_json = newJson;
    alert(<span class="hljs-string">"newjson: "</span>+ newJson); <span class="hljs-comment">// newJson holds the fresh json correctly</span>
};
</code></pre><p>Finally, these are the vital parts of program.js - the page where I want to display the result in a tableView:</p>
<p>program.js:</p>
<pre><code class="hljs">
Ti.<span class="hljs-keyword">include</span>(<span class="hljs-string">'app_functions.js'</span>); <span class="hljs-comment">// Holds no functions that has to do with grabbing the json</span>

<span class="hljs-keyword">var</span> Data = <span class="hljs-keyword">require</span>(<span class="hljs-string">"commonjs/json"</span>); <span class="hljs-comment">// Observera utan .js</span>

<span class="hljs-comment">//start making table view loop and populate with updated json</span>
loopa_program();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loopa_program</span><span class="hljs-params">()</span></span>{

    <span class="hljs-keyword">var</span> tbl_data = []; <span class="hljs-comment">//den array som ska in i raderna</span>

    huvud_json = Data.getJson(); <span class="hljs-comment">//gives me old json</span>
    <span class="hljs-comment">//huvud_json = JSON.parse(Data.getJson()); parsed or not doesn't seem to matter</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; huvud_json.length; i++) {

    <span class="hljs-comment">//populating rows - works fine (but holds old json only of course)</span>

    }<span class="hljs-comment">//end for-loop</span>


    <span class="hljs-keyword">var</span> table = Titanium.UI.createTableView({
        data:tbl_data
    });
    view_program.add(table);


}
<span class="hljs-comment">//end making table</span>
</code></pre><p>I keep staring at this. Can´t undestand why it doesn&#39;t work. It seems all set and get json functionallity works UNTIL I want to use the updated json from program.js - then only he old version is there</p>
</p>
										<div class="author">
											&mdash; commented <span title="July 6th 2014, 3:34:58 pm">July 6th 2014</span>
											by <span class='authorname'>Tove Walden</span>
										</div>
									</li>
								
									<li class="comment">
										<p><p>Hi<br>another comment from myself to finalize this and maybe to help someone else - my mentor helped me to write to a file, like this and now it works splendidly:</p>
<p>In json.js (commonjs):</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> jsonFile = Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory, <span class="hljs-string">"data.json"</span>);
<span class="hljs-keyword">if</span> (jsonFile.exists()) {
    huvud_json = <span class="hljs-built_in">JSON</span>.parse(jsonFile.read());
} <span class="hljs-keyword">else</span> {
    jsonFile.write(<span class="hljs-built_in">JSON</span>.stringify(huvud_json));
}

exports.getJson = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> huvud_json;
};

exports.setJson = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newJson</span>)</span>{
    huvud_json = newJson;
    jsonFile.write(<span class="hljs-built_in">JSON</span>.stringify(huvud_json));
};
</code></pre><p>Thanks Malcolm for trying to help :-)</p>
</p>
										<div class="author">
											&mdash; commented <span title="July 8th 2014, 9:29:20 am">July 8th 2014</span>
											by <span class='authorname'>Tove Walden</span>
										</div>
									</li>
								
								</ul>
							
						</footer>
						<aside class="vote-box">
							<div class="score"><span>0</span> Votes</div>
						</aside>
					</article>
				</li>
			
		</ul>
	
</article>

		</div>
		<div class="col-sm-3"></div>
	</div>
	<div class="row"><div class="signoff">The ownership of individual contributions to this community generated content is retained by the authors of their contributions.<br>All trademarks remain the property of the respective owner.</div></div>
</main>


</body>
</html>
